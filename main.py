# main.py
# ä¹™ï¼”ã‚¯ã‚¤ã‚ºï¼š50å• / FastAPI + LINE Bot (line-bot-sdk v2ç³»ã‚’æƒ³å®š)
# ç’°å¢ƒå¤‰æ•°: LINE_CHANNEL_ACCESS_TOKEN, LINE_CHANNEL_SECRET

import os
import random
from typing import Dict, List

from fastapi import FastAPI, Request, HTTPException
from pydantic import BaseModel

# --- LINE SDK (v2ç³») ---
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import (
    MessageEvent,
    TextMessage,
    TextSendMessage,
    QuickReply, QuickReplyButton, MessageAction
)

app = FastAPI()

CHANNEL_ACCESS_TOKEN = os.getenv("LINE_CHANNEL_ACCESS_TOKEN", "")
CHANNEL_SECRET = os.getenv("LINE_CHANNEL_SECRET", "")

if not CHANNEL_ACCESS_TOKEN or not CHANNEL_SECRET:
    print("[WARN] LINE ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™ã€‚Renderã®ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚")

line_bot_api = LineBotApi(CHANNEL_ACCESS_TOKEN)  # type: ignore
handler = WebhookHandler(CHANNEL_SECRET)         # type: ignore

# ------------------------------------------------------------
# 50å•ï¼ˆéå»å•ãƒ™ãƒ¼ã‚¹ã®è¦ç‚¹ã‚µãƒãƒªï¼ä¾‹ç¤ºï¼‰
# å½¢å¼: ans ã¯ 1ã€œ4 ã®æ•´æ•°ã€choices ã¯4æŠ
# ------------------------------------------------------------
QUESTIONS: List[Dict] = [
    {"q": "ç¬¬2çŸ³æ²¹é¡ï¼ˆæ°´æº¶æ€§ï¼‰ã®æŒ‡å®šæ•°é‡ã¯ï¼Ÿ", "choices": ["1000L", "2000L", "4000L", "6000L"], "ans": 2, "exp": "ç¬¬2çŸ³æ²¹é¡(æ°´æº¶æ€§)ã¯2,000Lã€‚"},
    {"q": "ç¬¬1çŸ³æ²¹é¡ï¼ˆéæ°´æº¶æ€§ï¼‰ã®æŒ‡å®šæ•°é‡ã¯ï¼Ÿ", "choices": ["200L", "400L", "1000L", "2000L"], "ans": 2, "exp": "ç¬¬1çŸ³æ²¹é¡(éæ°´æº¶æ€§)ã¯400Lã€‚"},
    {"q": "ç¬¬1çŸ³æ²¹é¡ï¼ˆæ°´æº¶æ€§ï¼‰ã®æŒ‡å®šæ•°é‡ã¯ï¼Ÿ", "choices": ["200L", "400L", "1000L", "2000L"], "ans": 1, "exp": "ç¬¬1çŸ³æ²¹é¡(æ°´æº¶æ€§)ã¯200Lã€‚"},
    {"q": "ç¬¬3çŸ³æ²¹é¡ï¼ˆéæ°´æº¶æ€§ï¼‰ã®æŒ‡å®šæ•°é‡ã¯ï¼Ÿ", "choices": ["1000L", "2000L", "4000L", "6000L"], "ans": 3, "exp": "ç¬¬3çŸ³æ²¹é¡(éæ°´æº¶æ€§)ã¯4,000Lã€‚"},
    {"q": "ç¬¬4çŸ³æ²¹é¡ã®æŒ‡å®šæ•°é‡ã¯ï¼Ÿ", "choices": ["1000L", "2000L", "4000L", "6000L"], "ans": 4, "exp": "ç¬¬4çŸ³æ²¹é¡ã¯6,000Lã€‚"},
    {"q": "ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é¡ï¼ˆå¼•ç«ç‚¹70â„ƒæœªæº€ï¼‰ã®æŒ‡å®šæ•°é‡ã¯ï¼Ÿ", "choices": ["1000L", "2000L", "4000L", "6000L"], "ans": 2, "exp": "ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é¡ã¯2,000Lã€‚"},
    {"q": "ç¯æ²¹ï¼ˆç¬¬2çŸ³æ²¹é¡ãƒ»éæ°´æº¶æ€§ï¼‰ã®æŒ‡å®šæ•°é‡ã¯ï¼Ÿ", "choices": ["1000L", "2000L", "4000L", "6000L"], "ans": 2, "exp": "ç¯æ²¹ã¯ç¬¬2çŸ³æ²¹é¡(éæ°´æº¶æ€§)ã§2,000Lã€‚"},
    {"q": "é‡æ²¹ï¼ˆç¬¬3çŸ³æ²¹é¡ãƒ»éæ°´æº¶æ€§ï¼‰ã®æŒ‡å®šæ•°é‡ã¯ï¼Ÿ", "choices": ["2000L", "4000L", "6000L", "8000L"], "ans": 2, "exp": "é‡æ²¹ã¯ç¬¬3çŸ³æ²¹é¡ã§4,000Lã€‚"},
    {"q": "æ½¤æ»‘æ²¹ï¼ˆç¬¬4çŸ³æ²¹é¡ï¼‰ã®æŒ‡å®šæ•°é‡ã¯ï¼Ÿ", "choices": ["2000L", "4000L", "6000L", "8000L"], "ans": 3, "exp": "æ½¤æ»‘æ²¹ã¯ç¬¬4çŸ³æ²¹é¡ã§6,000Lã€‚"},
    {"q": "ã‚¬ã‚½ãƒªãƒ³ã¯ä½•é¡ï¼Ÿ", "choices": ["ç¬¬1çŸ³æ²¹é¡", "ç¬¬2çŸ³æ²¹é¡", "ç¬¬3çŸ³æ²¹é¡", "ç¬¬4çŸ³æ²¹é¡"], "ans": 1, "exp": "ã‚¬ã‚½ãƒªãƒ³ã¯ç¬¬1çŸ³æ²¹é¡ã€‚"},
    {"q": "è»½æ²¹ã¯ä½•é¡ï¼Ÿ", "choices": ["ç¬¬1çŸ³æ²¹é¡", "ç¬¬2çŸ³æ²¹é¡", "ç¬¬3çŸ³æ²¹é¡", "ç¬¬4çŸ³æ²¹é¡"], "ans": 2, "exp": "è»½æ²¹ã¯ç¬¬2çŸ³æ²¹é¡ã€‚"},
    {"q": "é‡æ²¹ã¯ä½•é¡ï¼Ÿ", "choices": ["ç¬¬1çŸ³æ²¹é¡", "ç¬¬2çŸ³æ²¹é¡", "ç¬¬3çŸ³æ²¹é¡", "ç¬¬4çŸ³æ²¹é¡"], "ans": 3, "exp": "é‡æ²¹ã¯ç¬¬3çŸ³æ²¹é¡ã€‚"},
    {"q": "å¼•ç«ç‚¹ãŒæœ€ã‚‚ä½ã„ã®ã¯ï¼Ÿ", "choices": ["ç¬¬1çŸ³æ²¹é¡", "ç¬¬2çŸ³æ²¹é¡", "ç¬¬3çŸ³æ²¹é¡", "ç¬¬4çŸ³æ²¹é¡"], "ans": 1, "exp": "ç¬¬1çŸ³æ²¹é¡(ã‚¬ã‚½ãƒªãƒ³ç­‰)ã¯å¼•ç«ç‚¹ãŒä½ã„ã€‚"},
    {"q": "æŒ‡å®šæ•°é‡ã®å€æ•°ãŒ10ä»¥ä¸Šã¯ä½•ã«è©²å½“ï¼Ÿ", "choices": ["å°‘é‡å±é™ºç‰©", "å±é™ºç‰©æ–½è¨­", "è²¯è”µå–æ‰±æ‰€", "å±‹å†…ã‚¿ãƒ³ã‚¯è²¯è”µæ‰€"], "ans": 3, "exp": "æŒ‡å®šæ•°é‡ã®åˆè¨ˆå€æ•°ã§åŒºåˆ†ã€‚10ä»¥ä¸Šã§è²¯è”µå–æ‰±æ‰€ç­‰ã®è¨±å¯å¯¾è±¡ã€‚"},
    {"q": "å±é™ºç‰©æ¨™è­˜ã®ã€å±ã€ã®è‰²ã¯ï¼Ÿ", "choices": ["èµ¤åœ°ç™½å­—", "é»„åœ°é»’å­—", "ç™½åœ°èµ¤å­—", "é’åœ°ç™½å­—"], "ans": 1, "exp": "èµ¤åœ°ã«ç™½å­—ã€å±ã€ãŒåŸºæœ¬ã€‚"},
    {"q": "æŒ‡å®šæ•°é‡æœªæº€ã§å±Šå‡ºãŒä¸è¦ãªã‚‚ã®ã¯ï¼Ÿ", "choices": ["50Lã®ã‚¬ã‚½ãƒªãƒ³", "100Lã®ã‚¬ã‚½ãƒªãƒ³", "300Lã®ç¯æ²¹", "500Lã®é‡æ²¹"], "ans": 4, "exp": "é‡æ²¹(ç¬¬3çŸ³æ²¹é¡)ã¯4,000LãŒæŒ‡å®šæ•°é‡ã€500Lã¯æœªæº€ã€‚"},
    {"q": "é™é›»æ°—ã«ã‚ˆã‚‹ç«ç½é˜²æ­¢ã§ä¸é©åˆ‡ã¯ï¼Ÿ", "choices": ["æ¥åœ°", "å°é›»æ€§åºŠ", "åŠ æ¹¿", "ä¹¾ç‡¥ç©ºæ°—é€å…¥"], "ans": 4, "exp": "ä¹¾ç‡¥ã¯é™é›»æ°—ã‚’ãŸã‚ã‚‹æ–¹å‘ã§ä¸é©åˆ‡ã€‚"},
    {"q": "å®¹å™¨è©°æ›¿æ™‚ã«å®ˆã‚‹ã¹ãäº‹é …ã¯ï¼Ÿ", "choices": ["æ›æ°—", "é™é›»æ°—å¯¾ç­–", "ç«æ°—å³ç¦", "ã™ã¹ã¦"], "ans": 4, "exp": "æ›æ°—ãƒ»é™é›»æ°—å¯¾ç­–ãƒ»ç«æ°—å³ç¦ã™ã¹ã¦å¿…è¦ã€‚"},
    {"q": "ä¿å®‰è·é›¢ãƒ»ä¿æœ‰ç©ºåœ°ãŒé–¢ä¿‚ã™ã‚‹ã®ã¯ï¼Ÿ", "choices": ["è£½é€ æ‰€ç­‰", "ä¸€èˆ¬ä½å®…", "å€‰åº«æ¥­æ³•å€‰åº«", "äº‹å‹™æ‰€"], "ans": 1, "exp": "è£½é€ æ‰€ç­‰ã®è¨±å¯æ–½è¨­ã§è¦å®šã€‚"},
    {"q": "æ¼ãˆã„æ™‚ã«ã¾ãšè¡Œã†ã¹ãã¯ï¼Ÿ", "choices": ["ç‚¹ç«æºã®é™¤å»", "æƒãé›†ã‚", "æ°´ã§æµã™", "ãã®ã¾ã¾æ”¾ç½®"], "ans": 1, "exp": "ã¾ãšç‚¹ç«æºé™¤å»ã§äºŒæ¬¡ç½å®³é˜²æ­¢ã€‚"},
    # ã“ã“ã‹ã‚‰ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ã« 30å•åˆ†è¿½è¨˜ï¼ˆåˆè¨ˆ50å•ï¼‰
    {"q": "ç¯æ²¹ã®é¡åˆ¥ãƒ»æ€§çŠ¶ã§æ­£ã—ã„ã®ã¯ï¼Ÿ", "choices": ["ç¬¬1çŸ³æ²¹é¡", "ç¬¬2çŸ³æ²¹é¡ãƒ»éæ°´æº¶æ€§", "ç¬¬3çŸ³æ²¹é¡", "ç¬¬4çŸ³æ²¹é¡"], "ans": 2, "exp": "ç¯æ²¹ã¯ç¬¬2çŸ³æ²¹é¡ãƒ»éæ°´æº¶æ€§ã€‚"},
    {"q": "ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é¡ã¯ä¸€èˆ¬ã«æ°´æº¶æ€§ï¼Ÿ", "choices": ["ã¯ã„", "ã„ã„ãˆ", "ä¸€éƒ¨ã®ã¿", "ä¸æ˜"], "ans": 1, "exp": "ãƒ¡ã‚¿ãƒãƒ¼ãƒ«ç­‰ã¯æ°´æº¶æ€§ã€‚"},
    {"q": "ã‚¬ã‚½ãƒªãƒ³ã®è’¸æ°—ã¯ç©ºæ°—ã‚ˆã‚Šï¼Ÿ", "choices": ["è»½ã„", "é‡ã„", "åŒã˜", "çŠ¶æ³ã«ã‚ˆã‚‹"], "ans": 2, "exp": "ã‚¬ã‚½ãƒªãƒ³è’¸æ°—ã¯ç©ºæ°—ã‚ˆã‚Šé‡ãä½æ‰€ã«æ»ç•™ã€‚"},
    {"q": "è²¯è”µã‚¿ãƒ³ã‚¯ã®ã‚¢ãƒ¼ã‚¹ã¯ä½•ã®ãŸã‚ï¼Ÿ", "choices": ["è…é£Ÿé˜²æ­¢", "é™é›»æ°—å¯¾ç­–", "æ¼ãˆã„é˜²æ­¢", "ç¾è¦³"], "ans": 2, "exp": "ä¸»ç›®çš„ã¯é™é›»æ°—å¯¾ç­–ã€‚"},
    {"q": "å±é™ºç‰©ã®ã€æŒ‡å®šæ•°é‡ã€ã‚’è¶…ãˆã‚‹å–æ‰±ã„ã¯ï¼Ÿ", "choices": ["è‡ªç”±", "å±Šå‡º", "è¨±å¯ãƒ»èªå¯", "ç¨é‡‘ã®ã¿"], "ans": 3, "exp": "è¨±å¯ç­‰ãŒå¿…è¦ã€‚"},
    {"q": "å®¹å™¨ç½®å ´ã§é©åˆ‡ãªã®ã¯ï¼Ÿ", "choices": ["ç›´å°„æ—¥å…‰", "è»¢å€’é˜²æ­¢", "ãƒ‰ãƒ¬ãƒ³é–‰å¡", "ç«æ°—è¿‘æ¥"], "ans": 2, "exp": "è»¢å€’é˜²æ­¢ãƒ»é€šé¢¨ç­‰ãŒå¿…è¦ã€‚"},
    {"q": "å±é™ºç‰©ã®é¡åˆ¥ã§ã€å¼•ç«ç‚¹ã®é«˜ä½ã€ã§ä¸»ã«åŒºåˆ†ã•ã‚Œã‚‹ã®ã¯ï¼Ÿ", "choices": ["ç¬¬1ã€œ4çŸ³æ²¹é¡", "ç¬¬5é¡", "ç¬¬6é¡", "ã™ã¹ã¦"], "ans": 1, "exp": "çŸ³æ²¹é¡ã¯å¼•ç«ç‚¹ã§åŒºåˆ†ã€‚"},
    {"q": "ç«ç½æ™‚ã«æ°´ã§æ¶ˆç«ãŒä¸é©åˆ‡ã«ãªã‚Šã‚„ã™ã„ã®ã¯ï¼Ÿ", "choices": ["æ¥µæ€§æº¶å‰¤ç«ç½", "æ²¹ç«ç½", "é›»æ°—ç«ç½", "ã„ãšã‚Œã‚‚ä¸é©åˆ‡"], "ans": 2, "exp": "æ²¹ç«ç½ã¯æ³¡æ¶ˆç«ãªã©ãŒåŸºæœ¬ã€‚"},
    {"q": "æ¶ˆç«å™¨ã®è¨­ç½®ã§é©åˆ‡ãªã®ã¯ï¼Ÿ", "choices": ["ç‰©é™°ã«éš ã™", "è¦‹ã‚„ã™ãå–ã‚Šå‡ºã—ã‚„ã™ã", "éµä»˜ãåç´", "é«˜æ‰€åŠä¸‹ã’"], "ans": 2, "exp": "è¦‹ã‚„ã™ãå–ã‚Šå‡ºã—ã‚„ã™ã„ä½ç½®ã«ã€‚"},
    {"q": "ãƒ©ãƒ™ãƒ«è¡¨ç¤ºã§å¿…è¦ãªã®ã¯ï¼Ÿ", "choices": ["å“å", "é¡åˆ¥ãƒ»æ•°é‡", "æ³¨æ„äº‹é …", "ã™ã¹ã¦"], "ans": 4, "exp": "è­˜åˆ¥ã§ãã‚‹è¡¨ç¤ºãŒå¿…è¦ã€‚"},
    {"q": "æŒ‡å®šæ•°é‡ã®åˆç®—ã¯ï¼Ÿ", "choices": ["åŒé¡ã®ã¿åˆç®—", "ç•°é¡ã¯åˆç®—ä¸å¯", "ã™ã¹ã¦åˆç®—ï¼ˆä¿‚æ•°ã‚ã‚Šï¼‰", "ä»»æ„"], "ans": 3, "exp": "å±é™ºç‰©ã”ã¨ã«ä¿‚æ•°ã‚’ç”¨ã„ã¦åˆç®—ã€‚"},
    {"q": "ã‚¢ã‚»ãƒˆãƒ³ã¯ä½•ã«åˆ†é¡ï¼Ÿ", "choices": ["ç¬¬1çŸ³æ²¹é¡", "ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é¡", "ç¬¬2çŸ³æ²¹é¡", "ç‰¹æ®Šå¼•ç«ç‰©"], "ans": 2, "exp": "ã‚¢ã‚»ãƒˆãƒ³ã¯ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é¡ã«æº–ãšã‚‹æ‰±ã„ã€‚"},
    {"q": "ãƒ¡ã‚¿ãƒãƒ¼ãƒ«ã¯ï¼Ÿ", "choices": ["ç¬¬1çŸ³æ²¹é¡", "ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é¡", "ç¬¬2çŸ³æ²¹é¡", "ç¬¬3çŸ³æ²¹é¡"], "ans": 2, "exp": "ãƒ¡ã‚¿ãƒãƒ¼ãƒ«ã¯ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é¡ã€‚"},
    {"q": "æŒ‡å®šæ•°é‡ã«é”ã—ãªã„å°‘é‡å±é™ºç‰©ã®ä¿ç®¡ã§ä¸è¦ãªã®ã¯ï¼Ÿ", "choices": ["æ›æ°—", "åŒºç”»", "å¸³ç°¿", "ç«æ°—å³ç¦"], "ans": 3, "exp": "å¸³ç°¿ã¾ã§ã¯åŸå‰‡ä¸è¦ï¼ˆè‡ªæ²»ä½“æŒ‡å°ã¯åˆ¥ï¼‰ã€‚"},
    {"q": "è²¯è”µå ´ã®é€šè·¯å¹…ã¯ï¼Ÿ", "choices": ["ç‹­ã„ã»ã©è‰¯ã„", "ä¸€å®šã®å¹…ã‚’ç¢ºä¿", "ä¸è¦", "è·ã§å¡ã„ã§ã‚ˆã„"], "ans": 2, "exp": "é¿é›£ãƒ»æ¬å‡ºã®ãŸã‚é€šè·¯ç¢ºä¿ã€‚"},
    {"q": "æ³¡æ¶ˆç«è–¬å‰¤ãŒæœ‰åŠ¹ãªã®ã¯ï¼Ÿ", "choices": ["æ²¹ç«ç½", "é›»æ°—ç«ç½", "é‡‘å±ç«ç½", "ã‚¬ã‚¹ç«ç½"], "ans": 1, "exp": "æ²¹è¡¨é¢ã‚’è¦†ã†æ³¡ãŒæœ‰åŠ¹ã€‚"},
    {"q": "é‡‘å±ç«ç½ã«é©ã—ãŸæ¶ˆç«å™¨ã¯ï¼Ÿ", "choices": ["æ°´ç³»", "ç²‰æœ«ç‰¹æ®Š", "äºŒé…¸åŒ–ç‚­ç´ ", "æ³¡"], "ans": 2, "exp": "é‡‘å±ç«ç½ã¯ç‰¹æ®Šç²‰æœ«ã€‚"},
    {"q": "äºŒé…¸åŒ–ç‚­ç´ æ¶ˆç«å™¨ã®æ³¨æ„ç‚¹ã¯ï¼Ÿ", "choices": ["é–‰é–ç©ºé–“ã§çª’æ¯", "è…é£Ÿæ€§å¼·ã„", "æ³¡ãŒå‡ºã‚‹", "å°é›»æ€§ã‚ã‚Š"], "ans": 1, "exp": "CO2ã¯çª’æ¯å±é™ºã‚ã‚Šã€‚"},
    {"q": "å±é™ºç‰©ã‚’é‹æ¬ã™ã‚‹ã¨ãå¿…è¦ãªã‚‚ã®ã¯ï¼Ÿ", "choices": ["é‹æ¬å®¹å™¨ã®è¡¨ç¤º", "ç©è¼‰ã®å›ºå®š", "ç¦ç…™ãƒ»ç«æ°—å³ç¦", "ã™ã¹ã¦"], "ans": 4, "exp": "åŸºæœ¬ã™ã¹ã¦å¿…è¦ã€‚"},
    {"q": "ä¿å®‰è¬›ç¿’ã®ç›®çš„ã¯ï¼Ÿ", "choices": ["æŠ€èƒ½å‘ä¸Š", "æœ€æ–°æ³•ä»¤ç†è§£", "äº‹æ•…é˜²æ­¢", "ã™ã¹ã¦"], "ans": 4, "exp": "äº‹æ•…é˜²æ­¢ã®ãŸã‚ç·åˆçš„ã«å­¦ã¶ã€‚"},
    {"q": "æ»ç•™è’¸æ°—ã‚’é¿ã‘ã‚‹è¨­è¨ˆã¯ï¼Ÿ", "choices": ["ä½æ‰€ã«æº", "æ›æ°—", "ã™ã¹ã¦", "ä¸è¦"], "ans": 3, "exp": "æ›æ°—ã‚„å½¢çŠ¶ã§æ»ç•™é˜²æ­¢ã€‚"},
    {"q": "å±é™ºç‰©æ–½è¨­ã®ç‚¹æ¤œè¨˜éŒ²ã¯ï¼Ÿ", "choices": ["ä¸è¦", "ç°¡æ˜“ã§ã‚ˆã„", "ä¿å­˜ã™ã‚‹", "å£é ­ã§OK"], "ans": 3, "exp": "ç‚¹æ¤œçµæœã¯ä¿å­˜ã€‚"},
    {"q": "é™é›»æ°—å¯¾ç­–ã®ä¸€ã¤ã§ãªã„ã®ã¯ï¼Ÿ", "choices": ["æ¥åœ°", "æ¹¿åº¦ç®¡ç†", "çµ¶ç¸é´ã®ã¿", "å°é›»æ€§åºŠ"], "ans": 3, "exp": "çµ¶ç¸é´ã ã‘ã§ã¯ä¸ååˆ†ã€‚"},
    {"q": "æŒ‡å®šæ•°é‡å€æ•°ãŒ1æœªæº€ã®æ–½è¨­ã¯ï¼Ÿ", "choices": ["è£½é€ æ‰€ç­‰", "å°‘é‡å±é™ºç‰©å–æ‰±æ‰€", "å±‹å¤–è²¯è”µæ‰€", "ã‚¿ãƒ³ã‚¯è²¯è”µæ‰€"], "ans": 2, "exp": "å°‘é‡å±é™ºç‰©ã®ç¯„å›²ã€‚"},
    {"q": "ãƒ‰ãƒ©ãƒ ç¼¶é–‹æ “æ™‚ã®æ³¨æ„ã¯ï¼Ÿ", "choices": ["ç«æ°—å³ç¦", "é™é›»æ°—å¯¾ç­–", "ä¿è­·å…·", "ã™ã¹ã¦"], "ans": 4, "exp": "åŸºæœ¬ã™ã¹ã¦å¿…é ˆã€‚"},
    {"q": "å±é™ºç‰©ã®ã€é¡ã€ã¯ä½•ç¨®é¡ï¼Ÿ", "choices": ["4é¡ã®ã¿", "3é¡ã¨4é¡", "1ã€œ6é¡", "1ã€œ5é¡"], "ans": 3, "exp": "1ã€œ6é¡ã€‚"},
    {"q": "ç¬¬4é¡å±é™ºç‰©ã¨ã¯ï¼Ÿ", "choices": ["å¼•ç«æ€§æ¶²ä½“", "é…¸åŒ–æ€§å›ºä½“", "è‡ªç„¶ç™ºç«æ€§ç‰©è³ª", "é…¸é¡"], "ans": 1, "exp": "ç¬¬4é¡=å¼•ç«æ€§æ¶²ä½“ã€‚"},
    {"q": "å¼•ç«ç‚¹ã¨ã¯ï¼Ÿ", "choices": ["ç«ã‚’è¿‘ã¥ã‘ã‚‹ã¨ç‡ƒãˆã‚‹æœ€ä½æ¸©åº¦", "æ²¸ç‚¹", "ç™ºç«ç‚¹", "è’¸æ°—åœ§"], "ans": 1, "exp": "å¯ç‡ƒæ€§è’¸æ°—ãŒç™ºç”Ÿã—ç€ç«ã™ã‚‹æœ€ä½æ¸©åº¦ã€‚"},
    {"q": "ç™ºç«ç‚¹ã¨ã¯ï¼Ÿ", "choices": ["è‡ªç„¶ç™ºç«ã™ã‚‹æ¸©åº¦", "å¼•ç«ç‚¹ã‚ˆã‚Šä½ã„", "æ°´ã®æ²¸ç‚¹", "å‡å›ºç‚¹"], "ans": 1, "exp": "å¤–éƒ¨ç«æºç„¡ã—ã§è‡ªç„¶ç™ºç«ã€‚"},
    {"q": "æ°´æº¶æ€§æº¶å‰¤ã§æ³¨æ„ã™ã‚‹æ¶ˆç«å‰¤ã¯ï¼Ÿ", "choices": ["é€šå¸¸æ³¡", "è€ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ³¡", "æ°´ã®ã¿", "ç²‰æœ«ã®ã¿"], "ans": 2, "exp": "æ¥µæ€§æº¶å‰¤ã«ã¯è€ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ³¡ã€‚"},
    {"q": "ã‚¿ãƒ³ã‚¯ã‚²ãƒ¼ã‚¸ã®ç›®çš„ã¯ï¼Ÿ", "choices": ["æ¸©åº¦æ¸¬å®š", "æ¿ƒåº¦æ¸¬å®š", "æ¶²é¢ç®¡ç†", "åœ§åŠ›æ¸¬å®š"], "ans": 3, "exp": "æ¶²é¢(é‡)ã®ç®¡ç†ã«ä½¿ç”¨ã€‚"},
    {"q": "ç«èŠ±ãŒå‡ºã‚‹å·¥å…·ã®ä½¿ç”¨ã¯ï¼Ÿ", "choices": ["ã©ã“ã§ã‚‚OK", "å±é™ºç‰©å‘¨è¾ºã¯é¿ã‘ã‚‹", "æ°´æ¿¡ã‚Œãªã‚‰OK", "å±‹å¤–ãªã‚‰OK"], "ans": 2, "exp": "ç‚¹ç«æºã¨ãªã‚‹ãŸã‚é¿ã‘ã‚‹ã€‚"},
    {"q": "å®¹å™¨ã®ãƒ©ãƒ™ãƒ«ãŒå‰¥ãŒã‚ŒãŸå ´åˆã¯ï¼Ÿ", "choices": ["ãã®ã¾ã¾ä½¿ç”¨", "ä¸­èº«ã§åˆ¤æ–­", "é€Ÿã‚„ã‹ã«å†è¡¨ç¤º", "å»ƒæ£„"], "ans": 3, "exp": "è­˜åˆ¥ã§ãã‚‹è¡¨ç¤ºã‚’ç¶­æŒã€‚"},
    {"q": "æº¶åª’ã®å¸Œé‡ˆã§ç™ºç†±ãŒå¤§ãã„ã®ã¯ï¼Ÿ", "choices": ["æ°´â†’æ¿ƒç¡«é…¸", "æ¿ƒç¡«é…¸â†’æ°´", "ã©ã¡ã‚‰ã‚‚åŒã˜", "ç™ºç†±ã—ãªã„"], "ans": 2, "exp": "æ¿ƒç¡«é…¸ã«æ°´ã¯å±é™ºã€‚æ°´ã«é…¸ã‚’åŠ ãˆã‚‹ã€‚"},
    {"q": "ç«ç½å ±çŸ¥ã®é€£çµ¡æ‰‹æ®µã§é©åˆ‡ã¯ï¼Ÿ", "choices": ["ç¤¾å†…ã ã‘", "æ¶ˆé˜²ã¸é€šå ±", "ãƒ¡ãƒ¢ã ã‘", "æ”¾é€ä¸è¦"], "ans": 2, "exp": "æ¶ˆé˜²é€šå ±ã¯åŸºæœ¬ã€‚"},
    {"q": "é¿é›£çµŒè·¯ã®æ²ç¤ºã¯ï¼Ÿ", "choices": ["ä»»æ„", "å¿…é ˆ", "ç‚¹æ¤œæ™‚ã®ã¿", "å¤œé–“ã®ã¿"], "ans": 2, "exp": "é¿é›£è¡¨ç¤ºã¯é‡è¦ã€‚"},
    {"q": "æ¼ãˆã„ã—ãŸæ²¹ã®å‡¦ç†æã¯ï¼Ÿ", "choices": ["ç ‚ãƒ»ã‚ªã‚¤ãƒ«ãƒ•ã‚£ãƒ«ã‚¿", "ç´™", "æ°´", "å¸ƒã®ã¿"], "ans": 1, "exp": "å¸ç€æã§å›åã€‚"},
    {"q": "æŒ‡å®šæ•°é‡ã®è§£é‡ˆã§èª¤ã‚Šã¯ï¼Ÿ", "choices": ["å€æ•°åˆç®—ã™ã‚‹", "ä¸€ç¨®é¡ã ã‘åˆç®—", "ä¿‚æ•°ã§åˆç®—", "ç·é‡ã§åˆ¤å®š"], "ans": 2, "exp": "ç•°ç¨®é¡ã‚‚ä¿‚æ•°ã§åˆç®—ã€‚"},
    {"q": "æ–½è¨­ã®å¸³ç°¿ã§å¿…è¦ãªã®ã¯ï¼Ÿ", "choices": ["å…¥å‡ºåº«é‡", "æ—¥ä»˜", "æ‹…å½“è€…", "ã™ã¹ã¦"], "ans": 4, "exp": "ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ç¢ºä¿ã€‚"},
]

TOTAL = len(QUESTIONS)  # 50

# ------------------------------------------------------------
# ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆè¶…ç°¡æ˜“ï¼šãƒ¡ãƒ¢ãƒªä¿æŒï¼‰
# ------------------------------------------------------------
class Session:
    def __init__(self):
        order = list(range(TOTAL))
        random.shuffle(order)
        self.order = order
        self.i = 0                 # 0-based index in order
        self.correct = 0
        self.answered = 0
        self.history = []          # [{idx, ok, select}]
        self.finished = False

SESS: Dict[str, Session] = {}  # user_id -> Session

# ------------------------------------------------------------
# ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
# ------------------------------------------------------------
def ensure_session(uid: str) -> Session:
    if uid not in SESS:
        SESS[uid] = Session()
    return SESS[uid]

def reset_session(uid: str) -> Session:
    SESS[uid] = Session()
    return SESS[uid]

def current_question(sess: Session) -> Dict:
    return QUESTIONS[sess.order[sess.i]]

def build_answer_quickreply() -> QuickReply:
    # ã€Œæ¬¡ã®å•é¡Œã€ã€Œæˆç¸¾ç¢ºèªã€ã¯å…¥ã‚Œãªã„ï¼ˆãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼æ“ä½œæƒ³å®šï¼‰
    return QuickReply(items=[
        QuickReplyButton(action=MessageAction(label="â‘ ", text="1")),
        QuickReplyButton(action=MessageAction(label="â‘¡", text="2")),
        QuickReplyButton(action=MessageAction(label="â‘¢", text="3")),
        QuickReplyButton(action=MessageAction(label="â‘£", text="4")),
        QuickReplyButton(action=MessageAction(label="ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹", text="ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹")),
        QuickReplyButton(action=MessageAction(label="ãƒªã‚»ãƒƒãƒˆ", text="ãƒªã‚»ãƒƒãƒˆ")),
        QuickReplyButton(action=MessageAction(label="ãƒ˜ãƒ«ãƒ—", text="ãƒ˜ãƒ«ãƒ—")),
    ])

def format_question(sess: Session) -> str:
    idx = sess.i
    q = current_question(sess)
    n = idx + 1
    lines = [
        f"Q{n}/{TOTAL}: {q['q']}",
        f"â‘  {q['choices'][0]}",
        f"â‘¡ {q['choices'][1]}",
        f"â‘¢ {q['choices'][2]}",
        f"â‘£ {q['choices'][3]}",
    ]
    return "\n".join(lines)

def summarize(sess: Session, label: str) -> str:
    rate = (sess.correct / sess.answered * 100) if sess.answered else 0.0
    return f"{label}\nç´¯ç©æˆç¸¾ï¼š{sess.answered}/{TOTAL}å• æ­£è§£ {sess.correct}ï¼ˆ{rate:.1f}%ï¼‰"

def feedback_text(q: Dict, select: int, ok: bool) -> str:
    mark = "â­• æ­£è§£ï¼" if ok else "âŒ ä¸æ­£è§£â€¦"
    correct_label = f"{q['ans']}ï¼š{q['choices'][q['ans']-1]}"
    return f"{mark}\næ­£è§£ã¯ {correct_label}\nï¼ˆè£œè¶³ï¼‰{q['exp']}"

def is_choice_text(t: str) -> int:
    t = t.strip()
    mapping = {
        "1": 1, "ï¼‘": 1, "â‘ ": 1,
        "2": 2, "ï¼’": 2, "â‘¡": 2,
        "3": 3, "ï¼“": 3, "â‘¢": 3,
        "4": 4, "ï¼”": 4, "â‘£": 4,
    }
    return mapping.get(t, 0)

HELP_TEXT = (
    "ä½¿ã„æ–¹ï¼š\n"
    "ãƒ»ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€æ¬¡ã®å•é¡Œã€ã§å‡ºé¡Œ\n"
    "ãƒ»å›ç­”ã¯ â‘ ã€œâ‘£ ã®ã©ã‚Œã‹ã‚’ã‚¿ãƒƒãƒ—\n"
    "ãƒ»ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€ã§ç´¯è¨ˆç¢ºèªï¼ã€ãƒªã‚»ãƒƒãƒˆã€ã§ã‚„ã‚Šç›´ã—\n"
    "â€»ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ—ãƒ©ã‚¤ã«ã¯ â‘ â‘¡â‘¢â‘£ï¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ãƒªã‚»ãƒƒãƒˆï¼ãƒ˜ãƒ«ãƒ— ã®ã¿è¡¨ç¤º\n"
    "ï¼ˆãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§ã€æ¬¡ã®å•é¡Œã€ã€æˆç¸¾ç¢ºèªã€ã‚’ä½¿ã£ã¦ãã ã•ã„ï¼‰"
)

# ------------------------------------------------------------
# ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
# ------------------------------------------------------------
@app.get("/")
def root():
    return {"status": "ok", "message": "LINE Quiz Bot running."}

@app.get("/health")
def health():
    return {"status": "ok"}

class CallbackBody(BaseModel):
    events: list = []

@app.post("/callback")
async def callback(request: Request):
    signature = request.headers.get('X-Line-Signature', '')
    body = await request.body()
    body_text = body.decode("utf-8")
    try:
        handler.handle(body_text, signature)
    except InvalidSignatureError:
        raise HTTPException(status_code=400, detail="Invalid signature")
    return "OK"

# ------------------------------------------------------------
# LINE ã‚¤ãƒ™ãƒ³ãƒˆ
# ------------------------------------------------------------
@handler.add(MessageEvent, message=TextMessage)
def handle_message(event: MessageEvent):
    uid = event.source.user_id
    text = (event.message.text or "").strip()

    # èµ·å‹•ãƒ¯ãƒ¼ãƒ‰
    if text in ["ã‚¹ã‚¿ãƒ¼ãƒˆ", "é–‹å§‹", "ã‚¯ã‚¤ã‚º", "ã‚¯ã‚¤ã‚ºé–‹å§‹"]:
        sess = reset_session(uid)
        msg = "ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚50å•ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œã—ã¾ã™ã€‚\n" \
              "ã¾ãšã¯ã€æ¬¡ã®å•é¡Œã€ï¼ˆãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚"
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=msg))
        return

    # ãƒªã‚»ãƒƒãƒˆ
    if text == "ãƒªã‚»ãƒƒãƒˆ":
        reset_session(uid)
        line_bot_api.reply_message(
            event.reply_token,
            TextSendMessage(text="ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚\nã€æ¬¡ã®å•é¡Œã€ã§å†é–‹ã§ãã¾ã™ã€‚")
        )
        return

    # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆæˆç¸¾ç¢ºèªï¼‰
    if text in ["ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹", "æˆç¸¾", "æˆç¸¾ç¢ºèª"]:
        sess = ensure_session(uid)
        line_bot_api.reply_message(
            event.reply_token,
            TextSendMessage(text=summarize(sess, "ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹"), quick_reply=build_answer_quickreply())
        )
        return

    # ãƒ˜ãƒ«ãƒ—
    if text in ["ãƒ˜ãƒ«ãƒ—", "help", "ä½¿ã„æ–¹"]:
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=HELP_TEXT))
        return

    # ã€Œæ¬¡ã®å•é¡Œã€ã¯ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰æ¥ã‚‹æƒ³å®šã ãŒã€ãƒ†ã‚­ã‚¹ãƒˆã«ã‚‚å¯¾å¿œ
    if text in ["æ¬¡ã®å•é¡Œ", "æ¬¡", "next"]:
        sess = ensure_session(uid)
        if sess.finished:
            line_bot_api.reply_message(
                event.reply_token, TextSendMessage(text="å…¨50å•çµ‚äº†æ¸ˆã¿ã§ã™ã€‚ã€ãƒªã‚»ãƒƒãƒˆã€ã§å†æŒ‘æˆ¦ã§ãã¾ã™ã€‚")
            )
            return
        # æœªå›ç­”ã®ã¾ã¾é€²ã‚ã‚‹ã®ã‚’é˜²æ­¢ï¼ˆä»»æ„ï¼‰
        qtxt = format_question(sess)
        line_bot_api.reply_message(
            event.reply_token,
            TextSendMessage(text=qtxt, quick_reply=build_answer_quickreply())
        )
        return

    # å›ç­”ï¼ˆâ‘ ã€œâ‘£ï¼‰
    sel = is_choice_text(text)
    if sel:
        sess = ensure_session(uid)
        if sess.finished:
            line_bot_api.reply_message(
                event.reply_token, TextSendMessage(text="å…¨50å•çµ‚äº†ã§ã™ã€‚ã€ãƒªã‚»ãƒƒãƒˆã€ã§å†æŒ‘æˆ¦ã§ãã¾ã™ã€‚")
            )
            return

        q = current_question(sess)
        ok = (sel == q["ans"])
        sess.answered += 1
        if ok:
            sess.correct += 1
        sess.history.append({"idx": sess.order[sess.i], "ok": ok, "select": sel})

        fb = feedback_text(q, sel, ok)

        # 25å•ï¼50å•ã§ç·æ‹¬
        extra = ""
        if sess.answered == 25:
            extra = "\n\n" + summarize(sess, "ğŸ“Š ã“ã“ã¾ã§ã®ç·æ‹¬ï¼ˆ25å•ï¼‰")
        elif sess.answered == 50:
            extra = "\n\n" + summarize(sess, "ğŸ æœ€çµ‚ç·æ‹¬ï¼ˆ50å•ï¼‰")
            sess.finished = True

        # æ¬¡ã®å•é¡Œã¸é€²ã‚ã‚‹ï¼ˆæœ€çµ‚ä»¥å¤–ï¼‰
        if not sess.finished and sess.i < TOTAL - 1:
            sess.i += 1

        reply = fb + extra
        line_bot_api.reply_message(
            event.reply_token,
            TextSendMessage(text=reply, quick_reply=build_answer_quickreply())
        )
        return

    # ãã‚Œä»¥å¤–ï¼šç¾åœ¨ã®å•é¡Œã‚’æç¤ºï¼ˆã¾ãŸã¯é–‹å§‹æ¡ˆå†…ï¼‰
    sess = ensure_session(uid)
    if sess.answered == 0 and sess.i == 0:
        tip = "ã€æ¬¡ã®å•é¡Œã€ï¼ˆãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰ã‚’æŠ¼ã—ã¦é–‹å§‹ã—ã¦ãã ã•ã„ã€‚"
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=tip))
    else:
        if not sess.finished:
            qtxt = format_question(sess)
            line_bot_api.reply_message(
                event.reply_token,
                TextSendMessage(text=qtxt, quick_reply=build_answer_quickreply())
            )
        else:
            line_bot_api.reply_message(
                event.reply_token,
                TextSendMessage(text="å…¨50å•çµ‚äº†ã—ã¾ã—ãŸã€‚ã€ãƒªã‚»ãƒƒãƒˆã€ã§å†æŒ‘æˆ¦ã§ãã¾ã™ã€‚")
            )

# ------------------------------------------------------------
# ãƒ­ãƒ¼ã‚«ãƒ«å‹•ä½œç”¨ï¼ˆRenderã§ã¯æœªä½¿ç”¨ï¼‰
# ------------------------------------------------------------
if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=int(os.getenv("PORT", "8000")))
