import os
import random
from flask import Flask, request, abort, jsonify

from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import (
    MessageEvent, TextMessage, TextSendMessage,
    QuickReply, QuickReplyButton, MessageAction
)

# ====== ç’°å¢ƒå¤‰æ•°ï¼ˆRender/Heroku ã®ç’°å¢ƒå¤‰æ•°ã«è¨­å®šï¼‰======
CHANNEL_SECRET = os.environ.get("LINE_CHANNEL_SECRET", "")
CHANNEL_TOKEN  = os.environ.get("LINE_CHANNEL_ACCESS_TOKEN", "")
if not CHANNEL_SECRET or not CHANNEL_TOKEN:
    raise RuntimeError("ç’°å¢ƒå¤‰æ•° LINE_CHANNEL_SECRET / LINE_CHANNEL_ACCESS_TOKEN ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚")

line_bot_api = LineBotApi(CHANNEL_TOKEN)
handler      = WebhookHandler(CHANNEL_SECRET)

# ====== Flask ======
app = Flask(__name__)

# /health ç›£è¦–ç”¨
@app.get("/health")
def health():
    return jsonify({"status": "ok"})

# ====== ãƒ˜ãƒ«ãƒ—æœ¬æ–‡ ======
HELP_TEXT = (
    "ğŸ“˜ ä½¿ã„æ–¹\n"
    "ãƒ»ã€Œé–‹å§‹ã€ã€Œå•é¡Œã€ã€Œã‚¯ã‚¤ã‚ºã€ã§å‡ºé¡Œã‚¹ã‚¿ãƒ¼ãƒˆ\n"
    "ãƒ»4æŠã¯ä¸‹ã®ã€Šâ‘ â‘¡â‘¢â‘£ã€‹ãƒœã‚¿ãƒ³ã§å›ç­”\n"
    "ãƒ»ã€Œæ¬¡ã®å•é¡Œã€ã§ã‚‚ã†1å•\n"
    "ãƒ»ã€Œæˆç¸¾ç¢ºèªã€ã§ç¾åœ¨ã®æ­£ç­”ç‡\n"
    "ãƒ»ã€Œãƒªã‚»ãƒƒãƒˆã€ã§æˆç¸¾ã¨å‡ºé¡Œå±¥æ­´ã‚’åˆæœŸåŒ–\n"
    "ï¼ˆâ€»å­¦ç¿’ç”¨ã®ç°¡æ˜“ãƒœãƒƒãƒˆã§ã™ã€‚éå»å•50å•ã‚’ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œã€‚"
    "ã®ã¡ã»ã©è¨€ã„å›ã—ã‚„åˆ†é‡ãƒãƒ©ãƒ³ã‚¹ï¼ˆæ³•ä»¤/ç‰©åŒ–/æ€§æ¶ˆï¼‰ã‚‚èª¿æ•´äºˆå®šï¼‰"
)

# ====== ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã‚¹ãƒ†ãƒ¼ãƒˆï¼ˆãƒ¡ãƒ¢ãƒªä¿æŒï¼‰======
# â€»ã‚µãƒ¼ãƒå†èµ·å‹•ã§ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚å¿…è¦ãªã‚‰DBåŒ–ã—ã¦ãã ã•ã„ã€‚
STATE = {}  # uid -> {"answered":int,"correct":int,"asked_ids":set(),"last_q_id":int}

# ====== ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ—ãƒ©ã‚¤ ======
def qr_answer_buttons():
    return QuickReply(items=[
        QuickReplyButton(action=MessageAction(label="â‘ ", text="1")),
        QuickReplyButton(action=MessageAction(label="â‘¡", text="2")),
        QuickReplyButton(action=MessageAction(label="â‘¢", text="3")),
        QuickReplyButton(action=MessageAction(label="â‘£", text="4")),
    ])

def qr_reset_help():
    return QuickReply(items=[
        QuickReplyButton(action=MessageAction(label="ğŸ”„ ãƒªã‚»ãƒƒãƒˆ", text="ãƒªã‚»ãƒƒãƒˆ")),
        QuickReplyButton(action=MessageAction(label="â“ ãƒ˜ãƒ«ãƒ—", text="ãƒ˜ãƒ«ãƒ—")),
    ])

def qr_next_or_menu():
    return QuickReply(items=[
        QuickReplyButton(action=MessageAction(label="â–¶ æ¬¡ã®å•é¡Œ", text="æ¬¡ã®å•é¡Œ")),
        QuickReplyButton(action=MessageAction(label="ğŸ“Š æˆç¸¾ç¢ºèª", text="æˆç¸¾ç¢ºèª")),
        QuickReplyButton(action=MessageAction(label="ğŸ”„ ãƒªã‚»ãƒƒãƒˆ", text="ãƒªã‚»ãƒƒãƒˆ")),
        QuickReplyButton(action=MessageAction(label="â“ ãƒ˜ãƒ«ãƒ—", text="ãƒ˜ãƒ«ãƒ—")),
    ])

# ====== å•é¡Œãƒ‡ãƒ¼ã‚¿ï¼ˆ50å•ï¼‰======
# ãƒ»ans ã¯ 1ã€œ4
# ãƒ»exp ã¯ç°¡æ½”ãªè£œè¶³ï¼ˆèª¿æ•´OKï¼‰
QUESTIONS = [
    # --- æ³•ä»¤ç³» ---
    {"id": 1, "q": "ç¬¬1çŸ³æ²¹é¡ã®æŒ‡å®šæ•°é‡ã¯ï¼Ÿ", "choices": ["100L", "200L", "400L", "1000L"], "ans":1, "exp":"ç¬¬1çŸ³æ²¹é¡ï¼ˆéæ°´æº¶æ€§/æ°´æº¶æ€§ï¼‰ã¯ 100L"},
    {"id": 2, "q": "ç¬¬2çŸ³æ²¹é¡ï¼ˆæ°´æº¶æ€§ï¼‰ã®æŒ‡å®šæ•°é‡ã¯ï¼Ÿ", "choices": ["1000L", "2000L", "4000L", "6000L"], "ans":2, "exp":"ç¬¬2çŸ³æ²¹é¡ï¼ˆæ°´æº¶æ€§ï¼‰ã¯ 2000L"},
    {"id": 3, "q": "æŒ‡å®šæ•°é‡ä»¥ä¸Šã®è²¯è”µãƒ»å–æ‰±ã„ã«ã¯åŸå‰‡ã©ã®è¨±å¯ãŒå¿…è¦ï¼Ÿ", "choices": ["å±Šå‡ºä¸è¦", "æ¶ˆé˜²æ³•ã®è¨±å¯ç­‰", "æ‰€è½„è­¦å¯Ÿã®ã¿", "åšåŠ´çœã®ã¿"], "ans":2, "exp":"æ¶ˆé˜²æ©Ÿé–¢ã®è¨±å¯ç­‰ãŒå¿…è¦"},
    {"id": 4, "q": "å±é™ºç‰©å–æ‰±è€…ä¹™4ã®å–æ‰±å¯¾è±¡ã¯ï¼Ÿ", "choices": ["ç¬¬1é¡", "ç¬¬2é¡", "ç¬¬3é¡", "ç¬¬4é¡"], "ans":4, "exp":"ä¹™4ã¯ç¬¬4é¡ï¼ˆå¼•ç«æ€§æ¶²ä½“ï¼‰"},
    {"id": 5, "q": "æŒ‡å®šæ•°é‡ã®å€æ•°ãŒ10ä»¥ä¸Šã®å ´æ‰€ã®æ¨™è­˜ã¯ï¼Ÿ", "choices": ["é»„åœ°é»’æ ", "ç™½åœ°èµ¤æ ", "èµ¤åœ°ç™½å­—", "é»’åœ°é»„å­—"], "ans":2, "exp":"å±é™ºç‰©ã®æ¨™è­˜ã¯ç™½åœ°ã«èµ¤æ èµ¤å­—"},
    {"id": 6, "q": "æŒ‡å®šæ•°é‡æœªæº€ã§ã‚‚å¿…è¦ãªã‚‚ã®ã¯ï¼Ÿ", "choices": ["è¨±å¯", "å±‹å†…è²¯è”µæ‰€è¨­ç½®ç¾©å‹™", "å°‘é‡å±é™ºç‰©ã®åŸºæº–éµå®ˆ", "ç½°å‰‡ãªã—"], "ans":3, "exp":"å°‘é‡å±é™ºç‰©ã®æŠ€è¡“ä¸ŠåŸºæº–ã‚ã‚Š"},
    {"id": 7, "q": "ç¯æ²¹ï¼ˆç¬¬4é¡ç¬¬2çŸ³æ²¹é¡ï¼‰ã®æŒ‡å®šæ•°é‡ã¯ï¼Ÿ", "choices": ["100L", "200L", "1000L", "2000L"], "ans":4, "exp":"ç¬¬2çŸ³æ²¹é¡ï¼ˆéæ°´æº¶æ€§ï¼‰2000L"},
    {"id": 8, "q": "å±é™ºç‰©æ–½è¨­ã®ä¿å®‰ç›£ç£è€…ãŒè¡Œã†ã‚‚ã®ã¯ï¼Ÿ", "choices": ["è¨­å‚™ã®ç‚¹æ¤œ", "é€šè²¨æ›ç®—", "åŠ´åŸºç½²ç”³è«‹", "ç›£æŸ»å½¹é¸ä»»"], "ans":1, "exp":"ä¿å®‰æ¥­å‹™ã®ä¸­å¿ƒ"},
    {"id": 9, "q": "å¼•ç«ç‚¹ãŒæœ€ã‚‚ä½ã„ã®ã¯ï¼Ÿ", "choices": ["ã‚¬ã‚½ãƒªãƒ³", "è»½æ²¹", "ç¯æ²¹", "Aé‡æ²¹"], "ans":1, "exp":"ã‚¬ã‚½ãƒªãƒ³ã¯-40â„ƒå‰å¾Œã§éå¸¸ã«ä½ã„"},
    {"id":10, "q": "å±é™ºç‰©ã®é¡åˆ¥ã§ã€è‡ªå·±åå¿œæ€§ã€ã¯ï¼Ÿ", "choices": ["ç¬¬1é¡", "ç¬¬3é¡", "ç¬¬5é¡", "ç¬¬6é¡"], "ans":3, "exp":"ç¬¬5é¡ï¼šè‡ªå·±åå¿œæ€§ç‰©è³ª"},
    # --- ç‰©ç†åŒ–å­¦ ---
    {"id":11, "q": "å¯ç‡ƒæ€§è’¸æ°—ãŒç©ºæ°—ã¨æ··åˆã—ç‡ƒç„¼ã—å¾—ã‚‹æ¿ƒåº¦ç¯„å›²ã‚’ä½•ã¨ã„ã†ï¼Ÿ", "choices": ["ç™ºç«ç‚¹", "çˆ†ç™ºé™ç•Œ", "æ²¸ç‚¹", "è’¸æ°—åœ§"], "ans":2, "exp":"ä¸‹é™ï½ä¸Šé™ã®ç¯„å›²"},
    {"id":12, "q": "æ²¸ç‚¹ãŒæœ€ã‚‚ä½ã„ã®ã¯ï¼Ÿ", "choices": ["ã‚¬ã‚½ãƒªãƒ³", "ç¯æ²¹", "è»½æ²¹", "Aé‡æ²¹"], "ans":1, "exp":"æ²¸ç‚¹ãŒä½ã„ï¼æ®ç™ºã—ã‚„ã™ã„"},
    {"id":13, "q": "è’¸æ°—æ¯”é‡ãŒ1ã‚ˆã‚Šå¤§ãã„è’¸æ°—ã®æ€§è³ªã¯ï¼Ÿ", "choices": ["ä¸Šã«æºœã¾ã‚‹", "ä¸‹ã«æºœã¾ã‚‹", "ã©ã“ã«ã‚‚æºœã¾ã‚‰ãªã„", "ç™ºå…‰ã™ã‚‹"], "ans":2, "exp":"ç©ºæ°—ã‚ˆã‚Šé‡ã„ã¨ä½æ‰€ã«æ»ç•™"},
    {"id":14, "q": "è’¸æ°—åœ§ãŒé«˜ã„ã»ã©ï¼Ÿ", "choices": ["æ°—åŒ–ã—ã«ãã„", "æ°—åŒ–ã—ã‚„ã™ã„", "å¯†åº¦ãŒä¸ŠãŒã‚‹", "å¼•ç«ç‚¹ä¸ŠãŒã‚‹"], "ans":2, "exp":"è’¸ç™ºã—ã‚„ã™ã„â†’å±é™ºæ€§ä¸Šæ˜‡"},
    {"id":15, "q": "ç™ºç«ç‚¹ã¨ã¯ï¼Ÿ", "choices": ["è‡ªç„¶ç™ºç«ã™ã‚‹æ¸©åº¦", "å¼•ç«ç‚¹ã‚ˆã‚Šä½ã„", "æ°´ã®æ²¸ç‚¹", "å‡å›ºç‚¹"], "ans":1, "exp":"å¤–ç«ãªã—ã§ç™ºç«ã™ã‚‹æ¸©åº¦"},
    {"id":16, "q": "å¼•ç«ç‚¹ã«å½±éŸ¿ãŒå¤§ãã„ã®ã¯ï¼Ÿ", "choices": ["åˆ†å­é‡", "è’¸æ°—åœ§", "è‰²", "éŸ³"], "ans":2, "exp":"è’¸æ°—åœ§ãŒé«˜ã„ã»ã©å¼•ç«ã—ã‚„ã™ã„"},
    {"id":17, "q": "é™é›»æ°—å¯¾ç­–ã§æ­£ã—ã„ã®ã¯ï¼Ÿ", "choices": ["æ¹¿åº¦ã‚’ä¸Šã’ã‚‹", "æ›æ°—ã‚’æ­¢ã‚ã‚‹", "æ¥åœ°ã‚’å¤–ã™", "åˆæˆç¹Šç¶­ã‚’å‹§ã‚ã‚‹"], "ans":1, "exp":"åŠ æ¹¿ã¨æ¥åœ°ã§å¸¯é›»é˜²æ­¢"},
    {"id":18, "q": "çˆ†ç™ºé™ç•Œã®ä¸‹é™ã‚ˆã‚Šä¸‹ã®æ··åˆæ°—ã¯ï¼Ÿ", "choices": ["æ¿ƒã™ãã¦ç‡ƒãˆãªã„", "è–„ã™ãã¦ç‡ƒãˆãªã„", "å¿…ãšçˆ†ç™º", "è‡ªç„¶ç™ºç«"], "ans":2, "exp":"å¯ç‡ƒæˆåˆ†ãŒä¸è¶³"},
    {"id":19, "q": "æ¯”ç†±ã®å¤§ãã„ç‰©ä½“ã®ç‰¹å¾´ã¯ï¼Ÿ", "choices": ["æ¸©åº¦ãŒå¤‰ã‚ã‚Šã«ãã„", "ã™ãç†±ããªã‚‹", "ç™ºç«ã—ã‚„ã™ã„", "è’¸ç™ºã—ã‚„ã™ã„"], "ans":1, "exp":"ç†±å®¹é‡ãŒå¤§ãã„"},
    {"id":20, "q": "ã‚¬ã‚½ãƒªãƒ³ã®ä¸»æˆåˆ†ã¯ï¼Ÿ", "choices": ["ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«", "ç‚­åŒ–æ°´ç´ ", "ã‚¢ãƒ«ãƒ‡ãƒ’ãƒ‰", "ã‚±ãƒˆãƒ³"], "ans":2, "exp":"ç‚­åŒ–æ°´ç´ ï¼ˆC,Hï¼‰ä¸»ä½“"},
    # --- æ€§è³ªãƒ»æ¶ˆç« ---
    {"id":21, "q": "æ°´æº¶æ€§ã®ç¬¬1çŸ³æ²¹é¡ã¯ã©ã‚Œï¼Ÿ", "choices": ["ã‚¢ã‚»ãƒˆãƒ³", "ãƒˆãƒ«ã‚¨ãƒ³", "ã‚­ã‚·ãƒ¬ãƒ³", "ãƒ™ãƒ³ã‚¼ãƒ³"], "ans":1, "exp":"ã‚¢ã‚»ãƒˆãƒ³ã¯æ°´ã¨ä»»æ„ç‡ã§æ··å’Œ"},
    {"id":22, "q": "ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ç«ç½ã«æœ‰åŠ¹ãªæ¶ˆç«å‰¤ã¯ï¼Ÿ", "choices": ["æ°´ã®ã¿", "æ³¡ï¼ˆè€ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ€§ï¼‰", "é‡‘å±ç²‰", "ç‚­é…¸ã‚¬ã‚¹ã®ã¿"], "ans":2, "exp":"è€ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ³¡ã‚’ç”¨ã„ã‚‹"},
    {"id":23, "q": "é›»æ°—ç«ç½ã§ã¾ãšè¡Œã†ã“ã¨ã¯ï¼Ÿ", "choices": ["çµ¦é›»é®æ–­", "æ°´ã‚’ã‹ã‘ã‚‹", "ç´™ã§è¦†ã†", "é…¸ç´ ä¾›çµ¦"], "ans":1, "exp":"æ„Ÿé›»é˜²æ­¢ã®ãŸã‚é®æ–­ãŒå…ˆ"},
    {"id":24, "q": "æ²¹ç«ç½ã«æ°´ã‚’ç›´æ¥ã‹ã‘ã‚‹ã¨ï¼Ÿ", "choices": ["ç´ æ—©ãæ¶ˆãˆã‚‹", "æ‹¡æ•£ã—ã¦å±é™º", "ç™ºå…‰ã™ã‚‹", "å›ºåŒ–ã™ã‚‹"], "ans":2, "exp":"é£›æ•£ã—ã¦å»¶ç„¼ãƒ»ãƒ•ãƒ©ãƒƒã‚·ãƒ¥"},
    {"id":25, "q": "æ³¡æ¶ˆç«ã®ä¸»ãŸã‚‹æ¶ˆç«ä½œç”¨ã¯ï¼Ÿ", "choices": ["å†·å´", "çª’æ¯ãƒ»æŠ‘åˆ¶", "æŠ‘åˆ¶ã®ã¿", "å¸Œé‡ˆ"], "ans":2, "exp":"è¡¨é¢ã‚’è¦†ã„ç©ºæ°—é®æ–­ï¼‹è’¸ç™ºæŠ‘åˆ¶"},
    {"id":26, "q": "äºŒé…¸åŒ–ç‚­ç´ æ¶ˆç«ã®å¼±ç‚¹ã¯ï¼Ÿ", "choices": ["é€šé›»éƒ¨ä½ä¸å¯", "å†·å´ãŒå¼·ã™ãã‚‹", "å±‹å¤–ã§å¹ãé£›ã°ã•ã‚Œã‚„ã™ã„", "è…é£Ÿæ€§ãŒå¼·ã„"], "ans":3, "exp":"é¢¨ã§é£›æ•£ã—ã‚„ã™ã„"},
    {"id":27, "q": "ç²‰æœ«ABCæ¶ˆç«è–¬å‰¤ã®ä½œç”¨ã¯ï¼Ÿ", "choices": ["å†·å´", "é…¸ç´ å¸Œé‡ˆ", "é€£é–åå¿œæŠ‘åˆ¶", "å¸ç€"], "ans":3, "exp":"ãƒ©ã‚¸ã‚«ãƒ«åå¿œã‚’æ­¢ã‚ã‚‹"},
    {"id":28, "q": "æ°´ç³»æ¶ˆç«å‰¤ã®ä¸»ä½œç”¨ã¯ï¼Ÿ", "choices": ["çª’æ¯", "å¸Œé‡ˆ", "å†·å´", "æŠ‘åˆ¶"], "ans":3, "exp":"æ°´ã¯è’¸ç™ºæ½œç†±ã§å†·å´"},
    {"id":29, "q": "ã‚¿ãƒ³ã‚¯ç«ç½ã®æ¶ˆç«æˆ¦è¡“ã§é‡è¦ãªã®ã¯ï¼Ÿ", "choices": ["é ‚éƒ¨å†·å´ã®ã¿", "ãƒ•ã‚©ãƒ¼ãƒ ã§è¢«è¦†", "ç©ºæ°—é€å…¥", "ãƒãƒ«ãƒ–å…¨é–‹"], "ans":2, "exp":"æ³¡ã§è¡¨é¢ã‚’è¦†ã†"},
    {"id":30, "q": "å¯ç‡ƒæ€§æ¶²ä½“ã®æ¼ãˆã„æ™‚ã€ã¾ãšè¡Œã†ã®ã¯ï¼Ÿ", "choices": ["ç‚¹ç«æºé™¤å»ãƒ»ç«‹å…¥ç¦æ­¢", "é€é¢¨", "æ°´ã§æ´—ã„æµã™", "ã™ã¹ã¦ç„¼å´"], "ans":1, "exp":"äºŒæ¬¡ç½å®³é˜²æ­¢ãŒæœ€å„ªå…ˆ"},
    # --- ä»¥é™ã‚‚åŒæ§˜ã«50å•ã¾ã§ ---
    {"id":31, "q": "ã‚¢ã‚»ãƒˆãƒ³ã®é¡åˆ¥ã¯ï¼Ÿ", "choices": ["ç¬¬1çŸ³æ²¹é¡", "ç¬¬2çŸ³æ²¹é¡", "ç¬¬3çŸ³æ²¹é¡", "ç¬¬4çŸ³æ²¹é¡"], "ans":1, "exp":"æ°´æº¶æ€§ã®ç¬¬1çŸ³æ²¹é¡"},
    {"id":32, "q": "è»½æ²¹ã®é¡åˆ¥ã¯ï¼Ÿ", "choices": ["ç¬¬1", "ç¬¬2", "ç¬¬3", "ç¬¬4"], "ans":2, "exp":"è»½æ²¹ã¯ç¬¬2çŸ³æ²¹é¡ï¼ˆéæ°´æº¶æ€§ï¼‰"},
    {"id":33, "q": "ã‚­ã‚·ãƒ¬ãƒ³ã®é¡åˆ¥ã¯ï¼Ÿ", "choices": ["ç¬¬1", "ç¬¬2", "ç¬¬3", "ç¬¬4"], "ans":2, "exp":"èŠ³é¦™æ—ã®ç¬¬2çŸ³æ²¹é¡"},
    {"id":34, "q": "ã‚¨ã‚¿ãƒãƒ¼ãƒ«ã®é¡åˆ¥ã¯ï¼Ÿ", "choices": ["ç¬¬1ï¼ˆæ°´æº¶æ€§ï¼‰", "ç¬¬2ï¼ˆæ°´æº¶æ€§ï¼‰", "ç¬¬3", "ç¬¬4"], "ans":1, "exp":"ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ã¯ç¬¬1ï¼ˆæ°´æº¶æ€§ï¼‰"},
    {"id":35, "q": "é‡æ²¹ã®é¡åˆ¥ã¯ï¼Ÿ", "choices": ["ç¬¬2", "ç¬¬3", "ç¬¬4", "æŒ‡å®šå¤–"], "ans":2, "exp":"é‡æ²¹ã¯ç¬¬3çŸ³æ²¹é¡"},
    {"id":36, "q": "ãƒ™ãƒ³ã‚¼ãƒ³ã®å¼•ç«ç‚¹ã¯æ¦‚ã­ï¼Ÿ", "choices": ["-20â„ƒ", "0â„ƒå‰å¾Œ", "30â„ƒ", "100â„ƒ"], "ans":1, "exp":"éå¸¸ã«ä½ã„å¼•ç«ç‚¹"},
    {"id":37, "q": "èŠ³é¦™æ—ç‚­åŒ–æ°´ç´ ã®ä¸€èˆ¬çš„ç‰¹å¾´ã¯ï¼Ÿ", "choices": ["æ°´ã«æº¶ã‘ã‚„ã™ã„", "æ°´ã«æº¶ã‘ã«ãã„", "å¼·é…¸æ€§", "å¼·å¡©åŸºæ€§"], "ans":2, "exp":"ç–æ°´æ€§ã§æ¯”é‡ã¯æ°´ã‚ˆã‚Šå°ã•ã„ã“ã¨ãŒå¤šã„"},
    {"id":38, "q": "å¯†é–‰ç©ºé–“ã§ã®ã‚¬ã‚½ãƒªãƒ³ä½œæ¥­ã§å¿…é ˆã¯ï¼Ÿ", "choices": ["é€é¢¨æ©Ÿã§æ›æ°—", "åŠ æ¹¿", "æš–æˆ¿", "åŠ åœ§"], "ans":1, "exp":"æ›æ°—ã§æ¿ƒåº¦ä½æ¸›"},
    {"id":39, "q": "æ³¡åŸæ¶²ã®ä¿å­˜ã§å¤§åˆ‡ãªã®ã¯ï¼Ÿ", "choices": ["ç›´å°„æ—¥å…‰", "å¯†æ “ã¨æ¸…æ½”", "åŠ ç†±", "æ’¹æ‹Œã—ç¶šã‘ã‚‹"], "ans":2, "exp":"åŠ£åŒ–ãƒ»æ±šæŸ“é˜²æ­¢"},
    {"id":40, "q": "å±é™ºç‰©æ–½è¨­ã®é¿é›·è¨­å‚™ã®ç›®çš„ã¯ï¼Ÿ", "choices": ["é¨’éŸ³ä½æ¸›", "é›·æ’ƒé›»æµã‚’å¤§åœ°ã¸é€ƒãŒã™", "å†·å´", "æ¶ˆç«"], "ans":2, "exp":"é™é›»æ°—ãƒ»é›·ã®ç€ç«é˜²æ­¢"},
    {"id":41, "q": "æŒ‡å®šæ•°é‡ã®å€æ•°ã¯ä½•ã«ç”¨ã„ã‚‹ï¼Ÿ", "choices": ["å±é™ºç­‰ç´š", "æ¨™è­˜ã®è‰²", "ä¿å®‰è·é›¢ç­‰ã®åˆ¤å®š", "å®¹å™¨å½¢çŠ¶"], "ans":3, "exp":"æŠ€è¡“ä¸Šã®åŸºæº–ã®é©ç”¨ç¯„å›²åˆ¤å®š"},
    {"id":42, "q": "ã‚¬ã‚½ãƒªãƒ³ç«ç½ã®ç¬¬ä¸€é¸æŠã¯ï¼Ÿ", "choices": ["æ”¾æ°´", "ç²‰æœ«/æ³¡", "äºŒé…¸åŒ–ç‚­ç´ ", "æ°´å™´éœ§"], "ans":2, "exp":"æ³¡ã‹ç²‰æœ«ãŒåŸºæœ¬"},
    {"id":43, "q": "æ°´æº¶æ€§æº¶å‰¤ã®ç«ç½ã§é€šå¸¸æ³¡ã‚’ä½¿ã†ã¨ï¼Ÿ", "choices": ["ã‚ˆãåŠ¹ã", "åˆ†è§£ã•ã‚ŒåŠ¹ã‹ãªã„", "é‡‘å±åŒ–ã™ã‚‹", "çµæ™¶åŒ–ã™ã‚‹"], "ans":2, "exp":"è€ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ³¡ã‚’ä½¿ç”¨"},
    {"id":44, "q": "å±é™ºç‰©ã®ç§»é€ã§æ‘©æ“¦å¸¯é›»ã‚’æŠ‘ãˆã‚‹ã«ã¯ï¼Ÿ", "choices": ["éå°é›»ãƒ›ãƒ¼ã‚¹", "å°é›»æ€§ãƒ›ãƒ¼ã‚¹ã¨æ¥åœ°", "æ–­ç†±æ", "ä¿æ¸©"], "ans":2, "exp":"å°é›»åŒ–ï¼‹ã‚¢ãƒ¼ã‚¹ã§æ”¾é›»è·¯ã‚’ç¢ºä¿"},
    {"id":45, "q": "æ¶ˆé˜²è¨ˆç”»ã«å«ã‚€ã¹ãäº‹é …ã¯ï¼Ÿ", "choices": ["è²©å£²ä¾¡æ ¼", "è¨“ç·´è¨ˆç”»", "æ ªä¸»æ§‹æˆ", "è³ƒé‡‘"], "ans":2, "exp":"é˜²ç«ç®¡ç†ã®éª¨å­"},
    {"id":46, "q": "å±é™ºç‰©å±‹å†…è²¯è”µæ‰€ã®é€šè·¯å¹…ã¯æ¦‚ã­ï¼Ÿ", "choices": ["0.3m", "0.6m", "1.0m", "2.0m"], "ans":3, "exp":"å®‰å…¨ãªé¿é›£ãƒ»æ¬å‡ºã®ãŸã‚"},
    {"id":47, "q": "å¼•ç«æ€§æ¶²ä½“ã®ç€ç«æºã§ãªã„ã‚‚ã®ã¯ï¼Ÿ", "choices": ["é™é›»æ°—", "è£¸ç«", "è¡æ’ƒéŸ³", "é«˜æ¸©è¡¨é¢"], "ans":3, "exp":"éŸ³è‡ªä½“ã¯ç€ç«æºã§ã¯ãªã„"},
    {"id":48, "q": "æ²¹æ°´åˆ†é›¢ãƒãƒƒãƒˆã®ç›®çš„ã¯ï¼Ÿ", "choices": ["å¸éŸ³", "æ²¹å¸ç€", "æ¶ˆç«", "ç™ºç†±"], "ans":2, "exp":"æ¼ãˆã„å¯¾ç­–ã§ä½¿ç”¨"},
    {"id":49, "q": "å±é™ºç‰©ã®é‹æ¬ã§å¿…è¦ãªè¡¨ç¤ºã¯ï¼Ÿ", "choices": ["è»Šä¸¡å‰å¾Œã«æ¨™è­˜", "å±‹æ ¹ä¸Šãƒ•ãƒ©ãƒƒã‚°", "é‹è»¢å¸­ã®ã¿", "ä¸è¦"], "ans":1, "exp":"ç©è¼‰è¡¨ç¤ºãƒ»æ¨™è­˜ãŒå¿…è¦ï¼ˆè¦æ¨¡ã§å·®ï¼‰"},
    {"id":50, "q": "50å•çµ‚äº†æ™‚ã«æ¨å¥¨ã•ã‚Œã‚‹æ“ä½œã¯ï¼Ÿ", "choices": ["é€é¢¨", "ãƒªã‚»ãƒƒãƒˆã—ã¦å†æŒ‘æˆ¦", "æ¶ˆç«å™¨ç‚¹æ¤œ", "é€šå ±"], "ans":2, "exp":"æˆç¸¾ç¢ºèªâ†’ãƒªã‚»ãƒƒãƒˆã§å‘¨å›å­¦ç¿’ã¸"},
]

# ====== å‡ºé¡Œãƒ­ã‚¸ãƒƒã‚¯ ======
def next_question(uid: str):
    st = STATE[uid]
    # å…¨å•æ¸ˆãªã‚‰çµ‚äº†æ¡ˆå†…
    if len(st["asked_ids"]) >= len(QUESTIONS):
        msg = "ğŸ‰ å…¨50å•çµ‚äº†ï¼\nğŸ“Šã€Œæˆç¸¾ç¢ºèªã€ã§çµæœã‚’ç¢ºèª â†’ ã€Œãƒªã‚»ãƒƒãƒˆã€ã§å†æŒ‘æˆ¦ã§ãã¾ã™ã€‚"
        return TextSendMessage(text=msg, quick_reply=qr_reset_help())

    # æœªå‡ºé¡Œã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ 
    pool = [q for q in QUESTIONS if q["id"] not in st["asked_ids"]]
    q = random.choice(pool)
    st["last_q_id"] = q["id"]

    body = [f"Q{st['answered']+1}/50: {q['q']}"]
    for i, ch in enumerate(q["choices"], start=1):
        body.append(f"{i} {ch}")
    txt = "\n".join(body)
    return TextSendMessage(text=txt, quick_reply=qr_answer_buttons())

def evaluate(uid: str, choice_text: str):
    st = STATE[uid]
    # æ–‡å­—â†’ç•ªå·ï¼ˆ1ï½4ï¼‰ã¸
    mapping = {"ï¼‘":"1","ï¼’":"2","ï¼“":"3","ï¼”":"4","â‘ ":"1","â‘¡":"2","â‘¢":"3","â‘£":"4"}
    ans_txt = mapping.get(choice_text.strip(), choice_text.strip())
    if ans_txt not in {"1","2","3","4"} or st.get("last_q_id") is None:
        return TextSendMessage(text="â‘ ã€œâ‘£ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚", quick_reply=qr_answer_buttons())

    qid = st["last_q_id"]
    q = next(item for item in QUESTIONS if item["id"] == qid)
    st["answered"] += 1
    st["asked_ids"].add(qid)

    correct = int(ans_txt) == int(q["ans"])
    if correct:
        st["correct"] += 1
        feedback = f"â­• æ­£è§£ï¼\nï¼ˆè£œè¶³ï¼‰{q['exp']}"
    else:
        feedback = f"âŒ ä¸æ­£è§£â€¦\næ­£è§£ã¯ {q['ans']}ï¼š{q['choices'][q['ans']-1]}\nï¼ˆè£œè¶³ï¼‰{q['exp']}"

    # æŒ‡å®šï¼šå›ç­”å¾Œã¯ã€Šãƒªã‚»ãƒƒãƒˆ/ãƒ˜ãƒ«ãƒ—ã€‹ã®ã¿
    return TextSendMessage(text=feedback, quick_reply=qr_reset_help())

def make_status(uid: str):
    st = STATE[uid]
    a = st["answered"]
    c = st["correct"]
    rate = f"{(c/a*100):.1f}%" if a else "0%"
    msg = f"ğŸ“Š æˆç¸¾\nè§£ç­”æ•°: {a}/50\næ­£è§£: {c}\næ­£ç­”ç‡: {rate}\nã€æ¬¡ã®å•é¡Œã€ã§ç¶šè¡Œã§ãã¾ã™ã€‚"
    return TextSendMessage(text=msg, quick_reply=qr_next_or_menu())

def reset_state(uid: str):
    STATE[uid] = {"answered":0,"correct":0,"asked_ids":set(),"last_q_id":None}

# ====== LINE Webhook ======
@app.post("/callback")
def callback():
    signature = request.headers.get("X-Line-Signature", "")
    body      = request.get_data(as_text=True)
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
    return "OK"

@handler.add(MessageEvent, message=TextMessage)
def on_message(event: MessageEvent):
    uid  = event.source.user_id
    text = (event.message.text or "").strip()

    # åˆå›ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚¹ãƒ†ãƒ¼ãƒˆä½œã£ã¦ãƒ˜ãƒ«ãƒ—ã‚’è¿”ã™ï¼ˆæŒ‡å®šã©ãŠã‚Šï¼‰
    if uid not in STATE:
        reset_state(uid)
        line_bot_api.reply_message(
            event.reply_token,
            TextSendMessage(text=HELP_TEXT, quick_reply=qr_next_or_menu())
        )
        return

    # ã‚³ãƒãƒ³ãƒ‰ç³»
    if text in {"ãƒ˜ãƒ«ãƒ—","help","ä½¿ã„æ–¹"}:
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=HELP_TEXT, quick_reply=qr_next_or_menu()))
        return
    if text in {"ãƒªã‚»ãƒƒãƒˆ","reset"}:
        reset_state(uid)
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text="ğŸ§¹ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚\nã€æ¬¡ã®å•é¡Œã€ã§å†é–‹ã§ãã¾ã™ã€‚", quick_reply=qr_next_or_menu()))
        return
    if text in {"æˆç¸¾ç¢ºèª","ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹","ã‚¹ã‚³ã‚¢","æˆç¸¾"}:
        line_bot_api.reply_message(event.reply_token, make_status(uid))
        return
    if text in {"æ¬¡ã®å•é¡Œ","é–‹å§‹","å•é¡Œ","ã‚¯ã‚¤ã‚º","start","ã‚¹ã‚¿ãƒ¼ãƒˆ"}:
        line_bot_api.reply_message(event.reply_token, next_question(uid))
        return

    # å›ç­”ï¼ˆ1ã€œ4/â‘ ã€œâ‘£ï¼‰
    if text in {"1","2","3","4","ï¼‘","ï¼’","ï¼“","ï¼”","â‘ ","â‘¡","â‘¢","â‘£"}:
        line_bot_api.reply_message(event.reply_token, evaluate(uid, text))
        return

    # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    line_bot_api.reply_message(
        event.reply_token,
        TextSendMessage(text="ã€æ¬¡ã®å•é¡Œã€ã€æˆç¸¾ç¢ºèªã€ã€ãƒªã‚»ãƒƒãƒˆã€ã€ãƒ˜ãƒ«ãƒ—ã€ã‚’ä½¿ã£ã¦ã­ã€‚", quick_reply=qr_next_or_menu())
    )

# ====== ãƒ­ãƒ¼ã‚«ãƒ«èµ·å‹•ç”¨ ======
if __name__ == "__main__":
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 5000)))
