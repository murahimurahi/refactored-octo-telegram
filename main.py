# -*- coding: utf-8 -*-
import os
from flask import Flask, request, abort, jsonify
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import (
    MessageEvent, TextMessage, TextSendMessage,
    QuickReply, QuickReplyButton, MessageAction
)

# ======================
# Flask
# ======================
app = Flask(__name__)

@app.get("/health")
def health():
    return jsonify({"status": "ok"})

# ======================
# LINE keysï¼ˆRenderã®ç’°å¢ƒå¤‰æ•°ã«è¨­å®šï¼‰
# ======================
LINE_CHANNEL_ACCESS_TOKEN = os.getenv("LINE_CHANNEL_ACCESS_TOKEN", "YOUR_CHANNEL_ACCESS_TOKEN")
LINE_CHANNEL_SECRET = os.getenv("LINE_CHANNEL_SECRET", "YOUR_CHANNEL_SECRET")
line_bot_api = LineBotApi(LINE_CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(LINE_CHANNEL_SECRET)

# ======================
# ä½¿ã„æ–¹ï¼ˆãƒªã‚»ãƒƒãƒˆæ™‚ã®ã¿è¡¨ç¤ºï¼‰
# ======================
HELP_TEXT = (
    "ğŸ“˜ä½¿ã„æ–¹\n"
    "ãƒ»ã€Œæ¬¡ã®å•é¡Œã€ãƒœã‚¿ãƒ³ã‚‚ã—ãã¯ã€Œé–‹å§‹ã€ã‚³ãƒ¡ãƒ³ãƒˆæ‰‹å…¥åŠ›ã§ã‚¯ã‚¤ã‚ºé–‹å§‹ï¼ˆå…¨50å•ï¼‰\n"
    "ãƒ»4æŠãƒœã‚¿ãƒ³(1ã€œ4)ã‚’ã‚¿ãƒƒãƒ—ã§å›ç­”ã€‚æ‰‹å…¥åŠ› 1ã€œ4 ã§ã‚‚OK\n"
    "ãƒ»25å•ç›®ã¨50å•ç›®ã§æˆç¸¾ã‚’è‡ªå‹•é›†è¨ˆ\n"
    "ãƒ»ã€Œãƒªã‚»ãƒƒãƒˆã€ã§æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—\n"
    "ãƒ»åˆ†é‡ãƒãƒ©ãƒ³ã‚¹ã¯æ³•ä»¤/ç‰©ç†åŒ–å­¦/æ€§è³ªæ¶ˆç«ã‚’ãƒŸãƒƒã‚¯ã‚¹ã—ã¦ã„ã¾ã™ã€‚\n"
)

def qr_after_answer():
    # å›ç­”å¾Œã¯ã€Œãƒªã‚»ãƒƒãƒˆã€ã¨ã€Œãƒ˜ãƒ«ãƒ—ã€ã®ã¿ï¼ˆè¦æœ›ã©ãŠã‚Šï¼‰
    return QuickReply(items=[
        QuickReplyButton(action=MessageAction(label="ğŸ”„ ãƒªã‚»ãƒƒãƒˆ", text="ãƒªã‚»ãƒƒãƒˆ")),
        QuickReplyButton(action=MessageAction(label="â“ ãƒ˜ãƒ«ãƒ—", text="ãƒ˜ãƒ«ãƒ—")),
    ])

def qr_next_only():
    # ä»»æ„ï¼šæœ€åˆã«è‡ªåˆ†ã§ã€Œæ¬¡ã®å•é¡Œã€ã¨é€ã‚‹é‹ç”¨ãªã‚‰ä¸è¦ã€‚é–‹å§‹ç›´å¾Œã«å‡ºã™ãƒœã‚¿ãƒ³ç”¨ã«å®šç¾©
    return QuickReply(items=[
        QuickReplyButton(action=MessageAction(label="â–¶ æ¬¡ã®å•é¡Œ", text="æ¬¡ã®å•é¡Œ")),
    ])

# ======================
# éå»å• 50å•ï¼ˆæ³•ä»¤/ç‰©ç†åŒ–å­¦/æ€§è³ªæ¶ˆç«ï¼‰
# ans ã¯ 1ã€œ4ã€exp ã¯è£œè¶³
# ======================
Q = [
# ---- æ³•ä»¤ï¼ˆ1ã€œ18ï¼‰ ----
{"q":"ç¬¬4é¡å±é™ºç‰©ã®æœ¬è³ªã¯ï¼Ÿ","choices":["é…¸åŒ–æ€§æ¶²ä½“","å¼•ç«æ€§æ¶²ä½“","å¯ç‡ƒæ€§æ¶²ä½“","è…é£Ÿæ€§æ¶²ä½“"],"ans":2,"exp":"ä¹™4ã¯â€œå¼•ç«æ€§æ¶²ä½“â€ã‚’æ‰±ã†å…çŠ¶ã€‚"},
{"q":"å±é™ºç‰©å–æ‰±è€…å…çŠ¶ã‚’äº¤ä»˜ã™ã‚‹ã®ã¯ï¼Ÿ","choices":["æ¶ˆé˜²åºé•·å®˜","å¸‚ç”ºæ‘é•·","éƒ½é“åºœçœŒçŸ¥äº‹","æ¶ˆé˜²ç½²é•·"],"ans":3,"exp":"å…çŠ¶äº¤ä»˜ã¯éƒ½é“åºœçœŒçŸ¥äº‹ã€‚"},
{"q":"è£½é€ æ‰€ç­‰ã®è¨±å¯æ¨©è€…ã¯ï¼Ÿ","choices":["æ¶ˆé˜²åºé•·å®˜","éƒ½é“åºœçœŒçŸ¥äº‹","å¸‚ç”ºæ‘é•·","æ¶ˆé˜²ç½²é•·"],"ans":2,"exp":"è¨±å¯ã¯åŸºæœ¬éƒ½é“åºœçœŒçŸ¥äº‹ï¼ˆæ¡ä¾‹ã§å§”ä»»ã‚ã‚Šï¼‰ã€‚"},
{"q":"å°‘é‡å±é™ºç‰©ã®ä¸Šé™ï¼ˆç¬¬4é¡ï¼‰ã¯ï¼Ÿ","choices":["æŒ‡å®šæ•°é‡ã®ååˆ†ã®ä¸€æœªæº€","æŒ‡å®šæ•°é‡ã®äº”åˆ†ã®ä¸€æœªæº€","æŒ‡å®šæ•°é‡æœªæº€","æŒ‡å®šæ•°é‡ã®äºŒåˆ†ã®ä¸€æœªæº€"],"ans":1,"exp":"â€œå°‘é‡å±é™ºç‰©â€ã¯æŒ‡å®šæ•°é‡ã®1/10æœªæº€ã€‚"},
{"q":"å°‘é‡å±é™ºç‰©ã®â€œå€æ•°â€ã®æ•°ãˆæ–¹ã¯ï¼Ÿ","choices":["åˆ‡ã‚Šä¸Šã’","åˆ‡ã‚Šæ¨ã¦","å››æ¨äº”å…¥","ç«¯æ•°ã¯0æ‰±ã„"],"ans":1,"exp":"å°‘é‡å€æ•°ã¯åˆ‡ã‚Šä¸Šã’ã€‚"},
{"q":"è²¯è”µãƒ»å–æ‰±ã„ã®â€œå±Šå‡ºå…ˆâ€ã¯ï¼Ÿ","choices":["éƒ½é“åºœçœŒçŸ¥äº‹","æ¶ˆé˜²ç½²é•·ç­‰","ç·å‹™å¤§è‡£","å¸‚ç”ºæ‘é•·"],"ans":2,"exp":"å®Ÿå‹™ã¯æ¶ˆé˜²æ©Ÿé–¢ï¼ˆæ¶ˆé˜²é•·/æ¶ˆé˜²ç½²é•·ç­‰ï¼‰ã€‚"},
{"q":"å±é™ºç‰©ã®è¦åˆ¶ã«é–¢ã™ã‚‹æ”¿ä»¤ã¯ï¼Ÿ","choices":["æ¶ˆé˜²æ³•æ–½è¡Œä»¤","åŠ´åƒå®‰å…¨è¡›ç”Ÿæ³•æ–½è¡Œä»¤","æ¯’åŠ‡æ³•æ–½è¡Œä»¤","å±é™ºç‰©é‹æ¬ä»¤"],"ans":1,"exp":"æ¶ˆé˜²æ³•æ–½è¡Œä»¤ãŒãƒ™ãƒ¼ã‚¹ã€‚"},
{"q":"å±‹å†…è²¯è”µæ‰€ã®æ‰€è¦åºŠé¢ç©åŒºç”»ã«é–¢ä¿‚ã™ã‚‹ã®ã¯ï¼Ÿ","choices":["é˜²ç«å£","é˜²æ¶²å ¤","é˜²æ²¹å ¤","é˜²ç«æˆ¸"],"ans":2,"exp":"æ¶²ä½“ãªã®ã§â€œé˜²æ¶²å ¤â€ï¼ˆé˜²æ²¹å ¤åŒç¾©ï¼‰ã€‚"},
{"q":"ä»®è²¯è”µãƒ»ä»®å–æ‰±ã„ã®è¨±å¯æ¨©è€…ã¯ï¼Ÿ","choices":["æ¶ˆé˜²åºé•·å®˜","æ¶ˆé˜²ç½²é•·ç­‰","éƒ½é“åºœçœŒçŸ¥äº‹","å¸‚ç”ºæ‘é•·"],"ans":2,"exp":"å®Ÿå‹™ã¯æ¶ˆé˜²ç½²é•·ç­‰ã€‚"},
{"q":"å±é™ºç‰©æ–½è¨­ä¿å®‰å“¡ã®é¸ä»»ãŒä¸è¦ãªã®ã¯ï¼Ÿ","choices":["è£½é€ æ‰€","å±‹å¤–ã‚¿ãƒ³ã‚¯è²¯è”µæ‰€","çµ¦æ²¹å–æ‰±æ‰€","ç§»é€å–æ‰±æ‰€"],"ans":3,"exp":"çµ¦æ²¹å–æ‰±æ‰€ã¯â€œå–æ‰±æ‰€â€ã§ä¿å®‰å“¡ä¸è¦ã€‚"},
{"q":"å®šæœŸç‚¹æ¤œã‚’è¦ã™ã‚‹ã®ã¯ï¼Ÿ","choices":["ä»®è²¯è”µã®ã¿","å°‘é‡å±é™ºç‰©ã®ã¿","æŒ‡å®šæ•°é‡ä»¥ä¸Šã®è£½é€ æ‰€ç­‰","å…¨ã¦ä¸è¦"],"ans":3,"exp":"æŒ‡å®šæ•°é‡ä»¥ä¸Šã®è£½é€ æ‰€ç­‰ã¯ä¿å®‰æ¤œæŸ»ç­‰ãŒå¿…è¦ã€‚"},
{"q":"å±é™ºç‰©å–æ‰±è€…ãŒâ€œç«‹ä¼šã„â€ã‚’è¦ã™ã‚‹ä½œæ¥­ã¯ï¼Ÿ","choices":["å¸³ç¥¨ä½œæˆ","æ¸…æƒ","æ³¨æ²¹ãƒ»æŠœæ²¹ç­‰ã®å±é™ºç‰©ã®ç§»å‹•","è¦‹å›ã‚Š"],"ans":3,"exp":"å±é™ºç‰©ã®ç§»å‹•ãƒ»ç§»é€ã¯ç«‹ä¼šã„å¯¾è±¡ã€‚"},
{"q":"å±é™ºç‰©ã®åˆ†é¡è¡¨ç¤ºã§ç¬¬4é¡ã®è‰²ã¯ï¼Ÿ","choices":["èµ¤","é»„","é’","ç·‘"],"ans":1,"exp":"ç¬¬4é¡ã¯â€œèµ¤â€ã€‚"},
{"q":"ç•°ç¨®æ··åˆã§ç‰¹ã«ç¦å¿Œã¯ï¼Ÿ","choices":["æ°´ã¨æ··åˆ","é…¸åŒ–å‰¤ã¨æ··åˆ","ç©ºæ°—ã¨æ··åˆ","çª’ç´ ã¨æ··åˆ"],"ans":2,"exp":"ç¬¬4é¡ã¯é…¸åŒ–å‰¤ã¨æ··åˆå³ç¦ã€‚"},
{"q":"æŒ‡å®šæ•°é‡1000Lã®å“ç›®ã¯ï¼Ÿ","choices":["é‡æ²¹","ã‚¬ã‚½ãƒªãƒ³","ç¯æ²¹","ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é¡"],"ans":1,"exp":"é‡æ²¹ã¯1000Lã€ç¯æ²¹ãƒ»è»½æ²¹ã‚‚1000Lã€ã‚¬ã‚½ãƒªãƒ³ã¯200Lã€‚"},
{"q":"çµ¦æ²¹å–æ‰±æ‰€ã®ç«æ°—ä½¿ç”¨ã¯ï¼Ÿ","choices":["æŒ‡å®šå ´æ‰€ã§å¯","åŸå‰‡ç¦æ­¢","è‡ªç”±","æ¶ˆé˜²é•·è¨±å¯ã§å¯"],"ans":2,"exp":"ç«æ°—å³ç¦ã€‚"},
{"q":"å±é™ºç‰©ã®é‹æ¬ã§ç©è¼‰æ–¹æ³•ã®åŸå‰‡ã¯ï¼Ÿ","choices":["æ¨ªç©ã¿","ç¸¦ç©ã¿","é‡é‡ç‰©ä¸‹ãƒ»è»½é‡ç‰©ä¸Š","æ–œã‚ç©ã¿"],"ans":3,"exp":"é‡ã„ç‰©ã‚’ä¸‹ã€è»½ã„ç‰©ã‚’ä¸Šã«ã€‚"},
{"q":"å±é™ºç‰©ã®å®¹å™¨è¡¨ç¤ºã«å¿…é ˆã§ãªã„ã‚‚ã®ã¯ï¼Ÿ","choices":["å“å","æˆåˆ†","æŒ‡å®šæ•°é‡","å±é™ºç­‰ç´š"],"ans":3,"exp":"å®¹å™¨è¡¨ç¤ºã¯å“å/å±é™ºç­‰ç´š/æ°´æº¶æ€§/ç«æ°—å³ç¦ç­‰ã€‚æŒ‡å®šæ•°é‡ã¯ä¸è¦ã€‚"},
# ---- ç‰©ç†åŒ–å­¦ï¼ˆ19ã€œ34ï¼‰ ----
{"q":"å¼•ç«ç‚¹ã¨ã¯ï¼Ÿ","choices":["è‡ªç„¶ç™ºç«ã™ã‚‹æ¸©åº¦","ç‚¹ç«æºã§ç‡ƒãˆç¶šã‘ã‚‹æœ€ä½ã®æ¶²æ¸©","çˆ†ç™ºä¸‹é™ç•Œ","ç‡ƒç„¼é€Ÿåº¦"],"ans":2,"exp":"å¤–éƒ¨ç‚¹ç«ã§â€œç‡ƒãˆç¶šã‘ã‚‹â€æœ€ä½æ¶²æ¸©ã€‚"},
{"q":"ç™ºç«ç‚¹ã¨ã¯ï¼Ÿ","choices":["è‡ªç„¶ç™ºç«ã™ã‚‹æ¸©åº¦","å¼•ç«ã™ã‚‹æœ€ä½æ¸©åº¦","æ²¸ç‚¹","è’¸æ°—åœ§ãŒ1atmã¨ãªã‚‹æ¸©åº¦"],"ans":1,"exp":"å¤–éƒ¨ç‚¹ç«ãªã—ã§è‡ªå·±ç™ºç«ã™ã‚‹æ¸©åº¦ã€‚"},
{"q":"è’¸æ°—åœ§ãŒé«˜ã„ã»ã©","choices":["è’¸ç™ºã—ã«ãã„","å¼•ç«ã—ã«ãã„","è’¸ç™ºã—ã‚„ã™ã„","æ²¸ç‚¹ãŒä¸ŠãŒã‚‹"],"ans":3,"exp":"è’¸æ°—åœ§â†‘ï¼æ®ç™ºæ€§â†‘ã€‚"},
{"q":"å¯†åº¦ãŒç©ºæ°—ã‚ˆã‚Šå¤§ãã„è’¸æ°—ã¯ï¼Ÿ","choices":["ä¸Šéƒ¨ã«æ»ç•™","ä¸‹æ–¹ã«æ»ç•™","å‡ä¸€ã«æ‹¡æ•£","æ»ç•™ã—ãªã„"],"ans":2,"exp":"å¤šãã®ç¬¬4é¡è’¸æ°—ã¯ç©ºæ°—ã‚ˆã‚Šé‡ãâ€œä½æ‰€ã«æ»ç•™â€ã€‚"},
{"q":"çˆ†ç™ºä¸‹é™ç•Œã«è¿‘ã„æ··åˆæ°—ã¯ï¼Ÿ","choices":["ç€ç«ã—ã‚„ã™ã„","ç€ç«ã—ã«ãã„","å¿…ãšçˆ†ç™º","é…¸æ¬ "],"ans":2,"exp":"ä¸‹é™ç•Œä»˜è¿‘ã¯å¯ç‡ƒæ€§ãŒä¸è¶³ã—ç€ç«ã—ã«ãã„ã€‚"},
{"q":"å¯ç‡ƒæ€§æ¶²ä½“ã®è’¸æ°—ãŒæœ€ã‚‚ç™ºç”Ÿã—ã‚„ã™ã„ã®ã¯ï¼Ÿ","choices":["è¡¨é¢ç©å¤§ãƒ»æ¸©åº¦é«˜ãƒ»é¢¨é€šã—è‰¯","è¡¨é¢ç©å°ãƒ»æ¸©åº¦ä½","å¯†é–‰ãƒ»ä½æ¸©","è¡¨é¢ç©å°ãƒ»é«˜æ¹¿"],"ans":1,"exp":"è¡¨é¢ç©â†‘ãƒ»æ¸©åº¦â†‘ã§è’¸ç™ºâ†‘ã€‚"},
{"q":"æ°´ã«ä¸æº¶ãƒ»æ¯”é‡<1ã®ç¬¬4é¡ã®æµå‡ºæ™‚ã€å °å†…ã§ã©ã†ãªã‚‹ï¼Ÿ","choices":["æ°´å±¤ã®ä¸‹ã«æ²ˆã‚€","æ°´é¢ã«æµ®ã","æ°´ã¨æ··ã–ã‚‹","å‹æ‰‹ã«è’¸ç™ºã™ã‚‹"],"ans":2,"exp":"æ¯”é‡<1ãƒ»ä¸æº¶â†’æ°´é¢ã«æµ®ä¸Šã€‚"},
{"q":"ãƒ¡ã‚¿ãƒãƒ¼ãƒ«ã®ç‰¹å¾´","choices":["æ¯’æ€§ãªã—","æ°´ã«æº¶ã‘ãªã„","æ°´ã«ä»»æ„ã«æ··å’Œ","æ¯”é‡>1ã§æ²ˆã‚€"],"ans":3,"exp":"ãƒ¡ã‚¿ãƒãƒ¼ãƒ«ã¯æ°´ã¨ä»»æ„æ··å’Œã€æ¯’æ€§ã‚ã‚Šã€‚"},
{"q":"ã‚¢ã‚»ãƒˆãƒ³ã®åˆ†é¡","choices":["ç¬¬1çŸ³æ²¹é¡","ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é¡","ç¬¬2çŸ³æ²¹é¡","ç¬¬3çŸ³æ²¹é¡"],"ans":1,"exp":"ã‚¢ã‚»ãƒˆãƒ³ã¯ç¬¬1çŸ³æ²¹é¡ï¼ˆæ³•åˆ†é¡ï¼‰ã€‚"},
{"q":"ç¯æ²¹ã®æŒ‡å®šæ•°é‡","choices":["200L","400L","1000L","2000L"],"ans":3,"exp":"ç¯æ²¹ãƒ»è»½æ²¹ã¯1000Lã€‚"},
{"q":"ã‚¬ã‚½ãƒªãƒ³ã®æ²¸ç‚¹åŸŸï¼ˆæ¦‚ç•¥ï¼‰","choices":["30ã€œ200â„ƒ","-20ã€œ20â„ƒ","200ã€œ350â„ƒ","80ã€œ120â„ƒ"],"ans":1,"exp":"è»½è³ªã€œä¸­è³ªã®åºƒã„ç¯„å›²ã€‚"},
{"q":"é™é›»æ°—å¯¾ç­–ã§æœ‰åŠ¹ã§ãªã„ã‚‚ã®","choices":["ã‚¢ãƒ¼ã‚¹","æµé€Ÿã‚’ä¸Šã’ã‚‹","å°é›»æ€§ãƒ›ãƒ¼ã‚¹","åŠ æ¹¿"],"ans":2,"exp":"æµé€Ÿã‚’ä¸Šã’ã‚‹ã¨å¸¯é›»ã—ã‚„ã™ã„ã€‚"},
{"q":"æ°´æº¶æ€§ç¬¬1çŸ³æ²¹é¡ã¯ï¼Ÿ","choices":["ãƒ™ãƒ³ã‚¼ãƒ³","ãƒˆãƒ«ã‚¨ãƒ³","é…¢é…¸ã‚¨ãƒãƒ«","ã‚¢ã‚»ãƒˆãƒ³"],"ans":4,"exp":"ã‚¢ã‚»ãƒˆãƒ³ã¯æ°´ã¨ä»»æ„æ··å’Œã€‚"},
{"q":"é…¸åŒ–å‰¤ã¨æ··åˆå±é™ºãŒå¤§ãã„ã®ã¯ï¼Ÿ","choices":["é‡æ²¹","ã‚¬ã‚½ãƒªãƒ³","ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«","ã‚¢ã‚»ãƒˆã‚¢ãƒ«ãƒ‡ãƒ’ãƒ‰"],"ans":4,"exp":"é‚„å…ƒæ€§å¼·ãé…¸åŒ–å‰¤ã¨æ¿€åå¿œã€‚"},
{"q":"ãƒãƒ­ã‚²ãƒ³åŒ–æ¶ˆç«å‰¤ã®ä¸»ä½œç”¨","choices":["å†·å´","çª’æ¯","æŠ‘åˆ¶ï¼ˆé€£é–åå¿œåœæ­¢ï¼‰","å¸Œé‡ˆ"],"ans":3,"exp":"åŒ–å­¦æŠ‘åˆ¶åŠ¹æœãŒä¸»ã€‚"},
# ---- æ€§è³ªãƒ»æ¶ˆç«ï¼ˆ35ã€œ50ï¼‰ ----
{"q":"ã‚¬ã‚½ãƒªãƒ³ç«ç½ã«â€œæ°´æ•£å¸ƒâ€ã¯ï¼Ÿ","choices":["æœ€é©","åŸå‰‡ç¦æ­¢","çŠ¶æ³ã«ã‚ˆã‚Šå¯","æ°´æŸ±ã§å¹ãé£›ã°ã™"],"ans":2,"exp":"æ°´ã¯æ¯”é‡å·®ã§æµå‡ºæ‹¡å¤§ã®å±é™ºã€‚æ³¡ã§è¦†ã†ã€‚"},
{"q":"ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é¡ã«æœ‰åŠ¹ãªæ³¡ã¯ï¼Ÿ","choices":["è›‹ç™½æ³¡","ã‚±ãƒŸã‚«ãƒ«æ³¡","è€ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ³¡","ç©ºæ°—æ³¡"],"ans":3,"exp":"è€ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ³¡ï¼ˆã‚¢ãƒ«ã‚³ãƒ¼ãƒ«è€æ€§ï¼‰ã€‚"},
{"q":"ãƒ¡ã‚¿ãƒãƒ¼ãƒ«ç«ç½ã®æ¶ˆç«","choices":["éœ§çŠ¶æ°´ã®ã¿","äºŒé…¸åŒ–ç‚­ç´ ã®ã¿","è€ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ³¡","ç²‰æœ«ã®ã¿"],"ans":3,"exp":"è€ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ³¡ãŒç¬¬ä¸€é¸æŠã€‚"},
{"q":"é‡æ²¹ã®æ¶ˆç«ã«ä¸é©","choices":["æ³¡","ç²‰æœ«","äºŒé…¸åŒ–ç‚­ç´ ","éœ§çŠ¶æ°´"],"ans":3,"exp":"COâ‚‚ã¯é–‹æ”¾ç©ºé–“ãƒ»é¢¨ã§åŠ¹æœè–„ã„ã€‚æ³¡ãŒåŸºæœ¬ã€‚"},
{"q":"é™é›»æ°—ç€ç«ã‚’é˜²ãé‹ç”¨","choices":["æº€ã‚¿ãƒ³ç›´å‰ã¯é«˜é€Ÿã§æ³¨å…¥","é‡‘å±é–“ã®ã‚¢ãƒ¼ã‚¹","åˆæˆæ¨¹è„‚å®¹å™¨ã®å¤šç”¨","ä¹¾ç‡¥ã‚’ä¿ã¤"],"ans":2,"exp":"ã‚¢ãƒ¼ã‚¹ã¨åŠ æ¹¿ã€æµé€ŸæŠ‘åˆ¶ã€å°é›»æ€§å™¨å…·ã€‚"},
{"q":"æ²¹é¡æµå‡ºæ™‚ã®åˆå‹•","choices":["æ°´ã§æµã™","åœŸç ‚ç­‰ã§ã›ãæ­¢ã‚","æ³¡ã§å†·å´","è’¸æ°—ã§å¸Œé‡ˆ"],"ans":2,"exp":"ã¾ãšâ€œæ­¢ã‚ã‚‹ãƒ»å›²ã†â€ã€‚"},
{"q":"å¯†é–‰å®¤å†…ã®æº¶å‰¤è’¸æ°—å¯¾ç­–","choices":["é€é¢¨ã—ã¦æ‹¡æ•£","ä¸‹éƒ¨æ›æ°—ã‚’é‡è¦–","ä¸Šéƒ¨ã®ã¿æ’æ°—","åŠ æ¹¿ã ã‘"],"ans":2,"exp":"è’¸æ°—ã¯é‡ãä¸‹éƒ¨æ»ç•™â†’ä¸‹æ–¹æ›æ°—ã€‚"},
{"q":"ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ç«ç½ã§â€œè›‹ç™½æ³¡â€ã®ã¿ã‚’ä½¿ç”¨ã™ã‚‹ã¨","choices":["å•é¡Œãªã„","æ³¡ãŒç ´å£Šã•ã‚Œã‚„ã™ã„","åå¿œçˆ†ç™º","å¹ãé£›ã¶"],"ans":2,"exp":"ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ã§æ³¡ãŒæº¶è§£â†’è€ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ³¡ã‚’ã€‚"},
{"q":"å¯ç‡ƒæ€§æ¶²ä½“ãƒãƒ³ãƒ—ç§»é€æ™‚ã«é¿ã‘ã‚‹ã¹ãã¯ï¼Ÿ","choices":["é‡‘å±é…ç®¡","å°é›»æ€§ãƒ›ãƒ¼ã‚¹","éå°é›»æ€§ãƒ›ãƒ¼ã‚¹","ã‚¢ãƒ¼ã‚¹æ¥ç¶š"],"ans":3,"exp":"éå°é›»æ€§ã¯å¸¯é›»ã—ã‚„ã™ã„ã€‚"},
{"q":"å¼•ç«ç‚¹ãŒå¸¸æ¸©ã‚ˆã‚Šååˆ†é«˜ã„æ¶²ä½“","choices":["å¸¸æ¸©ã§å¼•ç«ã—ã‚„ã™ã„","å¸¸æ¸©ã§ã¯å¼•ç«ã—ã«ãã„","å¿…ãšè‡ªç„¶ç™ºç«","è’¸æ°—ã¯ç©ºæ°—ã‚ˆã‚Šè»½ã„"],"ans":2,"exp":"å¸¸æ¸©ã§å¼•ç«ç‚¹æœªæº€ãªã‚‰å¯ç‡ƒè’¸æ°—ãŒä¸è¶³ã€‚"},
{"q":"ã‚¢ã‚»ãƒˆã‚¢ãƒ«ãƒ‡ãƒ’ãƒ‰ã®ç‰¹å¾´","choices":["å¸¸æ¸©æ¶²ä½“ã§å®‰å®š","è‡ªå·±åå¿œæ€§ãŒã‚ã‚‹","æ°´ã«ä¸æº¶ã§é‡ã„","è‡­æ°—ãªã—"],"ans":2,"exp":"è‡ªå·±åå¿œãƒ»é‡åˆã—ã‚„ã™ãå±é™ºã€‚"},
{"q":"ãƒ™ãƒ³ã‚¼ãƒ³ã®æ€§è³ª","choices":["æ°´ã«ä»»æ„æ··å’Œ","æ¯’æ€§ãŒå¼·ã„èŠ³é¦™æ—","æ¯”é‡1.2ã§æ²ˆã‚€","ç„¡å¼•ç«æ€§"],"ans":2,"exp":"æ¯’æ€§ã«æ³¨æ„ã€‚æ°´ã«ã¯ã»ã¼ä¸æº¶ã€‚"},
{"q":"å¡—è£…ãƒ–ãƒ¼ã‚¹ã®ç«ç½ä¸»å› ã§èª¤ã‚Š","choices":["æ›æ°—ä¸è‰¯","éœ§åŒ–ã§è’¸æ°—æ¿ƒåº¦ä¸Šæ˜‡","é™é›»æ°—","æ°´åˆ†éå¤š"],"ans":4,"exp":"æ°´åˆ†ã¯ç›´æ¥ã®å‡ºç«åŸå› ã«ãªã‚‰ãªã„ã€‚"},
{"q":"è»½æ²¹ã®æŒ‡å®šæ•°é‡","choices":["200L","400L","1000L","2000L"],"ans":3,"exp":"è»½æ²¹=1000Lã€‚"},
{"q":"ç¬¬1çŸ³æ²¹é¡ã«è©²å½“","choices":["é‡æ²¹","ç¯æ²¹","ã‚¬ã‚½ãƒªãƒ³","è»½æ²¹"],"ans":3,"exp":"ã‚¬ã‚½ãƒªãƒ³ã¯ç¬¬1çŸ³æ²¹é¡ï¼ˆéæ°´æº¶æ€§ï¼‰ã€‚"},
{"q":"æ°´æº¶æ€§ç¬¬1çŸ³æ²¹é¡ã®ä»£è¡¨","choices":["é…¢é…¸ã‚¨ãƒãƒ«","ãƒ¡ã‚¿ãƒãƒ¼ãƒ«","ãƒ™ãƒ³ã‚¼ãƒ³","ã‚­ã‚·ãƒ¬ãƒ³"],"ans":1,"exp":"é…¢é…¸ã‚¨ãƒãƒ«ã¯æ°´ã«ã‚„ã‚„æº¶ã‘ã‚‹ï¼ˆæ³•ä¸Šã¯ç¬¬1çŸ³æ²¹é¡ï¼‰ã€‚"}
]
TOTAL = len(Q)  # 50

# ======================
# çŠ¶æ…‹ï¼ˆè¶…ç°¡æ˜“ï¼šãƒ¡ãƒ¢ãƒªï¼‰
# ======================
# uid -> {"i": ç¾åœ¨å•index, "score": æ­£è§£æ•°}
STATE = {}

def send_question(reply_token, uid):
    s = STATE.setdefault(uid, {"i": 0, "score": 0})
    i = s["i"]
    if i >= TOTAL:
        line_bot_api.reply_message(
            reply_token,
            TextSendMessage(text=f"âœ… å…¨{TOTAL}å•çµ‚äº†ï¼æœ€çµ‚æˆç¸¾ï¼š{s['score']} / {TOTAL}\nã€Œãƒªã‚»ãƒƒãƒˆã€ã§å†æŒ‘æˆ¦ã§ãã¾ã™ã€‚", quick_reply=qr_after_answer())
        )
        return
    q = Q[i]
    text = f"Q{i+1}/{TOTAL}\n{q['q']}\n1 {q['choices'][0]}\n2 {q['choices'][1]}\n3 {q['choices'][2]}\n4 {q['choices'][3]}"
    # å‡ºé¡Œæ™‚ã¯4æŠã®ã¿ï¼ˆé–‹å§‹æ™‚ã«ã ã‘â€œæ¬¡ã®å•é¡Œâ€ãƒœã‚¿ãƒ³ã‚’å‡ºã—ãŸã„ãªã‚‰ qr_next_only ã«å·®ã—æ›¿ãˆï¼‰
    line_bot_api.reply_message(
        reply_token,
        TextSendMessage(text=text,
                        quick_reply=QuickReply(items=[
                            QuickReplyButton(action=MessageAction(label=f"â‘  {q['choices'][0]}", text="1")),
                            QuickReplyButton(action=MessageAction(label=f"â‘¡ {q['choices'][1]}", text="2")),
                            QuickReplyButton(action=MessageAction(label=f"â‘¢ {q['choices'][2]}", text="3")),
                            QuickReplyButton(action=MessageAction(label=f"â‘£ {q['choices'][3]}", text="4")),
                        ]))
    )

def send_usage(reply_token):
    # ãƒªã‚»ãƒƒãƒˆæ™‚ã®ã¿ä½¿ã„æ–¹ã‚’å‡ºã™ï¼ˆè¦æœ›ï¼‰
    line_bot_api.reply_message(
        reply_token,
        TextSendMessage(text=HELP_TEXT, quick_reply=qr_next_only())
    )

def handle_answer(reply_token, uid, choice_num):
    s = STATE[uid]
    q = Q[s["i"]]
    correct = q["ans"]
    ok = (choice_num == correct)
    if ok:
        s["score"] += 1
        head = "â­• æ­£è§£ï¼"
    else:
        head = f"âŒ ä¸æ­£è§£â€¦ æ­£è§£ã¯ {correct}ï¼š{q['choices'][correct-1]}"
    body = f"(è£œè¶³) {q.get('exp','')}"
    s["i"] += 1
    reached = s["i"]

    # 25 / 50 ã§ç·æ‹¬
    footer = ""
    if reached in (25, 50):
        rate = round(s["score"]/reached*100, 1)
        footer = f"\n\nâ€” ã“ã“ã¾ã§ã®æˆç¸¾ â€”\n{reached}å•ä¸­ {s['score']} æ­£è§£ï¼ˆ{rate}%ï¼‰"

    line_bot_api.reply_message(
        reply_token,
        TextSendMessage(text=f"{head}\n{body}{footer}", quick_reply=qr_after_answer())
    )
    # ã€Œæ¬¡ã®å•é¡Œã€ã¯ãƒœã‚¿ãƒ³ã‚’å‡ºã•ãªã„æ–¹é‡ãªã®ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ã§ã€Œæ¬¡ã®å•é¡Œã€ã¨é€ã‚‹

# ======================
# Webhook
# ======================
@app.post("/callback")
def callback():
    signature = request.headers.get('X-Line-Signature', '')
    body = request.get_data(as_text=True)
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
    return "OK"

@handler.add(MessageEvent, message=TextMessage)
def on_message(event: MessageEvent):
    uid = event.source.user_id
    text = event.message.text.strip()

    # ãƒªã‚»ãƒƒãƒˆ â†’ ä½¿ã„æ–¹ã‚’è¡¨ç¤ºï¼ˆâ€œæ¬¡ã®å•é¡Œâ€ã§é€²ã‚€ï¼‰
    if text == "ãƒªã‚»ãƒƒãƒˆ":
        STATE[uid] = {"i": 0, "score": 0}
        send_usage(event.reply_token)
        return

    # ãƒ˜ãƒ«ãƒ—ï¼ˆå†…å®¹ã¯æŒ‡å®šã®ãƒ˜ãƒ«ãƒ—æ–‡ï¼‰
    if text == "ãƒ˜ãƒ«ãƒ—":
        line_bot_api.reply_message(
            event.reply_token,
            TextSendMessage(text=HELP_TEXT, quick_reply=qr_after_answer())
        )
        return

    # é–‹å§‹ â†’ çŠ¶æ…‹ã‚»ãƒƒãƒˆã—ã¦æœ€åˆã®å‡ºé¡Œï¼ˆé–‹å§‹ç›´å¾Œã«ã€Œæ¬¡ã®å•é¡Œã€æŠ¼ã•ã›ã‚‹ãªã‚‰ä¸‹ã®è¡Œã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
    if text == "é–‹å§‹":
        STATE[uid] = {"i": 0, "score": 0}
        send_question(event.reply_token, uid)
        return

    # æ¬¡ã®å•é¡Œ â†’ ç¾åœ¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‹ã‚‰å‡ºé¡Œ
    if text == "æ¬¡ã®å•é¡Œ":
        if uid not in STATE:
            STATE[uid] = {"i": 0, "score": 0}
        send_question(event.reply_token, uid)
        return

    # å›ç­”ï¼ˆ1ã€œ4ï¼‰
    if text in {"1","2","3","4"} and uid in STATE:
        handle_answer(event.reply_token, uid, int(text))
        return

    # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆåˆå›ãªã©ï¼‰
    if uid not in STATE:
        STATE[uid] = {"i": 0, "score": 0}
    line_bot_api.reply_message(
        event.reply_token,
        TextSendMessage(text="ã€Œé–‹å§‹ã€ã¾ãŸã¯ã€Œãƒªã‚»ãƒƒãƒˆã€ã€Œãƒ˜ãƒ«ãƒ—ã€ã€é€²ã‚ã‚‹ã¨ãã¯ã€Œæ¬¡ã®å•é¡Œã€ã¨é€ã£ã¦ãã ã•ã„ã€‚", quick_reply=qr_next_only())
    )

# ======================
# Local runï¼ˆRenderã§ã¯Procfile/Start Commandã§èµ·å‹•ï¼‰
# ======================
if __name__ == "__main__":
    port = int(os.getenv("PORT", "10000"))
    app.run(host="0.0.0.0", port=port)
