# main.py
# ä¾å­˜: fastapi, uvicorn, line-bot-sdk
import os
import re
import random
from typing import Dict, List, Optional

from fastapi import FastAPI, Request, HTTPException
from fastapi.responses import PlainTextResponse
from pydantic import BaseModel

from linebot import LineBotApi, WebhookParser
from linebot.exceptions import InvalidSignatureError
from linebot.models import (
    MessageEvent,
    TextMessage,
    TextSendMessage,
    QuickReply,
    QuickReplyButton,
    MessageAction,
)

# ===== FastAPI =====
app = FastAPI()

@app.get("/health")
def health():
    return {"status": "ok"}

# ===== LINE è¨­å®š =====
CHANNEL_ACCESS_TOKEN = os.environ.get("LINE_CHANNEL_ACCESS_TOKEN", "")
CHANNEL_SECRET = os.environ.get("LINE_CHANNEL_SECRET", "")
if not CHANNEL_ACCESS_TOKEN or not CHANNEL_SECRET:
    print("âš ï¸  ç’°å¢ƒå¤‰æ•° LINE_CHANNEL_ACCESS_TOKEN / LINE_CHANNEL_SECRET ãŒæœªè¨­å®šã§ã™ã€‚")

line_bot_api = LineBotApi(CHANNEL_ACCESS_TOKEN)
parser = WebhookParser(CHANNEL_SECRET)

# ===== ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ—ãƒ©ã‚¤ï¼ˆã‚³ãƒãƒ³ãƒ‰ã®ã¿ã€‚ã€æ¬¡ã®å•é¡Œã€ã€æˆç¸¾ç¢ºèªã€ã¯å…¥ã‚Œãªã„ï¼‰ =====
def command_quick_reply() -> QuickReply:
    return QuickReply(items=[
        QuickReplyButton(action=MessageAction(label="ãƒªã‚»ãƒƒãƒˆ", text="ãƒªã‚»ãƒƒãƒˆ")),
        QuickReplyButton(action=MessageAction(label="ãƒ˜ãƒ«ãƒ—", text="ãƒ˜ãƒ«ãƒ—")),
        QuickReplyButton(action=MessageAction(label="ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹", text="ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹")),
    ])

# ====== ä¹™4 éå»å•é¢¨ 50å• ======
# å½¢å¼: {"q": "å•é¡Œæ–‡", "choices": ["A","B","C","D"], "ans": 1..4, "exp": "è§£èª¬"}
QUIZ: List[Dict] = [
    # 1ã€œ10
    {"q": "ä¿å®‰è·é›¢ã®ç›®çš„ã¨ã—ã¦æ­£ã—ã„ã®ã¯ã©ã‚Œã‹ï¼Ÿ", "choices": ["é¨’éŸ³ä½æ¸›", "å»¶ç„¼é˜²æ­¢", "æ™¯è¦³ä¿è­·", "æ›æ°—ä¿ƒé€²"], "ans": 2, "exp": "ä¿å®‰è·é›¢ã¯ä¸»ã«å»¶ç„¼ã‚„è¢«å®³æ‹¡å¤§ã®é˜²æ­¢ã‚’ç›®çš„ã¨ã™ã‚‹ã€‚"},
    {"q": "æŒ‡å®šæ•°é‡ã®èª¬æ˜ã¨ã—ã¦æ­£ã—ã„ã®ã¯ã©ã‚Œã‹ï¼Ÿ", "choices": ["è²¯è”µæ‰€ã®é«˜ã•", "å–ã‚Šæ‰±ã„äººæ•°", "è¨±å¯ä¸è¦ã®ä¸Šé™æ•°é‡", "é›»åœ§ã®ä¸Šé™"], "ans": 3, "exp": "æŒ‡å®šæ•°é‡ã¯è¨±å¯ä¸è¦ã®ä¸Šé™ã®ç›®å®‰ï¼ˆè¶…ãˆã‚‹ã¨è¨±å¯ãƒ»æ§‹é€ åŸºæº–ãŒå¿…è¦ï¼‰ã€‚"},
    {"q": "ç¬¬4é¡å±é™ºç‰©ã®å…±é€šæ€§è³ªã¯ã©ã‚Œã‹ï¼Ÿ", "choices": ["å¯ç‡ƒæ€§å›ºä½“", "è‡ªç„¶ç™ºç«æ€§", "æ°´æº¶æ€§ãŒé«˜ã„", "å¼•ç«æ€§æ¶²ä½“"], "ans": 4, "exp": "ç¬¬4é¡ã¯å¼•ç«æ€§æ¶²ä½“ã€‚"},
    {"q": "å¼•ç«ç‚¹ãŒæœ€ã‚‚ä½ã„ã®ã¯ã©ã‚Œã‹ï¼Ÿ", "choices": ["ã‚¬ã‚½ãƒªãƒ³", "è»½æ²¹", "ç¯æ²¹", "é‡æ²¹"], "ans": 1, "exp": "ã‚¬ã‚½ãƒªãƒ³ã¯âˆ’40â„ƒç¨‹åº¦ã§éå¸¸ã«ä½ã„ã€‚"},
    {"q": "ç¯æ²¹ï¼ˆç¬¬4é¡ç¬¬2çŸ³æ²¹é¡ï¼‰ã®æŒ‡å®šæ•°é‡ã¯ï¼Ÿ", "choices": ["100L", "200L", "1000L", "2000L"], "ans": 3, "exp": "ç¬¬2çŸ³æ²¹é¡ï¼ˆéæ°´æº¶æ€§ï¼‰ã®æŒ‡å®šæ•°é‡ã¯1000Lã€‚"},
    {"q": "è»½æ²¹ã®é¡åˆ¥ã¯ã©ã‚Œã‹ï¼Ÿ", "choices": ["ç¬¬1çŸ³æ²¹é¡", "ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é¡", "ç¬¬2çŸ³æ²¹é¡", "ç¬¬3çŸ³æ²¹é¡"], "ans": 3, "exp": "è»½æ²¹ã¯ç¬¬2çŸ³æ²¹é¡ï¼ˆå¼•ç«ç‚¹30â„ƒä»¥ä¸Š60â„ƒæœªæº€ï¼‰ã€‚"},
    {"q": "ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é¡ã®ç‰¹å¾´ã§èª¤ã£ã¦ã„ã‚‹ã‚‚ã®ã¯ï¼Ÿ", "choices": ["æ°´ã«æº¶ã‘ã‚‹", "è’¸æ°—ã¯ç©ºæ°—ã‚ˆã‚Šé‡ã„", "æ°´ã§æ¶ˆç«ãŒæœ‰åŠ¹ãªå ´åˆãŒã‚ã‚‹", "æ°´ã¨æ··ã–ã‚‰ãªã„"], "ans": 4, "exp": "å¤šãã®ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ã¯æ°´ã¨ä»»æ„å‰²åˆã§æ··å’Œã™ã‚‹ã€‚"},
    {"q": "è’¸æ°—å¯†åº¦ãŒç©ºæ°—ã‚ˆã‚Šé‡ã„è’¸æ°—ãŒæ»ç•™ã—ã‚„ã™ã„ã®ã¯ï¼Ÿ", "choices": ["å¤©äº•ä»˜è¿‘", "åºŠé¢ä»˜è¿‘", "å±‹å¤–é«˜æ‰€", "æ›æ°—ãƒ€ã‚¯ãƒˆå†…"], "ans": 2, "exp": "é‡ã„è’¸æ°—ã¯ä½æ‰€ãƒ»ãƒ”ãƒƒãƒˆã«æ»ç•™ã—ã‚„ã™ã„ã€‚"},
    {"q": "å±é™ºç‰©æ–½è¨­ã§é™é›»æ°—å¯¾ç­–ã¨ã—ã¦é©åˆ‡ãªã®ã¯ï¼Ÿ", "choices": ["çµ¦æ²¹ä¸­ã®æºå¸¯ä½¿ç”¨æ¨å¥¨", "æ¥åœ°ãƒ»ãƒœãƒ³ãƒ‡ã‚£ãƒ³ã‚°", "ä¹¾ç‡¥ä¿ƒé€²", "åˆæˆç¹Šç¶­è¡£æœå¿…é ˆ"], "ans": 2, "exp": "å°é›»åŒ–ã¨æ¥åœ°ï¼ˆãƒœãƒ³ãƒ‡ã‚£ãƒ³ã‚°ï¼‰ãŒåŸºæœ¬å¯¾ç­–ã€‚"},
    {"q": "é‡æ²¹ã®é¡åˆ¥ã¯ï¼Ÿ", "choices": ["ç¬¬1çŸ³æ²¹é¡", "ç¬¬2çŸ³æ²¹é¡", "ç¬¬3çŸ³æ²¹é¡", "ç¬¬4çŸ³æ²¹é¡"], "ans": 3, "exp": "é‡æ²¹ã¯ç¬¬3çŸ³æ²¹é¡ï¼ˆå¼•ç«ç‚¹60â„ƒä»¥ä¸Š90â„ƒæœªæº€ï¼‰ã€‚"},

    # 11ã€œ20
    {"q": "ã‚¬ã‚½ãƒªãƒ³ã®æŒ‡å®šæ•°é‡ã¯ï¼Ÿ", "choices": ["50L", "100L", "200L", "400L"], "ans": 4, "exp": "ç¬¬1çŸ³æ²¹é¡ï¼ˆéæ°´æº¶æ€§ï¼‰ã®æŒ‡å®šæ•°é‡ã¯200Lã€ãŸã ã—ã‚¬ã‚½ãƒªãƒ³ã¯400Lï¼ˆç‰¹ä¾‹ï¼‰ã§ã¯ãªãä¸€èˆ¬ã¯200Lã€‚â€»æœ¬è©¦é¨“ã§ã¯ã€ç¬¬1çŸ³æ²¹é¡ï¼ˆéæ°´æº¶æ€§ï¼‰=200Lã€ã§è¦šãˆã‚‹ã€‚"},  # èªè­˜åˆã‚ã›ã®ãŸã‚è§£èª¬ã«æ³¨è¨˜
    {"q": "ã€å±é™ºç­‰ç´šâ… ã€ã«è©²å½“ã™ã‚‹ã®ã¯ï¼Ÿ", "choices": ["é‡æ²¹", "ã‚¬ã‚½ãƒªãƒ³", "ç¯æ²¹", "è»½æ²¹"], "ans": 2, "exp": "ã‚¬ã‚½ãƒªãƒ³ç­‰ã®ç¬¬1çŸ³æ²¹é¡ã¯å±é™ºç­‰ç´šâ… ã€‚"},
    {"q": "æŒ‡å®šæ•°é‡ã®å€æ•°ãŒ10å€è¶…ã®è²¯è”µæ‰€ã§å¿…è¦ãªæ¨™è­˜ã¯ï¼Ÿ", "choices": ["ç«æ°—å³ç¦", "é–¢ä¿‚è€…ä»¥å¤–ç«‹å…¥ç¦æ­¢", "å±é™ºç‰©è²¯è”µæ‰€", "å°‘é‡å±é™ºç‰©"], "ans": 3, "exp": "è²¯è”µæ‰€ãƒ»å–æ‰±æ‰€ã«ã¯ã€å±é™ºç‰©ã€‡ã€‡æ‰€ã€æ¨™è­˜ãŒå¿…è¦ã€‚"},
    {"q": "å±é™ºç‰©æ–½è¨­ã®æ¶ˆç«è¨­å‚™ã¨ã—ã¦ä¸é©åˆ‡ãªã®ã¯ï¼Ÿ", "choices": ["æ³¡æ¶ˆç«è¨­å‚™", "ç²‰æœ«æ¶ˆç«è¨­å‚™", "äºŒé…¸åŒ–ç‚­ç´ æ¶ˆç«è¨­å‚™", "æ°´å™´éœ§ï¼ˆæ²¹é¢ç›´æ¥ï¼‰"], "ans": 4, "exp": "æ°´ã‚’ç›´æ¥æ²¹é¢ã«å½“ã¦ã‚‹ã¨æ‹¡æ•£ã™ã‚‹æã‚Œã€‚æ³¡ç­‰ãŒé©åˆ‡ã€‚"},
    {"q": "é™é›»æ°—ã«ã‚ˆã‚‹ç€ç«é˜²æ­¢ã§é©åˆ‡ãªã®ã¯ï¼Ÿ", "choices": ["æ¹¿åº¦ã‚’ä¸‹ã’ã‚‹", "æ¥åœ°æŠµæŠ—ã‚’ä¸Šã’ã‚‹", "é‡‘å±åŒå£«ã¯çµ¶ç¸", "æµé€Ÿã‚’æŠ‘ãˆã‚‹"], "ans": 4, "exp": "æµé€Ÿã‚’æŠ‘ãˆã€ç™ºç”Ÿã‚’ä½æ¸›ã™ã‚‹ã€‚"},
    {"q": "çµ¦æ²¹å–æ‰±æ‰€ã§ç¦æ­¢ã•ã‚Œã¦ã„ã‚‹è¡Œç‚ºã¯ã©ã‚Œã‹ï¼Ÿ", "choices": ["ã‚¨ãƒ³ã‚¸ãƒ³åœæ­¢", "çª“é–‹æ”¾", "æºè¡Œç¼¶çµ¦æ²¹", "å—å‹•å–«ç…™"], "ans": 4, "exp": "ç«æ°—å³ç¦ã€‚å—å‹•å–«ç…™ã‚‚ç«æºã«ãªã‚Šå¾—ã‚‹ã€‚"},
    {"q": "å¼•ç«ç‚¹ã®å®šç¾©ã¨ã—ã¦æ­£ã—ã„ã®ã¯ï¼Ÿ", "choices": ["è‡ªç„¶ã«ç™ºç«ã™ã‚‹æ¸©åº¦", "ç«ã‚’è¿‘ã¥ã‘ã‚‹ã¨ç‡ƒãˆã‚‹æœ€ä½æ¸©åº¦", "ç‡ƒç„¼ãŒç¶™ç¶šã™ã‚‹æ¸©åº¦", "è’¸æ°—ãŒæœ€ã‚‚ç™ºç”Ÿã™ã‚‹æ¸©åº¦"], "ans": 2, "exp": "ç«æºã‚’ä¸ãˆã‚‹ã¨ç‡ƒãˆã‚‹æœ€ä½æ¸©åº¦ãŒå¼•ç«ç‚¹ã€‚"},
    {"q": "è»½æ²¹ã®å¼•ç«ç‚¹ã¯æ¦‚ã­ï¼Ÿ", "choices": ["âˆ’40â„ƒ", "0ã€œ20â„ƒ", "30ã€œ60â„ƒ", "90â„ƒä»¥ä¸Š"], "ans": 3, "exp": "è»½æ²¹ã¯30ã€œ60â„ƒã€‚"},
    {"q": "é‡æ²¹ã®æŒ‡å®šæ•°é‡ã¯ï¼Ÿ", "choices": ["1000L", "2000L", "4000L", "6000L"], "ans": 4, "exp": "ç¬¬3çŸ³æ²¹é¡ï¼ˆéæ°´æº¶æ€§ï¼‰ã®æŒ‡å®šæ•°é‡ã¯6000Lã€‚"},
    {"q": "ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é¡ï¼ˆã‚¨ã‚¿ãƒãƒ¼ãƒ«ç­‰ï¼‰ã®æŒ‡å®šæ•°é‡ã¯ï¼Ÿ", "choices": ["100L", "200L", "400L", "1000L"], "ans": 4, "exp": "ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é¡ã®æŒ‡å®šæ•°é‡ã¯1000Lã€‚"},
    # 21ã€œ30
    {"q": "æ°´æº¶æ€§ç¬¬1çŸ³æ²¹é¡ã®ä»£è¡¨ä¾‹ã¯ï¼Ÿ", "choices": ["ãƒ™ãƒ³ã‚¼ãƒ³", "ã‚¢ã‚»ãƒˆãƒ³", "ãƒˆãƒ«ã‚¨ãƒ³", "ã‚­ã‚·ãƒ¬ãƒ³"], "ans": 2, "exp": "ã‚¢ã‚»ãƒˆãƒ³ã¯ã‚±ãƒˆãƒ³ã§æ°´ã«æ··å’Œã—ã€ç¬¬1çŸ³æ²¹é¡ï¼ˆæ°´æº¶æ€§ï¼‰ã€‚"},
    {"q": "å±é™ºç‰©æ–½è¨­ã§ã®ã€ä¿å®‰è·é›¢ã€ã®ç›¸æ‰‹ã¨ã—ã¦èª¤ã‚Šã¯ï¼Ÿ", "choices": ["å­¦æ ¡", "ç—…é™¢", "ä½å®…", "ãƒ•ã‚§ãƒ³ã‚¹"], "ans": 4, "exp": "ä¿å®‰è·é›¢ã¯äººå®¶ãƒ»å…¬å…±å»ºç¯‰ç‰©ç­‰ã¨ã®è·é›¢ã§ã€ãƒ•ã‚§ãƒ³ã‚¹ã¯è©²å½“ã—ãªã„ã€‚"},
    {"q": "æŒ‡å®šæ•°é‡æœªæº€ã§ã‚ã£ã¦ã‚‚å®ˆã‚‹ã¹ãäº‹é …ã¯ï¼Ÿ", "choices": ["æ§‹é€ è¨­å‚™åŸºæº–", "ç´°å‰‡ã«ã‚ˆã‚‹è²¯è”µåŸºæº–", "å±‹å¤–ã®ã¿å¯", "è³‡æ ¼è€…ã®å¸¸é§"], "ans": 2, "exp": "æ¡ä¾‹ç´°å‰‡ã«ã‚ˆã‚Šè²¯è”µãƒ»å–æ‰±åŸºæº–ãŒå®šã‚ã‚‰ã‚Œã¦ã„ã‚‹ã€‚"},
    {"q": "è’¸æ°—åœ§ãŒé«˜ã„ã»ã©ä¸€èˆ¬ã«ã©ã†ãªã‚‹ï¼Ÿ", "choices": ["å¼•ç«ç‚¹ã¯ä¸ŠãŒã‚‹", "è’¸æ°—ãŒç™ºç”Ÿã—ã«ãã„", "å±é™ºæ€§ã¯ä¸ŠãŒã‚‹", "æ²¸ç‚¹ã¯ä¸ŠãŒã‚‹"], "ans": 3, "exp": "è’¸æ°—ãŒå‡ºã‚„ã™ãå¯ç‡ƒç¯„å›²ã«å…¥ã‚Šã‚„ã™ã„ã€‚"},
    {"q": "å±é™ºç‰©æ–½è¨­ã®æ¼ãˆã„å¯¾ç­–ã§é©åˆ‡ãªã®ã¯ï¼Ÿ", "choices": ["ãƒ‰ãƒ¬ãƒ³ã®ç›´çµ", "é˜²æ²¹å ¤ã®è¨­ç½®", "æ’æ°´å£ã®æ‹¡å¤§", "åºŠé¢ã‚’å‚¾ã‘ã‚‹"], "ans": 2, "exp": "é˜²æ²¹å ¤ã§å¤–éƒ¨æµå‡ºã‚’é˜²æ­¢ã€‚"},
    {"q": "ç¬¬2çŸ³æ²¹é¡ï¼ˆæ°´æº¶æ€§ï¼‰ã®æŒ‡å®šæ•°é‡ã¯ï¼Ÿ", "choices": ["500L", "1000L", "2000L", "4000L"], "ans": 2, "exp": "ç¬¬2çŸ³æ²¹é¡ï¼ˆæ°´æº¶æ€§ï¼‰ã¯1000Lã€‚"},
    {"q": "å±é™ºç‰©ã®é‹æ¬ã§èª¤ã£ã¦ã„ã‚‹ã®ã¯ï¼Ÿ", "choices": ["è»¢å€’é˜²æ­¢", "æ›æ°—ç¢ºä¿", "å¯†é–‰ç©ºé–“ã§ã®è¼¸é€", "ç©ä»˜ã‘å›ºå®š"], "ans": 3, "exp": "å¯†é–‰ç©ºé–“ã§ã®è’¸æ°—æ»ç•™ã¯å±é™ºã€‚"},
    {"q": "ã‚¿ãƒ³ã‚¯ãƒ­ãƒ¼ãƒªãƒ¼è·å¸ã—æ™‚ã«å¿…è¦ãªã®ã¯ï¼Ÿ", "choices": ["æºå¸¯é›»è©±ã§é€£çµ¡", "ã‚¢ãƒ¼ã‚¹æ¥ç¶š", "çª“ã‚’é–‰ã‚ã‚‹", "æ­©è¡Œè€…èª˜å°ã¯ä¸è¦"], "ans": 2, "exp": "é™é›»æ°—å¯¾ç­–ã§æ¥åœ°å¿…é ˆã€‚"},
    {"q": "å±é™ºç‰©æ–½è¨­ã®æ¨™è­˜ã®è‰²ã§ã€ç«æ°—å³ç¦ã€ã«ä¸€èˆ¬çš„ãªè‰²ã¯ï¼Ÿ", "choices": ["é’åœ°ç™½å­—", "ç·‘åœ°ç™½å­—", "é»„åœ°é»’å­—", "èµ¤åœ°ç™½å­—"], "ans": 4, "exp": "èµ¤åœ°ç™½å­—ãŒæ³¨æ„å–šèµ·ã¨ã—ã¦ä¸€èˆ¬çš„ã€‚"},
    {"q": "ç¬¬4é¡ã®å…±é€šæ¶ˆç«æ–¹æ³•ã§é©åˆ‡ãªã®ã¯ï¼Ÿ", "choices": ["æ³¡æ¶ˆç«å‰¤", "çª’ç´ å›ºå®šå‰¤", "ç ‚åˆ©ã®æ•£å¸ƒ", "é«˜åœ§æ°´ç›´å™´"], "ans": 1, "exp": "æ²¹é¢ã‚’è¦†ã†æ³¡ãŒæœ‰åŠ¹ã€‚ç›´å™´æ°´ã¯æ‹¡æ•£ã®æã‚Œã€‚"},
    # 31ã€œ40
    {"q": "ã‚­ã‚·ãƒ¬ãƒ³ã®é¡åˆ¥ã¯ï¼Ÿ", "choices": ["ç¬¬1çŸ³æ²¹é¡", "ç¬¬2çŸ³æ²¹é¡", "ç¬¬3çŸ³æ²¹é¡", "ç¬¬4çŸ³æ²¹é¡"], "ans": 2, "exp": "ã‚­ã‚·ãƒ¬ãƒ³ã¯ç¬¬2çŸ³æ²¹é¡ã€‚"},
    {"q": "ãƒ™ãƒ³ã‚¼ãƒ³ã®é¡åˆ¥ã¯ï¼Ÿ", "choices": ["ç¬¬1çŸ³æ²¹é¡", "ç¬¬2çŸ³æ²¹é¡", "ç¬¬3çŸ³æ²¹é¡", "ç¬¬4çŸ³æ²¹é¡"], "ans": 1, "exp": "ãƒ™ãƒ³ã‚¼ãƒ³ã¯ç¬¬1çŸ³æ²¹é¡ã€‚"},
    {"q": "ãƒ¡ã‚¿ãƒãƒ¼ãƒ«ã®é¡åˆ¥ã¯ï¼Ÿ", "choices": ["ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é¡", "ç¬¬1çŸ³æ²¹é¡", "ç¬¬2çŸ³æ²¹é¡", "ç¬¬3çŸ³æ²¹é¡"], "ans": 1, "exp": "ãƒ¡ã‚¿ãƒãƒ¼ãƒ«ã¯ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é¡ã§æ°´ã«æ··å’Œã€‚"},
    {"q": "ã€å±é™ºç­‰ç´šâ…¢ã€ã«å«ã¾ã‚Œã‚‹ã®ã¯ï¼Ÿ", "choices": ["ã‚¬ã‚½ãƒªãƒ³", "è»½æ²¹", "é‡æ²¹", "ãƒ™ãƒ³ã‚¼ãƒ³"], "ans": 3, "exp": "ç¬¬3çŸ³æ²¹é¡ç­‰ã¯å±é™ºç­‰ç´šâ…¢ã€‚"},
    {"q": "çµ¦æ²¹å–æ‰±æ‰€ã§ã®æºè¡Œç¼¶ã®æ­£ã—ã„æ‰±ã„ã¯ï¼Ÿ", "choices": ["ãƒ—ãƒ©è£½ãŒå¥½ã¾ã—ã„", "é‡‘å±è£½ã§é©åˆå“ã‚’ä½¿ç”¨", "è“‹ã¯ç·©ã‚ã‚‹", "æ³¨å…¥å£ã¯å¤§ãã„æ–¹ãŒè‰¯ã„"], "ans": 2, "exp": "é‡‘å±è£½ã§èªè¨¼ã•ã‚ŒãŸæºè¡Œç¼¶ã‚’ä½¿ç”¨ã€‚"},
    {"q": "æ²¹åˆ†ã‚’å¤šé‡ã«å«ã‚€ã‚¦ã‚¨ã‚¹ã®å±é™ºã¯ï¼Ÿ", "choices": ["è‡ªç„¶ç™ºç«ã®æã‚Œ", "é…¸åŒ–ã«ã‚ˆã‚Šå†·å´", "ä¸ç‡ƒåŒ–", "é™é›»æ°—æ¸›å°‘"], "ans": 1, "exp": "é…¸åŒ–ç†±è“„ç©ã§è‡ªç„¶ç™ºç«ã®æã‚ŒãŒã‚ã‚‹ã€‚"},
    {"q": "æŒ‡å®šæ•°é‡ã®å€æ•°ãŒå¤šã„ã»ã©è¦æ±‚ãŒå³ã—ããªã‚‹ã®ã¯ï¼Ÿ", "choices": ["é›»æ°—è¨­å‚™è¦æ ¼", "æ§‹é€ ãƒ»è¨­å‚™åŸºæº–", "æ¶ˆé˜²è¨ˆç”»ã®æå‡ºä¸è¦", "æ¨™è­˜ä¸è¦"], "ans": 2, "exp": "å€æ•°å¢—åŠ ã§æ§‹é€ ãƒ»è¨­å‚™ãƒ»æ¶ˆç«è¨­å‚™ãªã©ã®è¦æ±‚ãŒå¢—ã™ã€‚"},
    {"q": "è²¯è”µã‚¿ãƒ³ã‚¯ã®ä¸Šéƒ¨ã«è¨­ã‘ã‚‹å®‰å…¨è£…ç½®ã¯ï¼Ÿ", "choices": ["æµé‡è¨ˆ", "å®‰å…¨å¼ãƒ»å‘¼å¸å¼", "ã‚éå™¨", "æ•´æµå™¨"], "ans": 2, "exp": "å‘¼å¸å¼ç­‰ã§å†…åœ§ã‚’èª¿æ•´ã—æå‚·ã‚’é˜²æ­¢ã€‚"},
    {"q": "å¯ç‡ƒç¯„å›²ã«å½±éŸ¿ã™ã‚‹è¦ç´ ã¯ï¼Ÿ", "choices": ["è’¸æ°—åœ§ãƒ»æ¸©åº¦", "è‰²", "æ¯”é‡ã®ã¿", "é›»æ°—ä¼å°ç‡"], "ans": 1, "exp": "æ¸©åº¦ä¸Šæ˜‡ãƒ»è’¸æ°—åœ§ä¸Šæ˜‡ã§å¯ç‡ƒç¯„å›²ã«å…¥ã‚Šã‚„ã™ã„ã€‚"},
    {"q": "æ°´æº¶æ€§æ¶²ä½“ã®æµå‡ºæ™‚ã«æœ‰åŠ¹ãªæ¶ˆç«ã¯ï¼Ÿ", "choices": ["æ™®é€šæ³¡ï¼ˆè›‹ç™½ï¼‰", "è€ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ³¡", "éœ§çŠ¶æ°´ç›´å™´", "ç²‰æœ«å™´éœ§ã®ã¿"], "ans": 2, "exp": "æ°´æº¶æ€§ã«ã¯è€ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ³¡ãŒæœ‰åŠ¹ã€‚"},
    # 41ã€œ50
    {"q": "ã‚¬ã‚¹æ¢çŸ¥ã§ç¬¬4é¡è’¸æ°—ã®æ¤œçŸ¥æ–¹å¼ã«ç”¨ã„ã‚‰ã‚Œã‚‹ã®ã¯ï¼Ÿ", "choices": ["å¯ç‡ƒæ€§ã‚¬ã‚¹ã‚»ãƒ³ã‚µ", "ç´«å¤–ç·šæ¿ƒåº¦è¨ˆ", "é…¸ç´ é€éåº¦è¨ˆ", "é¨’éŸ³è¨ˆ"], "ans": 1, "exp": "å¯ç‡ƒæ€§ã‚¬ã‚¹ã‚»ãƒ³ã‚µï¼ˆæ¥è§¦ç‡ƒç„¼å¼ç­‰ï¼‰ã‚’ç”¨ã„ã‚‹ã€‚"},
    {"q": "ãƒãƒ³ãƒ—å¸è¾¼å´ã§èµ·ãã‚„ã™ã„ç¾è±¡ã¯ï¼Ÿ", "choices": ["ç©ºæ°—ä¾µå…¥ã«ã‚ˆã‚‹ã‚­ãƒ£ãƒ“ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³", "åœ§åŠ›ä¸Šæ˜‡", "æ¸©åº¦ä¸Šæ˜‡ã«ã‚ˆã‚‹æ²¸é¨°æŠ‘åˆ¶", "ç²˜åº¦ä½ä¸‹ã§åœ§æå¢—åŠ "], "ans": 1, "exp": "ç©ºæ°—æ··å…¥ã§ã‚­ãƒ£ãƒ“ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»é€æ¶²ä¸è‰¯ãŒèµ·ãã‚„ã™ã„ã€‚"},
    {"q": "å®¹å™¨ã®è¡¨ç¤ºã§å¿…é ˆã§ãªã„ã‚‚ã®ã¯ï¼Ÿ", "choices": ["å“å", "æ•°é‡", "å¼•ç«ç‚¹", "æ³¨æ„äº‹é …"], "ans": 3, "exp": "å®¹å™¨è¡¨ç¤ºã¯å“åãƒ»æ•°é‡ãƒ»æ³¨æ„äº‹é …ç­‰ã€‚å¼•ç«ç‚¹ã¯å¿…é ˆã§ã¯ãªã„ã€‚"},
    {"q": "æŒ‡å®šæ•°é‡æœªæº€ã®å°‘é‡å±é™ºç‰©ã§èª¤ã‚Šã¯ï¼Ÿ", "choices": ["æ¡ä¾‹ã®è¦åˆ¶å¯¾è±¡", "å±‹å†…å¤–ã®åŸºæº–ã‚ã‚Š", "è³‡æ ¼è€…é¸ä»»ãŒä¸è¦ã®å ´åˆã‚ã‚Š", "æ¶ˆé˜²æ³•ã®å¯¾è±¡å¤–ã®ãŸã‚ç„¡åˆ¶é™"], "ans": 4, "exp": "ç„¡åˆ¶é™ã§ã¯ãªã„ã€‚æ¡ä¾‹ã§æ•°é‡ä¸Šé™ãƒ»åŸºæº–ãŒã‚ã‚‹ã€‚"},
    {"q": "ä¿å®‰ç”¨å…·ã§å°é›»æ€§ã«ã™ã‚‹ç›®çš„ã¯ï¼Ÿ", "choices": ["è…é£Ÿé˜²æ­¢", "é™é›»æ°—å¯¾ç­–", "æ–­ç†±", "è»½é‡åŒ–"], "ans": 2, "exp": "é™é›»æ°—å¸¯é›»ã‚’é˜²ãã€ç€ç«æºã®ä½æ¸›ã€‚"},
    {"q": "ç­‹äº¤ã„ãƒ»ä»•åˆ‡ã‚Šã§æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœã¯ï¼Ÿ", "choices": ["è’¸ç™ºä¿ƒé€²", "å»¶ç„¼ãƒ»æ‹¡æ•£æŠ‘åˆ¶", "å¼•ç«ç‚¹ä¸Šæ˜‡", "ç™ºç«ç‚¹ä½ä¸‹"], "ans": 2, "exp": "å»¶ç„¼ãƒ»æ‹¡æ•£ã‚’æŠ‘ãˆã‚‹æ§‹é€ çš„å¯¾ç­–ã€‚"},
    {"q": "ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€ã§è¡¨ç¤ºã™ã¹ãå†…å®¹ã¨ã—ã¦å¦¥å½“ãªã®ã¯ï¼Ÿ", "choices": ["æ®‹ã‚Šæ™‚é–“", "ç¾åœ¨ã®é€²æ—ã¨æ­£ç­”æ•°", "ç‡ƒè²»", "åœ§åŠ›"], "ans": 2, "exp": "å­¦ç¿’é€²æ—ï¼ˆä½•å•ç›®/æ­£ç­”æ•°/æ­£ç­”ç‡ãªã©ï¼‰ã€‚"},
    {"q": "10å•ã”ã¨ã®æˆç¸¾é€šçŸ¥ã®åˆ©ç‚¹ã¯ï¼Ÿ", "choices": ["è² è·å¢—å¤§", "å­¦ç¿’ã®åŒºåˆ‡ã‚Šãƒ»ãƒ¢ãƒãƒ™ç¶­æŒ", "å•é¡Œæ¸›å°‘", "æ¡ç‚¹ä¸è¦"], "ans": 2, "exp": "åŒºåˆ‡ã‚Šã‚’ä½œã‚Šå­¦ç¿’åŠ¹æœã‚’é«˜ã‚ã‚‹ã€‚"},
    {"q": "å±é™ºç‰©ã®æ¸©åº¦ç®¡ç†ã¨ã—ã¦ä¸é©åˆ‡ãªã®ã¯ï¼Ÿ", "choices": ["ç›´å°„æ—¥å…‰ã‚’é¿ã‘ã‚‹", "é€šé¢¨ã®è‰¯ã„å ´æ‰€", "ç†±æºã®è¿‘ãã«ç½®ã", "é«˜æ¸©æ™‚ã¯é®å…‰"], "ans": 3, "exp": "ç†±æºè¿‘ãã¯è’¸æ°—ç™ºç”Ÿã‚„åœ§åŠ›ä¸Šæ˜‡ã‚’æ‹›ãã€‚"},
    {"q": "è©¦é¨“å‰ã®å®‰å…¨å¯¾ç­–ã¨ã—ã¦å„ªå…ˆåº¦ãŒé«˜ã„ã®ã¯ï¼Ÿ", "choices": ["æ¨™è­˜è¨­ç½®ãƒ»é¿é›£çµŒè·¯ç¢ºèª", "é…è‰²å¤‰æ›´", "è£…é£¾è¿½åŠ ", "BGMå°å…¥"], "ans": 1, "exp": "æ¨™è­˜ãƒ»é¿é›£çµŒè·¯ãªã©å®‰å…¨ç¢ºä¿ãŒæœ€å„ªå…ˆã€‚"},
]

TOTAL = len(QUIZ)  # 50

# ===== ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ï¼ˆç°¡æ˜“ãƒ»ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªï¼‰ =====
class Session(BaseModel):
    order: List[int]          # å‡ºé¡Œé †ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹é…åˆ—ï¼‰
    idx: int                  # ä½•å•ç›®ã‹ï¼ˆ0å§‹ã¾ã‚Šï¼‰
    correct: int              # æ­£è§£æ•°
    answered: int             # å›ç­”æ¸ˆã¿æ•°
    chunk_scores: Dict[int, int]  # å„10å•ãƒ–ãƒ­ãƒƒã‚¯ã®æ­£è§£æ•° {1:â—¯,2:â—¯,...}
    last_feedback: Optional[str] = None  # ç›´è¿‘ã®æ­£èª¤è¡¨ç¤º

# userId -> Session
SESSIONS: Dict[str, Session] = {}

# ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
def normalize_answer(text: str) -> Optional[int]:
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®1ã€œ4å›ç­”ã‚’æ­£è¦åŒ–ã—ã¦è¿”ã™ã€‚è©²å½“ã—ãªã‘ã‚Œã° None"""
    t = text.strip()
    # å…¨è§’æ•°å­—ã‚„ä¸¸æ•°å­—ã«ã‚‚å¯¾å¿œ
    table = {
        "1": 1, "ï¼‘": 1, "â‘ ": 1,
        "2": 2, "ï¼’": 2, "â‘¡": 2,
        "3": 3, "ï¼“": 3, "â‘¢": 3,
        "4": 4, "ï¼”": 4, "â‘£": 4,
    }
    return table.get(t)

def format_question(qidx: int, nth: int) -> str:
    q = QUIZ[qidx]
    lines = [f"Q{nth}/{TOTAL}: {q['q']}"]
    for i, ch in enumerate(q["choices"], start=1):
        lines.append(f"{i}. {ch}")
    return "\n".join(lines)

def chunk_number(answered: int) -> int:
    """ä½•ãƒ–ãƒ­ãƒƒã‚¯ç›®ï¼ˆ10å•å˜ä½ï¼‰ã‹ 1..5 ã‚’è¿”ã™"""
    return (answered - 1) // 10 + 1

def send_text(user_id: str, text: str, with_cmd_qr: bool = True):
    line_bot_api.push_message(
        user_id,
        TextSendMessage(text=text, quick_reply=command_quick_reply() if with_cmd_qr else None)
    )

# ===== Webhook å—ä¿¡ =====
@app.post("/callback")
async def callback(request: Request):
    signature = request.headers.get("X-Line-Signature", "")
    body = await request.body()
    try:
        events = parser.parse(body.decode("utf-8"), signature)
    except InvalidSignatureError:
        raise HTTPException(status_code=400, detail="Bad signature")

    for ev in events:
        if isinstance(ev, MessageEvent) and isinstance(ev.message, TextMessage):
            await handle_text_message(ev)

    return PlainTextResponse("OK")

# ===== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç† =====
async def handle_text_message(event: MessageEvent):
    user_id = event.source.user_id
    text = event.message.text.strip()

    # ã‚³ãƒãƒ³ãƒ‰ï¼ˆã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠã‚‚è¨±å®¹ï¼‰
    if text in ["ãƒ˜ãƒ«ãƒ—", "help", "ä½¿ã„æ–¹"]:
        help_msg = (
            "ğŸ§ª ä¹™4ã‚¯ã‚¤ã‚ºãƒœãƒƒãƒˆ ä½¿ã„æ–¹\n"
            "ãƒ»ã€Œã‚¯ã‚¤ã‚ºã€ã¾ãŸã¯ã€Œé–‹å§‹ã€ã§ã‚¹ã‚¿ãƒ¼ãƒˆ\n"
            "ãƒ»ç­”ãˆã¯ 1 / 2 / 3 / 4 ã§é€ä¿¡ï¼ˆå…¨è§’ãƒ»ä¸¸æ•°å­—OKï¼‰\n"
            "ãƒ»ã€æ¬¡ã®å•é¡Œã€ã€æˆç¸¾ç¢ºèªã€ã¯ä¸‹ã®ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰\n"
            "ãƒ»ã€Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€ã§é€²æ—ç¢ºèªã€ã€Œãƒªã‚»ãƒƒãƒˆã€ã§æœ€åˆã‹ã‚‰\n"
        )
        send_text(user_id, help_msg);  return

    if text in ["ãƒªã‚»ãƒƒãƒˆ", "reset"]:
        SESSIONS.pop(user_id, None)
        send_text(user_id, "ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€Œã‚¯ã‚¤ã‚ºé–‹å§‹ã€ã¾ãŸã¯ã€Œé–‹å§‹ã€ã§å†é–‹ã§ãã¾ã™ã€‚")
        return

    if text in ["ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹", "status"]:
        s = SESSIONS.get(user_id)
        if not s:
            send_text(user_id, "ã¾ã æœªå›ç­”ã§ã™ã€‚ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€Œã‚¯ã‚¤ã‚ºé–‹å§‹ã€ã§é–‹å§‹ã—ã¦ãã ã•ã„ã€‚");  return
        rate = (s.correct / s.answered * 100.0) if s.answered else 0.0
        msg = f"é€²æ—: {s.answered}/{TOTAL}å•ã€€æ­£è§£ {s.correct}ï¼ˆ{rate:.1f}%ï¼‰"
        send_text(user_id, msg);  return

    if text in ["ã‚¯ã‚¤ã‚º", "é–‹å§‹", "ã‚¹ã‚¿ãƒ¼ãƒˆ", "ã‚¯ã‚¤ã‚ºé–‹å§‹"]:
        order = list(range(TOTAL))
        random.shuffle(order)
        SESSIONS[user_id] = Session(order=order, idx=0, correct=0, answered=0, chunk_scores={})
        qidx = order[0]
        send_text(user_id, "ã‚¹ã‚¿ãƒ¼ãƒˆï¼è§£ç­”ã¯ 1ã€œ4 ã§é€ã£ã¦ã­ã€‚\n\n" + format_question(qidx, 1))
        return

    if text in ["æ¬¡ã®å•é¡Œ", "æ¬¡", "ã¤ã"]:
        # ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰æ¥ã‚‹ã“ã¨ã‚’æƒ³å®šï¼ˆãƒ†ã‚­ã‚¹ãƒˆã§ã‚‚OKï¼‰
        s = SESSIONS.get(user_id)
        if not s:
            send_text(user_id, "ã¾ã é–‹å§‹ã—ã¦ã„ã¾ã›ã‚“ã€‚ã€Œã‚¯ã‚¤ã‚ºé–‹å§‹ã€ã§ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚");  return
        if s.answered >= TOTAL:
            send_text(user_id, "å…¨å•çµ‚äº†ï¼ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€Œæˆç¸¾ç¢ºèªã€ã§çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");  return
        qidx = s.order[s.idx]
        send_text(user_id, format_question(qidx, s.answered + 1))
        return

    if text in ["æˆç¸¾ç¢ºèª", "çµæœ", "ã‚¹ã‚³ã‚¢"]:
        s = SESSIONS.get(user_id)
        if not s:
            send_text(user_id, "ã¾ã é–‹å§‹ã—ã¦ã„ã¾ã›ã‚“ã€‚ã€Œã‚¯ã‚¤ã‚ºé–‹å§‹ã€ã§ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚");  return
        # 10å•ã”ã¨ã®é›†è¨ˆ
        msg_lines = [f"ğŸ“Š æˆç¸¾ç¢ºèª"]
        if s.answered == 0:
            send_text(user_id, "ã¾ã æœªå›ç­”ã§ã™ã€‚");  return
        for block in range(1, 6):
            if block * 10 <= TOTAL:
                got = s.chunk_scores.get(block)
                if got is not None:
                    msg_lines.append(f"ãƒ»{(block-1)*10+1:02d}ã€œ{block*10:02d}å•ï¼š{got}/10")
        rate = (s.correct / s.answered * 100.0) if s.answered else 0.0
        msg_lines.append(f"\nç´¯è¨ˆï¼š{s.answered}/{TOTAL}å• æ­£è§£ï¼ˆ{s.correct}ï¼‰æ­£ç­”ç‡ {rate:.1f}%")
        if s.answered >= TOTAL:
            msg_lines.append("ğŸ‰ å…¨å•çµ‚äº†ï¼ãŠç–²ã‚Œã•ã¾ã§ã—ãŸã€‚")
        send_text(user_id, "\n".join(msg_lines))
        return

    # ===== å›ç­”å‡¦ç†ï¼ˆ1ã€œ4ï¼‰ =====
    ans = normalize_answer(text)
    if ans is not None:
        s = SESSIONS.get(user_id)
        if not s:
            send_text(user_id, "ã¾ãšã¯ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€Œã‚¯ã‚¤ã‚ºé–‹å§‹ã€ã§ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚");  return
        if s.answered >= TOTAL:
            send_text(user_id, "ã‚‚ã†å…¨å•çµ‚äº†ã—ã¦ã„ã¾ã™ã€‚ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€Œæˆç¸¾ç¢ºèªã€ã§çµæœã‚’ã©ã†ãã€‚");  return

        # ç¾åœ¨ã®å•é¡Œã‚’æ¡ç‚¹
        qidx = s.order[s.idx]
        q = QUIZ[qidx]
        correct = (ans == q["ans"])

        s.answered += 1
        if correct:
            s.correct += 1
            feedback = "â­• æ­£è§£ï¼"
        else:
            feedback = f"âŒ ä¸æ­£è§£â€¦ æ­£è§£ã¯ {q['ans']}. {q['choices'][q['ans']-1']}\nï¼ˆè£œè¶³ï¼‰{q['exp']}"
        s.last_feedback = feedback

        # 10å•åŒºåˆ‡ã‚Šã§ãƒ–ãƒ­ãƒƒã‚¯é›†è¨ˆ
        if s.answered % 10 == 0 or s.answered == TOTAL:
            block = chunk_number(s.answered)
            start_i = (block - 1) * 10
            end_i = min(block * 10, TOTAL)
            # é›†è¨ˆã¯å·®åˆ†ã§ã¯ãªãã€ãã®åŒºé–“ã§ã®æ­£ç­”æ•°ã‚’ç®—å‡º
            # ã“ã“ã§ã¯ç°¡ç•¥åŒ–ï¼šåŒºåˆ‡ã‚Šã®ãŸã³ã«ã€Œã“ã“ã¾ã§ã®æ­£è§£æ•° - ç›´å‰ãƒ–ãƒ­ãƒƒã‚¯ã¾ã§ã®åˆè¨ˆã€ã§æ±‚ã‚ã‚‹
            prev_sum = sum(s.chunk_scores.values())
            s.chunk_scores[block] = s.correct - prev_sum

        # æ¬¡ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¸
        s.idx += 1

        # è¿”ç­”
        if s.answered >= TOTAL:
            # æœ€çµ‚çµæœ
            rate = s.correct / TOTAL * 100.0
            end_msg = (
                f"{feedback}\n\n"
                f"ğŸ å…¨å•çµ‚äº†ï¼\n"
                f"æœ€çµ‚æˆç¸¾ï¼š{s.correct}/{TOTAL}ï¼ˆ{rate:.1f}%ï¼‰\n"
                f"ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€Œæˆç¸¾ç¢ºèªã€ã§ãƒ–ãƒ­ãƒƒã‚¯åˆ¥ã®å†…è¨³ã‚‚ç¢ºèªã§ãã¾ã™ã€‚"
            )
            send_text(user_id, end_msg)
        else:
            # 10å•ã”ã¨ã®é€Ÿå ±
            if s.answered % 10 == 0:
                block = chunk_number(s.answered)
                bsc = s.chunk_scores.get(block, 0)
                summary = f"ğŸ“ {((block-1)*10+1):02d}ã€œ{(block*10):02d}å•ã®æˆç¸¾ï¼š{bsc}/10"
                send_text(user_id, f"{feedback}\n\n{summary}\n\næ¬¡ã®å•é¡Œã¯ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã©ã†ãã€‚")
            else:
                send_text(user_id, f"{feedback}\n\næ¬¡ã®å•é¡Œã¯ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€æ¬¡ã®å•é¡Œã€ã‚’ã‚¿ãƒƒãƒ—ã€‚")
        return

    # ãã‚Œä»¥å¤–ã®å…¥åŠ›
    send_text(
        user_id,
        "å…¥åŠ›ã‚’ç†è§£ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\n"
        "ãƒ»ã€Œã‚¯ã‚¤ã‚ºã€ã¾ãŸã¯ã€Œé–‹å§‹ã€ã§ã‚¹ã‚¿ãƒ¼ãƒˆ\n"
        "ãƒ»ç­”ãˆã¯ 1 / 2 / 3 / 4 ã§é€ä¿¡\n"
        "ãƒ»ã€æ¬¡ã®å•é¡Œã€ã€æˆç¸¾ç¢ºèªã€ã¯ä¸‹ã®ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰\n"
        "ãƒ»ã€Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€ã€Œãƒªã‚»ãƒƒãƒˆã€ã€Œãƒ˜ãƒ«ãƒ—ã€ã‚‚ä½¿ãˆã¾ã™ã€‚"
    )
