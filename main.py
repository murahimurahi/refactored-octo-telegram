# -*- coding: utf-8 -*-
# ä¹™4ã‚¯ã‚¤ã‚º LINE Botï¼ˆFlaskç‰ˆãƒ»50å•ãƒ•ãƒ«å®Ÿè£…ï¼‰
# - /health ã‚ã‚Š
# - å‡ºé¡Œã¯4æŠãƒœã‚¿ãƒ³ï¼ˆTemplate/Buttonsï¼‰
# - å›ç­”å¾Œã¯ã€Œæ¬¡ã®å•é¡Œã€ã€Œãƒªã‚»ãƒƒãƒˆã€ã€Œãƒ˜ãƒ«ãƒ—ã€
# - 25å•/50å•ã§ç·æ‹¬ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
# - ç°¡æ˜“ãƒ¡ãƒ¢ãƒªï¼ˆã‚µãƒ¼ãƒå†èµ·å‹•ã§æ¶ˆãˆã¾ã™ï¼‰

import os
from flask import Flask, request, abort, jsonify

from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import (
    MessageEvent, TextMessage, TextSendMessage,
    TemplateSendMessage, ButtonsTemplate, PostbackAction,
    PostbackEvent
)

# ===== LINE ç’°å¢ƒå¤‰æ•° =====
CHANNEL_TOKEN  = os.getenv("LINE_CHANNEL_ACCESS_TOKEN", "")
CHANNEL_SECRET = os.getenv("LINE_CHANNEL_SECRET", "")
if not CHANNEL_TOKEN or not CHANNEL_SECRET:
    raise RuntimeError("ç’°å¢ƒå¤‰æ•° LINE_CHANNEL_ACCESS_TOKEN / LINE_CHANNEL_SECRET ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚")

line_bot_api = LineBotApi(CHANNEL_TOKEN)
handler      = WebhookHandler(CHANNEL_SECRET)

# ===== Flask =====
app = Flask(__name__)

@app.get("/health")
def health():
    return jsonify({"status": "ok"})

@app.post("/callback")
def callback():
    signature = request.headers.get("X-Line-Signature", "")
    body = request.get_data(as_text=True)
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400, "Invalid signature")
    return "OK"

# ===== ãƒ˜ãƒ«ãƒ— =====
HELP_TEXT = (
    "ğŸ“˜ ä½¿ã„æ–¹\n"
    "ãƒ»ã€Œé–‹å§‹ã€â†’ å‡ºé¡Œã‚¹ã‚¿ãƒ¼ãƒˆ\n"
    "ãƒ»4æŠãƒœã‚¿ãƒ³ï¼ˆâ‘ ã€œâ‘£ï¼‰ã§å›ç­”\n"
    "ãƒ»ã€Œæ¬¡ã®å•é¡Œã€ã§ç¶šè¡Œ / ã€Œæˆç¸¾ç¢ºèªã€ã§é€”ä¸­æˆç¸¾\n"
    "ãƒ»ã€Œãƒªã‚»ãƒƒãƒˆã€ã§æœ€åˆã‹ã‚‰\n"
    "ãƒ»25å•/50å•ã§ç·æ‹¬ãŒå‡ºã¾ã™"
)

# ===== 50å•ãƒ•ãƒ«å®Ÿè£…ï¼ˆæ³•ä»¤ãƒ»ç‰©ç†åŒ–å­¦ãƒ»æ€§çŠ¶æ¶ˆç«ï¼‰=====
# å½¢å¼: {"q": str, "choices": [strÃ—4], "answer": 0-3, "exp": str}
QUESTIONS = [
    # --- æ³•ä»¤ ---
    {"q":"ç¬¬1çŸ³æ²¹é¡ï¼ˆéæ°´æº¶æ€§ï¼‰ã®æŒ‡å®šæ•°é‡ã¯ï¼Ÿ", "choices":["100L","200L","400L","1000L"], "answer":0, "exp":"ç¬¬1çŸ³æ²¹é¡ï¼ˆéæ°´æº¶æ€§/æ°´æº¶æ€§ï¼‰ã¯100Lã€‚"},
    {"q":"ç¬¬2çŸ³æ²¹é¡ï¼ˆéæ°´æº¶æ€§ï¼‰ã®æŒ‡å®šæ•°é‡ã¯ï¼Ÿ", "choices":["500L","1000L","2000L","4000L"], "answer":2, "exp":"ç¬¬2çŸ³æ²¹é¡ï¼ˆéæ°´æº¶æ€§ï¼‰ã¯2000Lã€‚"},
    {"q":"ç¬¬2çŸ³æ²¹é¡ï¼ˆæ°´æº¶æ€§ï¼‰ã®æŒ‡å®šæ•°é‡ã¯ï¼Ÿ", "choices":["1000L","2000L","3000L","4000L"], "answer":1, "exp":"ç¬¬2çŸ³æ²¹é¡ï¼ˆæ°´æº¶æ€§ï¼‰ã¯2000Lã€‚"},
    {"q":"ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é¡ã®æŒ‡å®šæ•°é‡ã¯ï¼Ÿ", "choices":["100L","200L","400L","600L"], "answer":2, "exp":"ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é¡ã®æŒ‡å®šæ•°é‡ã¯400Lã€‚"},
    {"q":"ç¬¬3çŸ³æ²¹é¡ã®æŒ‡å®šæ•°é‡ã¯ï¼Ÿ", "choices":["1000L","2000L","3000L","4000L"], "answer":3, "exp":"ç¬¬3çŸ³æ²¹é¡ã¯4000Lã€‚"},
    {"q":"ç¬¬4çŸ³æ²¹é¡ã®æŒ‡å®šæ•°é‡ã¯ï¼Ÿ", "choices":["1000L","2000L","4000L","6000L"], "answer":3, "exp":"ç¬¬4çŸ³æ²¹é¡ã¯6000Lã€‚"},
    {"q":"ä¹™4ã§å–ã‚Šæ‰±ã†é¡ã¯ï¼Ÿ", "choices":["ç¬¬1é¡","ç¬¬2é¡","ç¬¬3é¡","ç¬¬4é¡"], "answer":3, "exp":"ä¹™4ã¯ç¬¬4é¡ï¼ˆå¼•ç«æ€§æ¶²ä½“ï¼‰ã€‚"},
    {"q":"å±é™ºç‰©è¦åˆ¶ã®æ ¹æ‹ æ³•ã¯ï¼Ÿ", "choices":["åŠ´åƒåŸºæº–æ³•","æ¶ˆé˜²æ³•","å»ºç¯‰åŸºæº–æ³•","å®‰è¡›æ³•"], "answer":1, "exp":"å±é™ºç‰©ã¯æ¶ˆé˜²æ³•ã«åŸºã¥ãè¦åˆ¶ã€‚"},
    {"q":"æŒ‡å®šæ•°é‡ä»¥ä¸Šã®è²¯è”µãƒ»å–æ‰±ã„ã«å¿…è¦ãªã®ã¯ï¼Ÿ", "choices":["å±Šå‡ºä¸è¦","æ¶ˆé˜²æ³•ã®è¨±å¯ç­‰","è­¦å¯Ÿè¨±å¯","åšåŠ´çœè¨±å¯"], "answer":1, "exp":"æ‰€è½„æ¶ˆé˜²ç½²ã®è¨±å¯ç­‰ãŒå¿…è¦ã€‚"},
    {"q":"å°‘é‡å±é™ºç‰©ã«è©²å½“ã™ã‚‹ã®ã¯ï¼Ÿ", "choices":["æŒ‡å®šæ•°é‡æœªæº€ã§ã‚‚å…¨éƒ¨è¦åˆ¶ãªã—","æŒ‡å®šæ•°é‡ã®1/5ä»¥ä¸Šãªã©ã§åŸºæº–ã‚ã‚Š","æŒ‡å®šæ•°é‡è¶…ã¨åŒã˜","ç¨å‹™ç½²ã®è¨±å¯"], "answer":1, "exp":"å°‘é‡å±é™ºç‰©ã«ã¯æŠ€è¡“ä¸Šã®åŸºæº–ã‚ã‚Šã€‚"},
    {"q":"å±é™ºç‰©æ–½è¨­ã®æ¨™è­˜ã§æ­£ã—ã„ã®ã¯ï¼Ÿ", "choices":["ç™½åœ°èµ¤æ èµ¤å­—","é»„åœ°é»’å­—","é’åœ°ç™½å­—","ç·‘åœ°ç™½å­—"], "answer":0, "exp":"ã€ç«æ°—å³ç¦ã€ãªã©ç™½åœ°èµ¤æ èµ¤å­—ã€‚"},
    {"q":"æ²ç¤ºç¾©å‹™ãŒãªã„ã‚‚ã®ã¯ï¼Ÿ", "choices":["é¡åˆ¥ãƒ»å“å","ç¦æ­¢äº‹é …","å–æ‰±è€…åç°¿","é¿é›£çµŒè·¯å›³"], "answer":3, "exp":"é¿é›£çµŒè·¯å›³ã¯æ³•ä»¤ã®æ²ç¤ºç¾©å‹™å¯¾è±¡å¤–ã€‚"},
    {"q":"å±é™ºç‰©é‹æ¬æ™‚ã®æ¨™è­˜è¡¨ç¤ºã§å¿…è¦ãªã®ã¯ï¼Ÿ", "choices":["è»Šä¸¡å‰å¾Œãªã©ã«æ¨™è­˜","å±‹æ ¹æ——","é‹è»¢å¸­ã®ã¿è¡¨ç¤º","ä¸è¦"], "answer":0, "exp":"ç©è¼‰æ¨™è­˜ãªã©ãŒå¿…è¦ï¼ˆæ¡ä»¶ã«ã‚ˆã‚Šï¼‰ã€‚"},
    {"q":"ä¿å®‰è·é›¢ã®ç›®çš„ã¯ï¼Ÿ", "choices":["è£…é£¾","å»¶ç„¼ãƒ»è¢«å®³æ‹¡å¤§é˜²æ­¢","æ›æ°—åœæ­¢","è·é‡æ”¯æŒ"], "answer":1, "exp":"å‘¨è¾ºã¸ã®è¢«å®³æ‹¡å¤§ã‚’æŠ‘ãˆã‚‹ã€‚"},
    {"q":"å—å…¥æ™‚ã«æœ€åˆã«è¡Œã†ã¹ãã“ã¨ã¯ï¼Ÿ", "choices":["ãƒãƒ³ãƒ›ãƒ¼ãƒ«é–‹æ”¾","æ¥åœ°ï¼ˆã‚¢ãƒ¼ã‚¹ï¼‰","ç«æ°—è¨­ç½®","åœ§é€ã‚¹ã‚¿ãƒ¼ãƒˆ"], "answer":1, "exp":"é™é›»æ°—ç€ç«é˜²æ­¢ã®ãŸã‚ã‚¢ãƒ¼ã‚¹å…ˆè¡Œã€‚"},
    # --- ç‰©ç†åŒ–å­¦ ---
    {"q":"å¼•ç«ç‚¹ã¨ã¯ï¼Ÿ", "choices":["è‡ªç„¶ç™ºç«æ¸©åº¦","ç«æºã§ç€ç«ã™ã‚‹æœ€ä½æ¸©åº¦","æ²¸ç‚¹","å‡å›ºç‚¹"], "answer":1, "exp":"å¯ç‡ƒè’¸æ°—ãŒç«æºã§ç€ç«ã™ã‚‹æœ€ä½æ¸©åº¦ã€‚"},
    {"q":"ç™ºç«ç‚¹ã¨ã¯ï¼Ÿ", "choices":["ç«æºãªã—ã§ç‡ƒãˆå§‹ã‚ã‚‹æ¸©åº¦","å¼•ç«ç‚¹ã‚ˆã‚Šä½ã„æ¸©åº¦","æ°´ã®æ²¸ç‚¹","è’¸æ°—åœ§"], "answer":0, "exp":"å¤–ç«ãªã—ã§è‡ªå·±ç€ç«ã™ã‚‹æ¸©åº¦ã€‚"},
    {"q":"è’¸æ°—å¯†åº¦ï¼ˆæ¯”é‡ï¼‰ãŒ1ã‚ˆã‚Šå¤§ãã„å¯ç‡ƒè’¸æ°—ã¯ï¼Ÿ", "choices":["é«˜æ‰€ã«æ»ç•™","ä½æ‰€ã«æ»ç•™","ä¸­å±¤ã«æ»ç•™","å½±éŸ¿ãªã—"], "answer":1, "exp":"ç©ºæ°—ã‚ˆã‚Šé‡ã„â†’ä½æ‰€ã«æ»ç•™ã€‚"},
    {"q":"è’¸æ°—åœ§ãŒé«˜ã„ã»ã©ï¼Ÿ", "choices":["æ®ç™ºã—ã«ãã„","æ®ç™ºã—ã‚„ã™ã„","å¯†åº¦ãŒä¸ŠãŒã‚‹","å¼•ç«ç‚¹ãŒä¸ŠãŒã‚‹"], "answer":1, "exp":"æ®ç™ºã—ã‚„ã™ãå±é™ºæ€§ãŒå¢—ã™ã€‚"},
    {"q":"å¯ç‡ƒç¯„å›²ãŒåºƒã„ã»ã©ï¼Ÿ", "choices":["å±é™ºæ€§ä½ã„","å±é™ºæ€§é«˜ã„","å¤‰ã‚ã‚‰ãªã„","ç‡ƒãˆãªã„"], "answer":1, "exp":"ç€ç«ã—ã‚„ã™ãå±é™ºæ€§ãŒé«˜ã„ã€‚"},
    {"q":"çˆ†ç™ºä¸‹é™ç•Œã‚ˆã‚Šæ¿ƒåº¦ãŒä½ã„æ··åˆæ°—ã¯ï¼Ÿ", "choices":["è–„ã™ãã¦ç‡ƒãˆãªã„","æ¿ƒã™ãã¦ç‡ƒãˆãªã„","å¿…ãšçˆ†ç™º","è‡ªç„¶ç™ºç«"], "answer":0, "exp":"ç‡ƒæ–™ä¸è¶³ã§ç‡ƒãˆãªã„ã€‚"},
    {"q":"é™é›»æ°—å¯¾ç­–ã¨ã—ã¦é©åˆ‡ãªã®ã¯ï¼Ÿ", "choices":["ä¹¾ç‡¥ç¶­æŒ","æ¥åœ°ãƒ»ç­‰é›»ä½åŒ–","æ¨¹è„‚å®¹å™¨åŒå£«ã§ç§»é€","æ›æ°—åœæ­¢"], "answer":1, "exp":"ã‚¢ãƒ¼ã‚¹ã‚„å°é›»åŒ–ã§æ”¾é›»è·¯ã‚’ç¢ºä¿ã€‚"},
    {"q":"æ¯”ç†±ãŒå¤§ãã„ç‰©ä½“ã®ç‰¹å¾´ã¯ï¼Ÿ", "choices":["æ¸©åº¦ãŒä¸ŠãŒã‚Šã‚„ã™ã„","æ¸©åº¦ãŒä¸ŠãŒã‚Šã«ãã„","ç™ºç«ã—ã‚„ã™ã„","è’¸ç™ºã—ã‚„ã™ã„"], "answer":1, "exp":"åŒã˜ç†±é‡ã§æ¸©åº¦å¤‰åŒ–ãŒå°ã•ã„ã€‚"},
    {"q":"ã‚¬ã‚½ãƒªãƒ³ã®ç‰¹å¾´ã§æ­£ã—ã„ã®ã¯ï¼Ÿ", "choices":["æ²¸ç‚¹ãŒé«˜ã„","å¼•ç«ç‚¹ãŒéå¸¸ã«ä½ã„","æ°´ã«æº¶ã‘ã‚„ã™ã„","è’¸æ°—ã¯ç©ºæ°—ã‚ˆã‚Šè»½ã„ã“ã¨ãŒå¤šã„"], "answer":1, "exp":"å¼•ç«ç‚¹ãŒéå¸¸ã«ä½ãå±é™ºã€‚"},
    {"q":"èŠ³é¦™æ—ç‚­åŒ–æ°´ç´ ã®ä¸€èˆ¬çš„æ€§è³ªã¯ï¼Ÿ", "choices":["æ°´ã«æº¶ã‘ã‚„ã™ã„","æ°´ã«æº¶ã‘ã«ãã„","å¼·é…¸æ€§","å¼·å¡©åŸºæ€§"], "answer":1, "exp":"ç–æ°´æ€§ã§æ°´ã¨æ··ã–ã‚Šã«ãã„ã€‚"},
    {"q":"æ›æ°—ã®ä¸»ç›®çš„ã¯ï¼Ÿ", "choices":["æ¹¿åº¦ä½ä¸‹","è’¸æ°—æ¿ƒåº¦ä½æ¸›","æ¸©åº¦å·®ä½æ¸›","åœ§åŠ›æå¤±ä½æ¸›"], "answer":1, "exp":"å¯ç‡ƒè’¸æ°—æ¿ƒåº¦ã‚’ä¸‹ã’ã‚‹ã€‚"},
    {"q":"ã‚¢ã‚»ãƒˆãƒ³ã¯ã©ã®åˆ†é¡ï¼Ÿ", "choices":["ç¬¬1çŸ³æ²¹é¡ï¼ˆéæ°´æº¶æ€§ï¼‰","ç¬¬1çŸ³æ²¹é¡ï¼ˆæ°´æº¶æ€§ï¼‰","ç¬¬2çŸ³æ²¹é¡","ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é¡"], "answer":1, "exp":"æ°´ã¨ä»»æ„æ¯”ã§æ··å’Œâ†’ç¬¬1çŸ³æ²¹é¡ï¼ˆæ°´æº¶æ€§ï¼‰ã€‚"},
    {"q":"ãƒˆãƒ«ã‚¨ãƒ³ã¯ã©ã®åˆ†é¡ï¼Ÿ", "choices":["ç¬¬1çŸ³æ²¹é¡ï¼ˆéæ°´ï¼‰","ç¬¬1çŸ³æ²¹é¡ï¼ˆæ°´ï¼‰","ç¬¬2çŸ³æ²¹é¡","ç¬¬3çŸ³æ²¹é¡"], "answer":0, "exp":"éæ°´æº¶æ€§ã®ç¬¬1çŸ³æ²¹é¡ã€‚"},
    {"q":"è»½æ²¹ã¯ã©ã®åˆ†é¡ï¼Ÿ", "choices":["ç¬¬1çŸ³æ²¹é¡","ç¬¬2çŸ³æ²¹é¡","ç¬¬3çŸ³æ²¹é¡","ç¬¬4çŸ³æ²¹é¡"], "answer":1, "exp":"è»½æ²¹ã¯ç¬¬2çŸ³æ²¹é¡ï¼ˆéæ°´æº¶æ€§ï¼‰ã€‚"},
    # --- æ€§çŠ¶ãƒ»æ¶ˆç« ---
    {"q":"æ²¹ç«ç½ã«æ°´ã‚’ç›´æ¥ã‹ã‘ã‚‹ã¨ï¼Ÿ", "choices":["å®‰å…¨ã«æ¶ˆãˆã‚‹","æ²¹ãŒé£›æ•£ã—å±é™º","å¿…ãšçˆ†ç™º","å›ºåŒ–ã™ã‚‹"], "answer":1, "exp":"é£›æ•£ãƒ»å»¶ç„¼ã®å±é™ºãŒé«˜ã„ã€‚"},
    {"q":"ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ç«ç½ã«æœ‰åŠ¹ãªæ¶ˆç«å‰¤ã¯ï¼Ÿ", "choices":["æ™®é€šæ³¡ã®ã¿","è€ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ³¡ã‚„ç²‰æœ«","æ°´ã®ã¿","ä¹¾ç‡¥ç ‚ã®ã¿"], "answer":1, "exp":"ATCæ³¡ãƒ»ç²‰æœ«ç­‰ãŒæœ‰åŠ¹ã€‚"},
    {"q":"äºŒé…¸åŒ–ç‚­ç´ æ¶ˆç«ã®ä¸»ä½œç”¨ã¯ï¼Ÿ", "choices":["å†·å´","çª’æ¯","å¸Œé‡ˆ","ä¹³åŒ–"], "answer":1, "exp":"CO2ã¯é…¸ç´ ã‚’ç½®æ›ã—ã¦çª’æ¯åŠ¹æœã€‚"},
    {"q":"ç²‰æœ«ABCæ¶ˆç«è–¬å‰¤ã®ä¸»ä½œç”¨ã¯ï¼Ÿ", "choices":["å†·å´","é€£é–åå¿œæŠ‘åˆ¶","å¸Œé‡ˆ","ä¹³åŒ–"], "answer":1, "exp":"ãƒ©ã‚¸ã‚«ãƒ«åå¿œã‚’æŠ‘åˆ¶ã€‚"},
    {"q":"é›»æ°—ç«ç½ã§ã¾ãšè¡Œã†ã“ã¨ã¯ï¼Ÿ", "choices":["é€é¢¨","çµ¦é›»é®æ–­","æ°´å™´éœ§","æ³¡æ•£å¸ƒ"], "answer":1, "exp":"æ„Ÿé›»é˜²æ­¢ã®ãŸã‚é®æ–­ãŒå…ˆã€‚"},
    {"q":"é‡‘å±ãƒŠãƒˆãƒªã‚¦ãƒ ç«ç½ã§é©åˆ‡ãªã®ã¯ï¼Ÿ", "choices":["æ°´","æ³¡","ä¹¾ç‡¥ç ‚ãƒ»é‡‘å±ç”¨ç²‰æœ«","CO2"], "answer":2, "exp":"æ°´ãƒ»æ³¡ã¯ç¦å¿Œã€‚ä¹¾ç‡¥ç ‚ç­‰ã‚’ä½¿ç”¨ã€‚"},
    {"q":"æµå‡ºæ²¹ç«ç½ã®åŸºæœ¬æˆ¦è¡“ã¯ï¼Ÿ", "choices":["æ”¾æ°´ã§æŠ¼ã—æµã™","ãƒ•ã‚©ãƒ¼ãƒ ã§è¢«è¦†","ç©ºæ°—é€ã‚Šè¾¼ã¿","æ’¹æ‹Œ"], "answer":1, "exp":"æ³¡ã§è¡¨é¢ã‚’è¦†ã„çª’æ¯ãƒ»é®æ–­ã€‚"},
    {"q":"ATCæ³¡ï¼ˆè€ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ³¡ï¼‰ã®ç”¨é€”ã¯ï¼Ÿ", "choices":["éæ°´æº¶æ€§ã®ã¿","æ°´æº¶æ€§æº¶å‰¤ã«ã‚‚æœ‰åŠ¹","æ°—ä½“ç«ç½å°‚ç”¨","é‡‘å±ç«ç½å°‚ç”¨"], "answer":1, "exp":"æ°´æº¶æ€§ã«ã‚‚å¯¾å¿œã€‚"},
    {"q":"CO2æ¶ˆç«ã®å¼±ç‚¹ã¯ï¼Ÿ", "choices":["é€šé›»éƒ¨ä½ã§ã¯ä½¿ãˆãªã„","å±‹å¤–ã§é¢¨ã«æµã•ã‚Œã‚„ã™ã„","è…é£Ÿæ€§ãŒå¼·ã„","æ³¡ã‚’åˆ†è§£ã™ã‚‹"], "answer":1, "exp":"å±‹å¤–ã§ã¯å¹ãé£›ã°ã•ã‚Œã‚„ã™ã„ã€‚"},
    {"q":"æ½¤æ»‘æ²¹ã¯ã©ã®åˆ†é¡ï¼Ÿ", "choices":["ç¬¬1çŸ³æ²¹é¡","ç¬¬2çŸ³æ²¹é¡","ç¬¬3çŸ³æ²¹é¡","ç¬¬4çŸ³æ²¹é¡"], "answer":2, "exp":"æ½¤æ»‘æ²¹ã¯ç¬¬3çŸ³æ²¹é¡ã€‚"},
    {"q":"ãƒ™ãƒ³ã‚¼ãƒ³ã®å¼•ç«ç‚¹ã®ç›®å®‰ã¯ï¼Ÿ", "choices":["ç´„-20â„ƒ","ç´„0â„ƒ","ç´„30â„ƒ","ç´„80â„ƒ"], "answer":0, "exp":"éå¸¸ã«ä½ã„å¼•ç«ç‚¹ã‚’æŒã¤ã€‚"},
    {"q":"å—å…¥ä½œæ¥­æ™‚ã®æœè£…ã§ä¸é©åˆ‡ãªã®ã¯ï¼Ÿ", "choices":["å¸¯é›»é˜²æ­¢æœ","é™é›»é´","åŒ–ç¹Šãƒ•ãƒªãƒ¼ã‚¹","ç¶¿ä½œæ¥­ç€"], "answer":2, "exp":"åŒ–ç¹Šãƒ•ãƒªãƒ¼ã‚¹ã¯å¸¯é›»ã—ã‚„ã™ã„ã€‚"},
    {"q":"ç§»é€ã§é¿ã‘ã‚‹ã¹ãã¯ï¼Ÿ", "choices":["é‡‘å±é…ç®¡ã§æ¥åœ°","æ¨¹è„‚å®¹å™¨åŒå£«ã®æ‰‹æŒã¡ç§»é€","å°é›»æ€§ãƒ›ãƒ¼ã‚¹","æ¶²é¢ä¸‹æ³¨å…¥"], "answer":1, "exp":"æ¨¹è„‚å®¹å™¨é–“ç§»é€ã¯é™é›»æ°—å±é™ºã€‚"},
    {"q":"ãƒ–ãƒªãƒ¼ã‚¶ãƒ¼ï¼ˆå‘¼å¸è£…ç½®ï¼‰ã®ç›®çš„ã¯ï¼Ÿ", "choices":["æ¶ˆç«","åœ§åŠ›å¤‰å‹•èª¿æ•´","è’¸æ°—å›å","ç€ç«"], "answer":1, "exp":"ã‚¿ãƒ³ã‚¯å†…åœ§ã®å¤‰å‹•ã‚’èª¿æ•´ã€‚"},
    {"q":"ã‚¿ãƒ³ã‚¯ç«ç½ã§é‡è¦ãªã®ã¯ï¼Ÿ", "choices":["ä¸Šéƒ¨ã‹ã‚‰é€é¢¨","ãƒ•ã‚©ãƒ¼ãƒ ã§è¢«è¦†","ç©ºæ°—é€å…¥","æ’¹æ‹Œ"], "answer":1, "exp":"æ³¡ã§æ¶²é¢ã‚’è¦†ã†ã€‚"},
    {"q":"æŒ‡å®šæ•°é‡ä»¥ä¸Šã®å–æ‰±æ‰€ã§å¿…é ˆã®æœ‰è³‡æ ¼è€…ã¯ï¼Ÿ", "choices":["å±é™ºç‰©å–æ‰±è€…","æ¯’ç‰©åŠ‡ç‰©å–æ‰±è€…","é›»æ°—ä¸»ä»»æŠ€è¡“è€…","ãƒœã‚¤ãƒ©ãƒ¼æŠ€å£«"], "answer":0, "exp":"å±é™ºç‰©å–æ‰±è€…ãŒå¿…è¦ã€‚"},
    {"q":"æ°´æº¶æ€§ç¬¬1çŸ³æ²¹é¡ã¯ã©ã‚Œï¼Ÿ", "choices":["ã‚¢ã‚»ãƒˆãƒ³","ãƒˆãƒ«ã‚¨ãƒ³","ã‚­ã‚·ãƒ¬ãƒ³","ãƒ™ãƒ³ã‚¼ãƒ³"], "answer":0, "exp":"ã‚¢ã‚»ãƒˆãƒ³ã¯æ°´ã¨ä»»æ„æ¯”ã§æ··å’Œã€‚"},
    {"q":"ã‚¬ã‚½ãƒªãƒ³ã®ä¸»æˆåˆ†ã¯ï¼Ÿ", "choices":["ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«","ç‚­åŒ–æ°´ç´ ","ã‚¢ãƒ«ãƒ‡ãƒ’ãƒ‰","ã‚±ãƒˆãƒ³"], "answer":1, "exp":"ç‚­åŒ–æ°´ç´ ãŒä¸»ä½“ã€‚"},
    {"q":"æŒ‡å®šæ•°é‡æœªæº€ã§ã‚‚å¿…è¦ãªã®ã¯ï¼Ÿ", "choices":["ä¸€åˆ‡ä¸è¦","ä¸€éƒ¨åŸºæº–ã®éµå®ˆ","å¿…ãšè¨±å¯","ç¨å‹™å±Šå‡º"], "answer":1, "exp":"å°‘é‡å±é™ºç‰©ç­‰ã®åŸºæº–ãŒã‚ã‚‹ã€‚"},
    {"q":"å¯ç‡ƒè’¸æ°—ã¯ä¸€èˆ¬ã«ç©ºæ°—ã‚ˆã‚Šï¼Ÿ", "choices":["è»½ã„","åŒã˜","é‡ã„","å¤‰ã‚ã‚‰ãªã„"], "answer":2, "exp":"å¤šãã¯ç©ºæ°—ã‚ˆã‚Šé‡ãä½æ‰€ã«æ»ç•™ã€‚"},
    {"q":"æ²¹æ°´åˆ†é›¢ãƒãƒƒãƒˆã®ç›®çš„ã¯ï¼Ÿ", "choices":["å¸éŸ³","æ²¹å¸ç€","æ¶ˆç«","ç™ºç†±"], "answer":1, "exp":"æ¼ãˆã„å¯¾ç­–ã«ç”¨ã„ã‚‹å¸ç€æã€‚"},
    {"q":"é¿é›·è¨­å‚™ã®ç›®çš„ã¯ï¼Ÿ", "choices":["é¨’éŸ³ä½æ¸›","é›·é›»æµã‚’å¤§åœ°ã«é€ƒãŒã™","å†·å´","æ¶ˆç«"], "answer":1, "exp":"é›·ã‚„é™é›»æ°—ã®ç€ç«ãƒªã‚¹ã‚¯ä½æ¸›ã€‚"},
    {"q":"é‹æ¬ç©è¼‰é‡ã‚’å®šã‚ã‚‹æ³•ã¯ï¼Ÿ", "choices":["æ¶ˆé˜²æ³•","é“è·¯äº¤é€šæ³•","å®‰è¡›æ³•","å»ºç¯‰åŸºæº–æ³•"], "answer":1, "exp":"é“è·¯äº¤é€šæ³•ãªã©ã§è¦å®šã€‚"},
    {"q":"æœè£…ã§é©åˆ‡ãªã®ã¯ï¼Ÿ", "choices":["å¸¯é›»é˜²æ­¢æœï¼‹é™é›»é´","åŒ–ç¹Šãƒ•ãƒªãƒ¼ã‚¹","ã‚µãƒ³ãƒ€ãƒ«","ã‚¦ãƒ¼ãƒ«100%"], "answer":0, "exp":"å¸¯é›»é˜²æ­¢å¯¾ç­–ã®åŸºæœ¬ã€‚"},
    {"q":"æ³¡æ¶ˆç«ã®ä¸»ä½œç”¨ã¯ï¼Ÿ", "choices":["å†·å´","çª’æ¯ãƒ»é®æ–­","å¸Œé‡ˆ","é€£é–åå¿œæŠ‘åˆ¶"], "answer":1, "exp":"è¡¨é¢ã‚’è¦†ã„ç©ºæ°—ã¨é®æ–­ã€‚"},
    {"q":"äºŒé…¸åŒ–ç‚­ç´ æ¶ˆç«ãŒè‹¦æ‰‹ãªå ´é¢ã¯ï¼Ÿ", "choices":["å±‹å†…","å¯†é–‰ç©ºé–“","å±‹å¤–ã®å¼·é¢¨ä¸‹","é›»æ°—ç«ç½"], "answer":2, "exp":"é¢¨ã§é£›æ•£ã—ã‚„ã™ã„ã€‚"},
]

TOTAL = len(QUESTIONS)  # 50

# ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹ =====
# user_id -> {"qid": int, "correct": int, "answered": int}
STATE = {}

def reset_state(uid: str):
    STATE[uid] = {"qid": 0, "correct": 0, "answered": 0}

def buttons_for_question(q_index: int) -> TemplateSendMessage:
    q = QUESTIONS[q_index]
    actions = [
        PostbackAction(label=f"â‘  {q['choices'][0]}", data=f"ans:{q_index}:0"),
        PostbackAction(label=f"â‘¡ {q['choices'][1]}", data=f"ans:{q_index}:1"),
        PostbackAction(label=f"â‘¢ {q['choices'][2]}", data=f"ans:{q_index}:2"),
        PostbackAction(label=f"â‘£ {q['choices'][3]}", data=f"ans:{q_index}:3"),
    ]
    tmpl = ButtonsTemplate(
        title=f"Q{q_index+1}/{TOTAL}",
        text=q["q"],
        actions=actions
    )
    return TemplateSendMessage(alt_text="å•é¡Œ", template=tmpl)

def buttons_after_answer() -> TemplateSendMessage:
    return TemplateSendMessage(
        alt_text="æ“ä½œ",
        template=ButtonsTemplate(
            title="æ¬¡ã®æ“ä½œ",
            text="é¸ã‚“ã§ãã ã•ã„",
            actions=[
                PostbackAction(label="â–¶ æ¬¡ã®å•é¡Œ", data="next"),
                PostbackAction(label="ğŸ”„ ãƒªã‚»ãƒƒãƒˆ", data="reset"),
                PostbackAction(label="â“ ãƒ˜ãƒ«ãƒ—", data="help"),
            ]
        )
    )

def summary_text(uid: str, title: str) -> str:
    st = STATE[uid]
    a, c = st["answered"], st["correct"]
    rate = 0 if a == 0 else round(100*c/a, 1)
    return f"ğŸ“Š {title}\nè§£ç­”æ•°: {a}/{TOTAL}\næ­£è§£: {c}\næ­£ç­”ç‡: {rate}%"

# ===== Handlers =====
@handler.add(MessageEvent, message=TextMessage)
def on_text(event: MessageEvent):
    uid = event.source.user_id
    text = (event.message.text or "").strip()

    if uid not in STATE:
        reset_state(uid)
        line_bot_api.reply_message(
            event.reply_token,
            TextSendMessage(text=f"{HELP_TEXT}\n\nã¾ãšã¯ã€Œé–‹å§‹ã€ã¨é€ã£ã¦ãã ã•ã„ã€‚")
        )
        return

    if text in {"ãƒ˜ãƒ«ãƒ—", "help", "ä½¿ã„æ–¹", "ï¼Ÿ"}:
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=HELP_TEXT))
        return

    if text in {"ãƒªã‚»ãƒƒãƒˆ", "reset"}:
        reset_state(uid)
        line_bot_api.reply_message(
            event.reply_token,
            TextSendMessage(text="â™»ï¸ ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚ã€Œé–‹å§‹ã€ã§å†é–‹ã§ãã¾ã™ã€‚")
        )
        return

    if text in {"æˆç¸¾ç¢ºèª", "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹"}:
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=summary_text(uid, "ç¾åœ¨ã®æˆç¸¾")))
        return

    if text in {"é–‹å§‹", "å•é¡Œ", "ã‚¯ã‚¤ã‚º", "æ¬¡ã®å•é¡Œ", "start"}:
        st = STATE[uid]
        qid = st["qid"]
        if qid >= TOTAL:
            line_bot_api.reply_message(
                event.reply_token,
                TextSendMessage(text="âœ… å…¨50å•çµ‚äº†ï¼ã€Œãƒªã‚»ãƒƒãƒˆã€ã§å†æŒ‘æˆ¦ã§ãã¾ã™ã€‚")
            )
            return
        line_bot_api.reply_message(event.reply_token, buttons_for_question(qid))
        return

    # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    line_bot_api.reply_message(
        event.reply_token,
        TextSendMessage(text="ã€é–‹å§‹ã€ã€æ¬¡ã®å•é¡Œã€ã€æˆç¸¾ç¢ºèªã€ã€ãƒªã‚»ãƒƒãƒˆã€ã€ãƒ˜ãƒ«ãƒ—ã€ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚")
    )

@handler.add(PostbackEvent)
def on_postback(event: PostbackEvent):
    uid = event.source.user_id
    data = event.postback.data

    if uid not in STATE:
        reset_state(uid)
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text="ã¾ãšã¯ã€Œé–‹å§‹ã€ã¨é€ã£ã¦ãã ã•ã„ã€‚"))
        return

    st = STATE[uid]

    # å›ç­”
    if data.startswith("ans:"):
        _, qid_str, ans_str = data.split(":")
        qid = int(qid_str); ans = int(ans_str)
        q = QUESTIONS[qid]

        st["answered"] += 1
        correct = (ans == q["answer"])
        if correct:
            st["correct"] += 1

        result = "â­• æ­£è§£ï¼" if correct else f"âŒ ä¸æ­£è§£â€¦ æ­£è§£ã¯ã€{q['choices'][q['answer']]}ã€"
        msg = f"{result}\nï¼ˆè£œè¶³ï¼‰{q['exp']}"

        # 25å•/50å•ã§ç·æ‹¬
        extra = ""
        if st["answered"] in (25, 50):
            extra = "\n\n" + summary_text(uid, f"{st['answered']}å•ç·æ‹¬")

        # å›ç­”å¾Œã®æ“ä½œãƒœã‚¿ãƒ³
        line_bot_api.reply_message(event.reply_token, [
            TextSendMessage(text=msg + extra),
            buttons_after_answer()
        ])
        return

    # æ¬¡ã®å•é¡Œ
    if data == "next":
        st["qid"] += 1
        if st["qid"] >= TOTAL:
            # çµ‚äº†ãƒ»æœ€çµ‚ã‚µãƒãƒª
            line_bot_api.reply_message(
                event.reply_token,
                TextSendMessage(text=summary_text(uid, "æœ€çµ‚æˆç¸¾") + "\nâœ… å…¨50å•çµ‚äº†ï¼ã€Œãƒªã‚»ãƒƒãƒˆã€ã§å†æŒ‘æˆ¦ã§ãã¾ã™ã€‚")
            )
            return
        line_bot_api.reply_message(event.reply_token, buttons_for_question(st["qid"]))
        return

    # ãƒªã‚»ãƒƒãƒˆ
    if data == "reset":
        reset_state(uid)
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text="ğŸ”„ ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚ã€Œé–‹å§‹ã€ã§å†é–‹ã§ãã¾ã™ã€‚"))
        return

    # ãƒ˜ãƒ«ãƒ—
    if data == "help":
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=HELP_TEXT))
        return

# ãƒ­ãƒ¼ã‚«ãƒ«èµ·å‹•ç”¨ï¼ˆRenderã§ã¯ç„¡è¦–ã•ã‚Œã‚‹ï¼‰
if __name__ == "__main__":
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 5000)))
