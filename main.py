# -*- coding: utf-8 -*-
# ä¹™4ã‚¯ã‚¤ã‚º LINE Botï¼ˆFastAPIç‰ˆãƒ»å®Œæˆï¼‰
# - /healthã‚ã‚Šï¼ˆRenderã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
# - åˆå›ï¼†ãƒªã‚»ãƒƒãƒˆæ™‚ã«ãƒ˜ãƒ«ãƒ—è‡ªå‹•è¡¨ç¤º
# - 50å•åéŒ²ï¼ˆcat: æ³•ä»¤ / ç‰©ç†åŒ–å­¦ / æ€§çŠ¶æ¶ˆç«ï¼‰
# - 25å•/50å•ã§ç·æ‹¬è¡¨ç¤º
# - å›ç­”å¾Œã®ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ—ãƒ©ã‚¤ã¯ã€Œãƒªã‚»ãƒƒãƒˆã€ã€Œãƒ˜ãƒ«ãƒ—ã€ã®ã¿
# - å‡ºé¡Œãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ï¼šã€Œæ³•ä»¤ã€ã€Œç‰©ç†ã€ã€Œæ€§çŠ¶ã€ã€Œãƒ©ãƒ³ãƒ€ãƒ ã€
# - ç´™å¹é›ªãªã©ã®æ¼”å‡ºãªã—

import os
from typing import Dict, Any, Optional
from fastapi import FastAPI, Request, HTTPException
from fastapi.responses import JSONResponse
from linebot import LineBotApi, WebhookHandler
from linebot.models import (
    MessageEvent, TextMessage, TextSendMessage,
    QuickReply, QuickReplyButton, MessageAction,
)

app = FastAPI()

# ====== LINE ç’°å¢ƒå¤‰æ•° ======
LINE_CHANNEL_ACCESS_TOKEN = os.getenv("LINE_CHANNEL_ACCESS_TOKEN", "")
LINE_CHANNEL_SECRET = os.getenv("LINE_CHANNEL_SECRET", "")
if not LINE_CHANNEL_ACCESS_TOKEN or not LINE_CHANNEL_SECRET:
    print("!!! Set LINE_CHANNEL_ACCESS_TOKEN / LINE_CHANNEL_SECRET !!!")

line_bot_api = LineBotApi(LINE_CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(LINE_CHANNEL_SECRET)

TOTAL = 50
MID = 25

# ====== ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ—ãƒ©ã‚¤ï¼ˆå›ç­”å¾Œã¯ãƒªã‚»ãƒƒãƒˆ/ãƒ˜ãƒ«ãƒ—ã®ã¿ï¼‰ ======
def quick_reset_help() -> QuickReply:
    return QuickReply(items=[
        QuickReplyButton(action=MessageAction(label="ãƒªã‚»ãƒƒãƒˆ", text="ãƒªã‚»ãƒƒãƒˆ")),
        QuickReplyButton(action=MessageAction(label="ãƒ˜ãƒ«ãƒ—",   text="ãƒ˜ãƒ«ãƒ—")),
    ])

# ====== 50å•ï¼ˆcat: æ³•ä»¤ / ç‰©ç†åŒ–å­¦ / æ€§çŠ¶æ¶ˆç«ï¼‰ ======
# æ­£ç­”ã¯ "a": "1"ï½"4" ã®æ–‡å­—åˆ—
questions = [
    {"q": "ã‚¬ã‚½ãƒªãƒ³ã¯ç¬¬ä½•é¡ï¼Ÿ\n1 ç¬¬1é¡\n2 ç¬¬2é¡\n3 ç¬¬4é¡\n4 ç¬¬6é¡", "a": "3", "cat": "æ€§çŠ¶æ¶ˆç«"},
    {"q": "ç¯æ²¹ã¯ã©ã‚Œã«åˆ†é¡ï¼Ÿ\n1 ç¬¬1çŸ³æ²¹é¡\n2 ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é¡\n3 ç¬¬2çŸ³æ²¹é¡\n4 å±é™ºç‰©ã§ã¯ãªã„", "a": "3", "cat": "æ€§çŠ¶æ¶ˆç«"},
    {"q": "è»½æ²¹ã®å¼•ç«ç‚¹ã®ç›®å®‰ã¯ï¼Ÿ\n1 âˆ’20â„ƒä»¥ä¸‹\n2 21ï½70â„ƒ\n3 70â„ƒä»¥ä¸Š\n4 å¼•ç«ç‚¹ãªã—", "a": "2", "cat": "ç‰©ç†åŒ–å­¦"},
    {"q": "ç¬¬1çŸ³æ²¹é¡ã®æŒ‡å®šæ•°é‡ã¯ï¼Ÿ\n1 100L\n2 200L\n3 400L\n4 1000L", "a": "2", "cat": "æ³•ä»¤"},
    {"q": "ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é¡ã®ä¾‹ã¯ï¼Ÿ\n1 ãƒ¡ã‚¿ãƒãƒ¼ãƒ«\n2 è»½æ²¹\n3 ç¯æ²¹\n4 æ½¤æ»‘æ²¹", "a": "1", "cat": "æ€§çŠ¶æ¶ˆç«"},
    {"q": "ç¬¬2çŸ³æ²¹é¡ï¼ˆæ°´æº¶æ€§ï¼‰ã¯è¡¨ç¤ºã§ä½•ã‚’ä»˜è¨˜ï¼Ÿ\n1 æ°´æº¶æ€§\n2 éæ°´æº¶æ€§\n3 ç„¡æ°´\n4 ç„¡å®³", "a": "1", "cat": "æ³•ä»¤"},
    {"q": "ä¹™4ã§å–ã‚Šæ‰±ã‚ãªã„ã®ã¯ï¼Ÿ\n1 ç¬¬4é¡\n2 ç¬¬1é¡\n3 ç¬¬6é¡\n4 ç¬¬2é¡", "a": "2", "cat": "æ³•ä»¤"},
    {"q": "å¼•ç«ç‚¹ã®å®šç¾©ã¯ï¼Ÿ\n1 è‡ªç„¶ç™ºç«æ¸©åº¦\n2 ç€ç«ã§ç¶™ç¶šç‡ƒç„¼ã™ã‚‹æœ€ä½æ¸©åº¦\n3 æ²¸ç‚¹\n4 å‡å›ºç‚¹", "a": "2", "cat": "ç‰©ç†åŒ–å­¦"},
    {"q": "ç™ºç«ç‚¹ã¯ï¼Ÿ\n1 ç«æºãªã—ã§ç‡ƒãˆå§‹ã‚ã‚‹æ¸©åº¦\n2 ç‚¹ç«ã™ã‚‹ã¨æ¶ˆãˆã‚‹æ¸©åº¦\n3 æ²¸ç‚¹\n4 å‡å›ºç‚¹", "a": "1", "cat": "ç‰©ç†åŒ–å­¦"},
    {"q": "ç¬¬3çŸ³æ²¹é¡ã®ä»£è¡¨ã¯ï¼Ÿ\n1 ã‚¬ã‚½ãƒªãƒ³\n2 è»½æ²¹\n3 ã‚¯ãƒ¬ã‚ªã‚½ãƒ¼ãƒˆæ²¹\n4 ã‚¨ã‚¿ãƒãƒ¼ãƒ«", "a": "3", "cat": "æ€§çŠ¶æ¶ˆç«"},
    {"q": "æ°´æº¶æ€§ç¬¬1çŸ³æ²¹é¡ã¯ï¼Ÿ\n1 ãƒ™ãƒ³ã‚¼ãƒ³\n2 é…¢é…¸ã‚¨ãƒãƒ«\n3 ã‚¢ã‚»ãƒˆãƒ³\n4 ãƒˆãƒ«ã‚¨ãƒ³", "a": "3", "cat": "æ€§çŠ¶æ¶ˆç«"},
    {"q": "å±é™ºç‰©ã®æ€§çŠ¶ã§èª¤ã‚Šã¯ï¼Ÿ\n1 å¼•ç«ç‚¹ãŒä½ã„ã»ã©å±é™ºæ€§é«˜ã„\n2 è’¸æ°—æ¯”é‡ãŒç©ºæ°—ã‚ˆã‚Šå¤§ãã„ã¨ä½æ‰€ã«æ»ç•™\n3 è’¸æ°—åœ§ãŒé«˜ã„ã»ã©è’¸æ°—ã¯å°‘ãªã„\n4 è’¸æ°—ã¯ç€ç«æºãŒã‚ã‚‹ã¨ç‡ƒãˆã‚‹", "a": "3", "cat": "ç‰©ç†åŒ–å­¦"},
    {"q": "æŒ‡å®šæ•°é‡ä»¥ä¸Šã®è²¯è”µã¯ï¼Ÿ\n1 å±Šå‡ºä¸è¦\n2 æ¶ˆé˜²æ³•ã®è¨±å¯ç­‰ãŒå¿…è¦\n3 ä¿å¥æ‰€è¨±å¯\n4 è­¦å¯Ÿå±Šå‡º", "a": "2", "cat": "æ³•ä»¤"},
    {"q": "å±é™ºç‰©æ–½è¨­ã®æ¨™è­˜ã§å¿…è¦ãªã®ã¯ï¼Ÿ\n1 å±é™ºç‰©ã®é¡åˆ¥\n2 æ‰€æœ‰è€…ä½æ‰€\n3 æ¶ˆè²»ç¨ç•ªå·\n4 é›»åŠ›ä¼šç¤¾å", "a": "1", "cat": "æ³•ä»¤"},
    {"q": "è¡¨ç¤ºã§æ­£ã—ã„ã®ã¯ï¼Ÿ\n1 èµ¤åœ°ã€ç«æ°—å³ç¦ã€\n2 é»„åœ°ã€é«˜é›»åœ§ã€\n3 é’åœ°ã€å¾è¡Œã€\n4 ç·‘åœ°ã€å®‰å…¨ã€", "a": "1", "cat": "æ³•ä»¤"},
    {"q": "é™é›»æ°—å¯¾ç­–ã§ä¸é©åˆ‡ã¯ï¼Ÿ\n1 ã‚¢ãƒ¼ã‚¹\n2 å°é›»æ€§åºŠ\n3 ä¹¾ç‡¥ã•ã›ã‚‹\n4 å°é›»æ€§ãƒ›ãƒ¼ã‚¹", "a": "3", "cat": "ç‰©ç†åŒ–å­¦"},
    {"q": "æ²¹ç«ç½ã«é©ã™ã‚‹æ¶ˆç«å™¨ã¯ï¼Ÿ\n1 æ°´\n2 æ³¡\n3 CO2ã¯ä¸é©\n4 è’¸æ°—", "a": "2", "cat": "æ€§çŠ¶æ¶ˆç«"},
    {"q": "æ³¡æ¶ˆç«ã®ä¸»åŠ¹æœã¯ï¼Ÿ\n1 å†·å´\n2 çª’æ¯ãƒ»é®æ–­\n3 å¸Œé‡ˆ\n4 é€£é–åå¿œæŠ‘åˆ¶ã®ã¿", "a": "2", "cat": "æ€§çŠ¶æ¶ˆç«"},
    {"q": "CO2æ¶ˆç«ã®ä¸»åŠ¹æœã¯ï¼Ÿ\n1 å†·å´ã¨çª’æ¯\n2 å¸Œé‡ˆã®ã¿\n3 ç™ºç«ç‚¹ä¸Šæ˜‡\n4 æ³¡ã§è¦†ã†", "a": "1", "cat": "æ€§çŠ¶æ¶ˆç«"},
    {"q": "æ¼ãˆã„æ™‚ã®åˆæœŸå¯¾å¿œã§ä¸é©åˆ‡ã¯ï¼Ÿ\n1 ç€ç«æºé™¤å»\n2 é¢¨ä¸Šã‹ã‚‰æ¥è¿‘\n3 æ°´ã§ä¸€æ°—ã«æµã™\n4 é€šå ±ãƒ»é€€é¿", "a": "3", "cat": "æ³•ä»¤"},
    {"q": "è’¸æ°—æ¯”é‡>1 ã®è’¸æ°—ã¯ï¼Ÿ\n1 ä¸Šå±¤ã«æºœã¾ã‚‹\n2 ä½æ‰€ã«æºœã¾ã‚‹\n3 ä¸Šæ˜‡æ‹¡æ•£\n4 ç„¡è‡­ã«ãªã‚‹", "a": "2", "cat": "ç‰©ç†åŒ–å­¦"},
    {"q": "ãƒ–ãƒªãƒ¼ã‚¶ãƒ¼ã®ç›®çš„ã¯ï¼Ÿ\n1 åœ§åŠ›å¤‰å‹•èª¿æ•´\n2 æ¶ˆç«\n3 è’¸æ°—å›å\n4 ç€ç«", "a": "1", "cat": "æ€§çŠ¶æ¶ˆç«"},
    {"q": "ç§»é€ã§ä¸é©åˆ‡ã¯ï¼Ÿ\n1 é‡‘å±é…ç®¡ã§æ¥åœ°\n2 ãƒ—ãƒ©å®¹å™¨åŒå£«ã®æ‰‹æŒã¡ç§»é€\n3 é‡‘å±ãƒ›ãƒ¼ã‚¹ã§æ¥åœ°\n4 æ¶²é¢ä¸‹æ³¨å…¥", "a": "2", "cat": "ç‰©ç†åŒ–å­¦"},
    {"q": "ç¬¬1çŸ³æ²¹é¡ã¯ï¼Ÿ\n1 ã‚¬ã‚½ãƒªãƒ³\n2 ç¯æ²¹\n3 è»½æ²¹\n4 é‡æ²¹", "a": "1", "cat": "æ€§çŠ¶æ¶ˆç«"},
    {"q": "ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é¡ã®æŒ‡å®šæ•°é‡ã¯ï¼Ÿ\n1 100L\n2 200L\n3 400L\n4 600L", "a": "3", "cat": "æ³•ä»¤"},
    {"q": "ä¿å®‰æ•™è‚²ã®å¯¾è±¡ã¯ï¼Ÿ\n1 å–æ‰±è€…ã®ã¿\n2 é–¢ä¿‚å¾“æ¥­å“¡\n3 ç½²é•·\n4 è­¦å‚™å“¡ã®ã¿", "a": "2", "cat": "æ³•ä»¤"},
    {"q": "æ³¡åŸæ¶²ã®å¸Œé‡ˆã¯ï¼Ÿ\n1 æ°´ã§å¸Œé‡ˆ\n2 æº¶å‰¤å¸Œé‡ˆ\n3 åŸæ¶²ã®ã¾ã¾\n4 ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«å¸Œé‡ˆ", "a": "1", "cat": "æ€§çŠ¶æ¶ˆç«"},
    {"q": "ATCæ³¡ã®ç”¨é€”ã¯ï¼Ÿ\n1 éæ°´æº¶æ€§ã®ã¿\n2 æ°´æº¶æ€§ã«ã‚‚æœ‰åŠ¹\n3 æ°—ä½“ç«ç½å°‚ç”¨\n4 é‡‘å±ç«ç½å°‚ç”¨", "a": "2", "cat": "æ€§çŠ¶æ¶ˆç«"},
    {"q": "Naã¨æ¥è§¦ä¸å¯ã¯ï¼Ÿ\n1 æ°´\n2 çª’ç´ \n3 ä¹¾ç‡¥ç ‚\n4 CO2", "a": "1", "cat": "æ€§çŠ¶æ¶ˆç«"},
    {"q": "é‹æ¬å®¹å™¨ã®è¡¨ç¤ºã§å¿…é ˆã¯ï¼Ÿ\n1 å“åãƒ»é¡åˆ¥\n2 å¾“æ¥­å“¡å\n3 ä¾¡æ ¼\n4 å–æ‰±æ‰€å›³é¢", "a": "1", "cat": "æ³•ä»¤"},
    {"q": "è‡ªç„¶ç™ºç«ã«ãªã‚Šã«ãã„ã®ã¯ï¼Ÿ\n1 ä¹¾æ€§æ²¹ã‚¦ã‚¨ã‚¹å †ç©\n2 çŸ³ç‚­å¤§é‡å †ç©\n3 ã‚¬ã‚½ãƒªãƒ³å¯†é–‰ä¿ç®¡\n4 æœ¨ç²‰å †ç©", "a": "3", "cat": "æ€§çŠ¶æ¶ˆç«"},
    {"q": "ã‚¢ã‚»ãƒˆãƒ³ã®é¡åˆ¥ã¯ï¼Ÿ\n1 ç¬¬1çŸ³æ²¹é¡(éæ°´)\n2 ç¬¬1çŸ³æ²¹é¡(æ°´)\n3 ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é¡\n4 ç¬¬2çŸ³æ²¹é¡", "a": "2", "cat": "æ€§çŠ¶æ¶ˆç«"},
    {"q": "ãƒˆãƒ«ã‚¨ãƒ³ã®é¡åˆ¥ã¯ï¼Ÿ\n1 ç¬¬1çŸ³æ²¹é¡(éæ°´)\n2 ç¬¬1çŸ³æ²¹é¡(æ°´)\n3 ç¬¬2çŸ³æ²¹é¡\n4 ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é¡", "a": "1", "cat": "æ€§çŠ¶æ¶ˆç«"},
    {"q": "é…¢é…¸ã‚¨ãƒãƒ«ã¯ï¼Ÿ\n1 ç¬¬1çŸ³æ²¹é¡(éæ°´)\n2 ç¬¬1çŸ³æ²¹é¡(æ°´)\n3 ç¬¬2çŸ³æ²¹é¡\n4 ç¬¬3çŸ³æ²¹é¡", "a": "1", "cat": "æ€§çŠ¶æ¶ˆç«"},
    {"q": "ãƒ¡ã‚¿ãƒãƒ¼ãƒ«ã¯ï¼Ÿ\n1 ç¬¬1çŸ³æ²¹é¡\n2 ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é¡\n3 ç¬¬2çŸ³æ²¹é¡\n4 ç¬¬3çŸ³æ²¹é¡", "a": "2", "cat": "æ€§çŠ¶æ¶ˆç«"},
    {"q": "æµå‡ºæ²¹ç«ç½ã®åŸºæœ¬å¯¾å¿œã¯ï¼Ÿ\n1 æ°´ã§æ•£å¸ƒ\n2 æ³¡ã§è¦†ã†\n3 åŠ æ¸©\n4 ç ‚ã‚’ç¦ãš", "a": "2", "cat": "æ€§çŠ¶æ¶ˆç«"},
    {"q": "é™é›»æ°—å¯¾ç­–ã§æœ‰åŠ¹ã¯ï¼Ÿ\n1 ä½æ¹¿åº¦\n2 ã‚¢ãƒ¼ã‚¹ãƒ»ç­‰é›»ä½åŒ–\n3 çµ¶ç¸æ‰‹è¢‹å¤šç”¨\n4 æ¨¹è„‚å®¹å™¨é–“ç§»é€", "a": "2", "cat": "ç‰©ç†åŒ–å­¦"},
    {"q": "è‡ªç„¶ç™ºç«ç‚¹ãŒä½ã„ã®ã¯ä¸€èˆ¬ã«ï¼Ÿ\n1 ã‚¬ã‚½ãƒªãƒ³\n2 ç¯æ²¹\n3 è»½æ²¹\n4 é‡æ²¹", "a": "1", "cat": "ç‰©ç†åŒ–å­¦"},
    {"q": "é‹æ¬ç©è¼‰é‡ã‚’å®šã‚ã‚‹æ³•ã¯ï¼Ÿ\n1 æ¶ˆé˜²æ³•\n2 é“è·¯äº¤é€šæ³•\n3 å®‰è¡›æ³•\n4 å»ºç¯‰åŸºæº–æ³•", "a": "2", "cat": "æ³•ä»¤"},
    {"q": "æŒ‡å®šæ•°é‡æœªæº€ã§ã‚‚å¿…è¦ãªã®ã¯ï¼Ÿ\n1 ä½•ã‚‚ä¸è¦\n2 ä¸€éƒ¨è¦åˆ¶ï¼ˆä¿ç®¡ç­‰ï¼‰\n3 å¿…ãšè¨±å¯\n4 ç¨å‹™å±Šå‡º", "a": "2", "cat": "æ³•ä»¤"},
    {"q": "å¯ç‡ƒè’¸æ°—ã¯ä¸€èˆ¬ã«ï¼Ÿ\n1 ç©ºæ°—ã‚ˆã‚Šè»½ã„\n2 åŒç­‰\n3 ç©ºæ°—ã‚ˆã‚Šé‡ã„\n4 åŒã˜", "a": "3", "cat": "ç‰©ç†åŒ–å­¦"},
    {"q": "æ··åˆã§é¿ã‘ã‚‹ã¹ãã¯ï¼Ÿ\n1 é¡ä¼¼æ€§çŠ¶\n2 æ°´æº¶æ€§ã¨éæ°´æº¶æ€§ã®ä¸ç”¨æ„æ··åˆ\n3 åŒãƒ•ãƒ©ãƒƒã‚·ãƒ¥\n4 åŒæ¯”é‡", "a": "2", "cat": "æ€§çŠ¶æ¶ˆç«"},
    {"q": "æ›æ°—ã®ä¸»ç›®çš„ã¯ï¼Ÿ\n1 æ¹¿åº¦ä½æ¸›\n2 è’¸æ°—æ¿ƒåº¦ä½æ¸›\n3 æ¸©åº¦å·®ä½æ¸›\n4 åœ§åŠ›æå¤±ä½æ¸›", "a": "2", "cat": "æ€§çŠ¶æ¶ˆç«"},
    {"q": "ç™ºç«ç‚¹ã«å½±éŸ¿ã™ã‚‹ã®ã¯ï¼Ÿ\n1 å®¹å™¨è‰²\n2 æ°—æµãƒ»é…¸ç´ æ¿ƒåº¦\n3 å¯†åº¦\n4 æ¯”é‡", "a": "2", "cat": "ç‰©ç†åŒ–å­¦"},
    {"q": "è»½æ²¹ã®é¡åˆ¥ã¯ï¼Ÿ\n1 ç¬¬1çŸ³æ²¹é¡\n2 ç¬¬2çŸ³æ²¹é¡\n3 ç¬¬3çŸ³æ²¹é¡\n4 ç¬¬4çŸ³æ²¹é¡", "a": "2", "cat": "æ€§çŠ¶æ¶ˆç«"},
    {"q": "æ½¤æ»‘æ²¹ã®é¡åˆ¥ã¯ï¼Ÿ\n1 ç¬¬1çŸ³æ²¹é¡\n2 ç¬¬2çŸ³æ²¹é¡\n3 ç¬¬3çŸ³æ²¹é¡\n4 ç¬¬4çŸ³æ²¹é¡", "a": "3", "cat": "æ€§çŠ¶æ¶ˆç«"},
    {"q": "æ²ç¤ºç¾©å‹™ãŒãªã„ã®ã¯ï¼Ÿ\n1 é¡åˆ¥\n2 ç¦æ­¢äº‹é …\n3 å–æ‰±è€…æ°å\n4 é¿é›£çµŒè·¯å›³", "a": "4", "cat": "æ³•ä»¤"},
    {"q": "å¼•ç«ç‚¹ãŒæœ€ã‚‚ä½ã„ã®ã¯ï¼Ÿ\n1 ã‚¬ã‚½ãƒªãƒ³\n2 ç¯æ²¹\n3 è»½æ²¹\n4 ã‚¯ãƒ¬ã‚ªã‚½ãƒ¼ãƒˆæ²¹", "a": "1", "cat": "ç‰©ç†åŒ–å­¦"},
    {"q": "æœè£…ã§ä¸é©åˆ‡ã¯ï¼Ÿ\n1 å¸¯é›»é˜²æ­¢æœ\n2 é™é›»é´\n3 åŒ–ç¹Šãƒ•ãƒªãƒ¼ã‚¹\n4 ç¶¿ä½œæ¥­ç€", "a": "3", "cat": "æ€§çŠ¶æ¶ˆç«"},
    {"q": "å—å…¥æ™‚ã®åŸºæœ¬å‹•ä½œã¯ï¼Ÿ\n1 å…ˆã«ãƒãƒ³ãƒ›ãƒ¼ãƒ«é–‹æ”¾\n2 ã¾ãšæ¥åœ°(ã‚¢ãƒ¼ã‚¹)\n3 å…ˆã«ãƒãƒ«ãƒ–é–‹æ”¾\n4 å‘¨å›²å–«ç…™æ‰€è¨­ç½®", "a": "2", "cat": "æ³•ä»¤"},
    {"q": "æŒ‡å®šæ•°é‡ä»¥ä¸Šã®å–æ‰±æ‰€ã«å¿…é ˆã®è³‡æ ¼è€…ã¯ï¼Ÿ\n1 å±é™ºç‰©å–æ‰±è€…\n2 æ¯’ç‰©åŠ‡ç‰©å–æ‰±è€…\n3 é›»æ°—ä¸»ä»»æŠ€è¡“è€…\n4 ãƒœã‚¤ãƒ©ãƒ¼æŠ€å£«", "a": "1", "cat": "æ³•ä»¤"},
]

# ====== é€²æ—ç®¡ç† ======
# user_id -> {"q_index": int, "score": int, "mode": "ãƒ©ãƒ³ãƒ€ãƒ /æ³•ä»¤/ç‰©ç†/æ€§çŠ¶"}
progress: Dict[str, Dict[str, Any]] = {}

def init_session(uid: str):
    progress[uid] = {"q_index": 0, "score": 0, "mode": "ãƒ©ãƒ³ãƒ€ãƒ "}

def pick_index(state: Dict[str, Any]) -> Optional[int]:
    """ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦æ¬¡ã«å‡ºã™ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿”ã™ã€‚ãªã‘ã‚Œã° Noneã€‚"""
    i = state["q_index"]
    if i >= TOTAL:
        return None
    mode = state.get("mode", "ãƒ©ãƒ³ãƒ€ãƒ ")
    if mode == "ãƒ©ãƒ³ãƒ€ãƒ ":
        return i
    want = {"æ³•ä»¤": "æ³•ä»¤", "ç‰©ç†": "ç‰©ç†åŒ–å­¦", "æ€§çŠ¶": "æ€§çŠ¶æ¶ˆç«"}.get(mode)
    # ç¾åœ¨ä½ç½®ä»¥é™ã§è©²å½“ã‚«ãƒ†ã‚´ãƒªã‚’æ¢ã™
    for j in range(i, len(questions)):
        if questions[j].get("cat") == want:
            return j
    # ãªã‘ã‚Œã°é€šå¸¸ã®é †ç•ª
    return i

# ====== ãƒ˜ãƒ«ãƒ—é€ä¿¡ ======
def send_help(reply_token: str):
    help_text = (
        "ğŸ“˜ ä½¿ã„æ–¹\n"
        "ãƒ»ã€Œé–‹å§‹ã€â†’ å‡ºé¡Œã‚¹ã‚¿ãƒ¼ãƒˆ\n"
        "ãƒ»ã€Œæ¬¡ã®å•é¡Œã€â†’ æ¬¡ã®å•é¡Œã‚’å‡ºé¡Œ\n"
        "ãƒ»ã€Œãƒªã‚»ãƒƒãƒˆã€â†’ æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—\n\n"
        "ğŸ¯ å‡ºé¡Œãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ï¼ˆãƒˆãƒ¼ã‚¯ã§é€ã‚‹ã ã‘ï¼‰\n"
        "ãƒ»ã€Œæ³•ä»¤ã€â†’ æ³•ä»¤åˆ†é‡ã ã‘å‡ºé¡Œ\n"
        "ãƒ»ã€Œç‰©ç†ã€â†’ ç‰©ç†åŒ–å­¦åˆ†é‡ã ã‘å‡ºé¡Œ\n"
        "ãƒ»ã€Œæ€§çŠ¶ã€â†’ æ€§çŠ¶ãƒ»æ¶ˆç«åˆ†é‡ã ã‘å‡ºé¡Œ\n"
        "ãƒ»ã€Œãƒ©ãƒ³ãƒ€ãƒ ã€â†’ å…¨ä½“ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œï¼ˆé€šå¸¸ï¼‰\n\n"
        "ğŸ“ æˆç¸¾è¡¨ç¤º\n"
        f"ãƒ»{MID}å•ç›®ã¨{TOTAL}å•ç›®ã§ç·æ‹¬ã‚’è¡¨ç¤º\n"
    )
    line_bot_api.reply_message(reply_token, TextSendMessage(text=help_text))

# ====== ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ ======
@app.get("/health")
def health():
    return {"status": "ok"}

# ====== LINE Webhook ======
@app.post("/callback")
async def callback(request: Request):
    signature = request.headers.get("X-Line-Signature", "")
    body = (await request.body()).decode("utf-8")
    try:
        handler.handle(body, signature)
    except Exception:
        raise HTTPException(status_code=400, detail="Invalid signature or parse error")
    return JSONResponse({"ok": True})

@handler.add(MessageEvent, message=TextMessage)
def on_message(event: MessageEvent):
    uid = event.source.user_id
    text = (event.message.text or "").strip()

    first_time = False
    if uid not in progress:
        init_session(uid)
        first_time = True

    st = progress[uid]

    # åˆå›ã¯ãƒ˜ãƒ«ãƒ—ã‚’è‡ªå‹•è¡¨ç¤ºã—ã¦çµ‚äº†
    if first_time:
        send_help(event.reply_token)
        return

    # ===== ã‚³ãƒãƒ³ãƒ‰ =====
    if text in ("ãƒªã‚»ãƒƒãƒˆ", "reset"):
        init_session(uid)
        send_help(event.reply_token)  # ãƒªã‚»ãƒƒãƒˆæ™‚ã‚‚ãƒ˜ãƒ«ãƒ—è‡ªå‹•è¡¨ç¤º
        return

    if text in ("ãƒ˜ãƒ«ãƒ—", "help", "ï¼Ÿ", "?"):
        send_help(event.reply_token)
        return

    if text in ("æ³•ä»¤", "ç‰©ç†", "æ€§çŠ¶", "ãƒ©ãƒ³ãƒ€ãƒ "):
        st["mode"] = text
        line_bot_api.reply_message(
            event.reply_token,
            TextSendMessage(text=f"å‡ºé¡Œãƒ¢ãƒ¼ãƒ‰ã‚’ã€Œ{text}ã€ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚")
        )
        return

    if text in ("é–‹å§‹", "æ¬¡ã®å•é¡Œ"):
        idx = pick_index(st)
        if idx is None:
            line_bot_api.reply_message(
                event.reply_token,
                TextSendMessage(text="âœ… å…¨å•é¡Œçµ‚äº†ã€‚ã€Œãƒªã‚»ãƒƒãƒˆã€ã§å†æŒ‘æˆ¦ã§ãã¾ã™ã€‚")
            )
            return
        qno = st["q_index"] + 1
        q = questions[idx]["q"]
        line_bot_api.reply_message(
            event.reply_token,
            TextSendMessage(text=f"Q{qno}/{TOTAL}\n{q}")
        )
        return

    # ===== å›ç­”ï¼ˆ1ï½4ãƒ»å…¨è§’å¯¾å¿œï¼‰ =====
    if text in ("1", "2", "3", "4", "ï¼‘", "ï¼’", "ï¼“", "ï¼”"):
        trans = str.maketrans("ï¼‘ï¼’ï¼“ï¼”", "1234")
        ans = text.translate(trans)

        idx = pick_index(st)
        if idx is None:
            line_bot_api.reply_message(
                event.reply_token,
                TextSendMessage(text="âœ… å…¨å•é¡Œçµ‚äº†ã€‚ã€Œãƒªã‚»ãƒƒãƒˆã€ã§å†æŒ‘æˆ¦ã§ãã¾ã™ã€‚")
            )
            return

        correct = questions[idx]["a"]
        ok = (ans == correct)
        if ok:
            st["score"] += 1
        st["q_index"] += 1

        msg = "â­• æ­£è§£ï¼" if ok else f"âŒ ä¸æ­£è§£â€¦ æ­£è§£ã¯ {correct}"

        # ç·æ‹¬ï¼ˆ25å•ãƒ»50å•ï¼‰
        if st["q_index"] in (MID, TOTAL):
            total = st["q_index"]
            rate = st["score"] / total * 100
            msg += f"\nğŸ“Š {total}å•çµ‚äº†ï¼š{st['score']}/{total}ï¼ˆ{rate:.1f}%ï¼‰"

        # æ¬¡ã¸ or çµ‚äº†æ–‡
        if st["q_index"] < TOTAL:
            msg += f"\n\nã€æ¬¡ã®å•é¡Œã€ã§ç¶šãã¸ã€‚"
        else:
            msg += "\nâœ… å…¨å•é¡Œçµ‚äº†ã€‚ã€Œãƒªã‚»ãƒƒãƒˆã€ã§æœ€åˆã‹ã‚‰ã€‚"

        line_bot_api.reply_message(
            event.reply_token,
            TextSendMessage(text=msg, quick_reply=quick_reset_help())
        )
        return

    # ===== ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¿œç­” =====
    send_help(event.reply_token)
