import os
from flask import Flask, request, abort, Response
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import (
    MessageEvent, TextMessage, TextSendMessage, FlexSendMessage,
    QuickReply, QuickReplyButton, MessageAction, URIAction
)

app = Flask(__name__)

# ---- LINE Secrets ----
LINE_CHANNEL_ACCESS_TOKEN = os.getenv("LINE_CHANNEL_ACCESS_TOKEN")
LINE_CHANNEL_SECRET = os.getenv("LINE_CHANNEL_SECRET")
line_bot_api = LineBotApi(LINE_CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(LINE_CHANNEL_SECRET)

# ---- In-memory session (ç°¡æ˜“) ----
sessions = {}  # {user_id: {"index": int, "score": int, "answered": int}}

def sess(user_id):
    if user_id not in sessions:
        sessions[user_id] = {"index": 0, "score": 0, "answered": 0}
    return sessions[user_id]

# ---- ä¹™4 éå»å•é¢¨ 50å•ï¼ˆæ•°å­—ã‚’é¿ã‘ãŸæ¦‚å¿µä¸­å¿ƒãƒ»èª¤ã‚Šã«ãã„å†…å®¹ï¼‰----
# ans ã¯ 1~4 ã®æ•´æ•°
questions = [
    {"q": "å¼•ç«ç‚¹ã¨ã¯ï¼Ÿ", "choices": ["è‡ªç„¶ã«ç‡ƒãˆå‡ºã™æ¸©åº¦", "ç«æºãŒã‚ã‚Œã°ç‡ƒãˆã‚‹æœ€ã‚‚ä½ã„æ¸©åº¦", "æ²¸é¨°ã‚’å§‹ã‚ã‚‹æ¸©åº¦", "ç‡ƒç„¼ãŒç¶™ç¶šã™ã‚‹æ¸©åº¦"], "ans": 2, "exp": "å¼•ç«ç‚¹ã¯ç«æºãŒã‚ã‚‹ã¨è’¸æ°—ã«ç€ç«ã™ã‚‹æœ€ä½æ¸©åº¦ã€‚"},
    {"q": "ç™ºç«ç‚¹ã¨ã¯ï¼Ÿ", "choices": ["è‡ªç„¶ã«ç‡ƒãˆå‡ºã™æœ€ä½æ¸©åº¦", "é‹ãŒç†±ããªã‚‹æ¸©åº¦", "æ¶²ä½“ãŒæ²¸é¨°ã™ã‚‹æ¸©åº¦", "å›ºä½“ãŒæº¶ã‘ã‚‹æ¸©åº¦"], "ans": 1, "exp": "å¤–éƒ¨ç«æºãªã—ã§è‡ªç„¶ã«ç™ºç«ã™ã‚‹æœ€ä½æ¸©åº¦ã€‚"},
    {"q": "å¯ç‡ƒæ€§è’¸æ°—ã¯ç©ºæ°—ã‚ˆã‚Šé‡ã„ã“ã¨ãŒå¤šãã€ä½•ã«ãŸã¾ã‚Šã‚„ã™ã„ï¼Ÿ", "choices": ["é«˜ã„å ´æ‰€", "ä½ã„å ´æ‰€", "ã©ã“ã«ã‚‚ãŸã¾ã‚‰ãªã„", "æ°´é¢ä¸Š"], "ans": 2, "exp": "å¤šãã®å¯ç‡ƒæ€§è’¸æ°—ã¯æ¯”é‡ãŒç©ºæ°—ã‚ˆã‚Šå¤§ããä½æ‰€ã¸æ»ç•™ã€‚"},
    {"q": "é™é›»æ°—ã«ã‚ˆã‚‹ç«èŠ±æ”¾é›»ã‚’é˜²ãåŸºæœ¬ã¯ï¼Ÿ", "choices": ["æ›æ°—ã‚’æ­¢ã‚ã‚‹", "æ¥åœ°ãƒ»ç­‰é›»ä½åŒ–", "åŠ ç†±ã™ã‚‹", "æ¹¿åº¦ã‚’ä¸‹ã’ã‚‹"], "ans": 2, "exp": "æ¥åœ°ãƒ»ç­‰é›»ä½åŒ–ã¨æ¹¿åº¦ç®¡ç†ãŒæœ‰åŠ¹ã€‚"},
    {"q": "ç¬¬4é¡å±é™ºç‰©ã®å…±é€šæ€§è³ªã¯ï¼Ÿ", "choices": ["é…¸åŒ–æ€§ãŒå¼·ã„", "å¯ç‡ƒæ€§ã®æ¶²ä½“", "æ¯’æ€§ãŒå¼·ã„", "è…é£Ÿæ€§ã®ã¿"], "ans": 2, "exp": "ä¹™4ã¯ã€å¯ç‡ƒæ€§æ¶²ä½“ã€ã‚’æ‰±ã†è³‡æ ¼ã€‚"},
    {"q": "ç‡ƒç„¼ã®ä¸‰è¦ç´ ã¯ï¼Ÿ", "choices": ["ç†±ãƒ»é…¸ç´ ãƒ»å¯ç‡ƒç‰©", "ç†±ãƒ»çª’ç´ ãƒ»å¯ç‡ƒç‰©", "å…‰ãƒ»é…¸ç´ ãƒ»æ°´", "é›»æ°—ãƒ»æ°´ãƒ»é¢¨"], "ans": 1, "exp": "ç†±æºãƒ»é…¸ç´ ä¾›çµ¦ãƒ»å¯ç‡ƒç‰©ãŒå¿…è¦ã€‚"},
    {"q": "æ°´ã§æ¶ˆç«ã—ã¦ã¯ã„ã‘ãªã„ã®ã¯ï¼Ÿ", "choices": ["æ²¹ç«ç½", "ç´™ã®ç«ç½", "æœ¨æã®ç«ç½", "å¸ƒã®ç«ç½"], "ans": 1, "exp": "æ²¹ã¯æ°´ã«æµ®ãé£›æ•£ã—æ‹¡å¤§ã™ã‚‹ã€‚"},
    {"q": "æ³¡æ¶ˆç«è–¬å‰¤ã®ä¸»ç›®çš„ã¯ï¼Ÿ", "choices": ["é…¸ç´ ä¾›çµ¦", "å†·å´", "çª’æ¯ãƒ»é®æ–­ã¨å†·å´", "åŠ ç†±"], "ans": 3, "exp": "è¡¨é¢ã«è†œã‚„æ³¡å±¤ã‚’ä½œã‚Šçª’æ¯ï¼‹å†·å´ã€‚"},
    {"q": "é‡‘å±ãƒŠãƒˆãƒªã‚¦ãƒ ã«é©ã•ãªã„æ¶ˆç«å‰¤ã¯ï¼Ÿ", "choices": ["ä¹¾ç‡¥ç ‚", "ç²‰æœ«", "æ°´", "é‡‘å±ç«ç½ç”¨ç²‰æœ«"], "ans": 3, "exp": "æ°´ã¨æ¿€ã—ãåå¿œã—å±é™ºã€‚"},
    {"q": "è’¸æ°—åœ§ãŒé«˜ã„æ¶²ä½“ã¯ä¸€èˆ¬ã«ï¼Ÿ", "choices": ["æ°—åŒ–ã—ã«ãã„", "æ°—åŒ–ã—ã‚„ã™ã„", "å¼•ç«ã—ãªã„", "æ²¸ç‚¹ãŒå¿…ãšé«˜ã„"], "ans": 2, "exp": "è’¸æ°—åœ§ãŒé«˜ã„ã»ã©è’¸ç™ºã—ã‚„ã™ã„ã€‚"},
    {"q": "æ›æ°—ã®ç›®çš„ã§æ­£ã—ã„ã®ã¯ï¼Ÿ", "choices": ["è’¸æ°—æ¿ƒåº¦ã‚’ä¸Šã’ã‚‹", "è’¸æ°—ã‚’å¸Œé‡ˆãƒ»æ’å‡ºã™ã‚‹", "æ¸©åº¦ã‚’ä¸Šã’ã‚‹", "é™é›»æ°—ã‚’ç™ºç”Ÿã•ã›ã‚‹"], "ans": 2, "exp": "ç™ºç”Ÿè’¸æ°—ã‚’å¸Œé‡ˆæ’å‡ºã—çˆ†ç™ºé™ç•Œæœªæº€ã¸ã€‚"},
    {"q": "å±é™ºç‰©æ¨™è­˜ã€ç«æ°—å³ç¦ã€ã®è‰²ã¯ï¼Ÿ", "choices": ["é’åœ°ç™½å­—", "èµ¤åœ°ç™½å­—", "ç·‘åœ°ç™½å­—", "é»„åœ°é»’å­—"], "ans": 2, "exp": "èµ¤åœ°ç™½å­—ãŒä¸€èˆ¬çš„ã€‚"},
    {"q": "å±é™ºç‰©ã®é¡åˆ¥è¡¨ç¤ºã§ã€ç¬¬4é¡ã€ã®è‰²ã¯ï¼Ÿ", "choices": ["é’", "èµ¤", "é»„", "ç·‘"], "ans": 1, "exp": "é¡åˆ¥æ¨™è­˜ã¯ç¬¬1é¡ï¼šé»„ã€ç¬¬2ï¼šé»„ã€ç¬¬3ï¼šé’ã€ç¬¬4ï¼šé’ ãªã©è‡ªæ²»ä½“æ§˜å¼ã«æº–ãšã€‚"},
    {"q": "å¼•ç«ç‚¹ãŒä½ã„ã»ã©ï¼Ÿ", "choices": ["å±é™ºæ€§ã¯ä½ã„", "å±é™ºæ€§ã¯é«˜ã„", "å¤‰ã‚ã‚‰ãªã„", "ç‡ƒãˆãªã„"], "ans": 2, "exp": "ä½æ¸©ã§ã‚‚ç€ç«ã—ã‚„ã™ãå±é™ºæ€§ãŒé«˜ã„ã€‚"},
    {"q": "æŒ‡å®šæ•°é‡ã®æ„ç¾©ã¯ï¼Ÿ", "choices": ["æœ€å¤§ä¿ç®¡å¯èƒ½é‡", "æ³•è¦åˆ¶å¼·åŒ–ã®å¢ƒç•Œé‡", "è²©å£²ä¾¡æ ¼", "æ¯”é‡"], "ans": 2, "exp": "æŒ‡å®šæ•°é‡ä»¥ä¸Šã¯è¨±å¯ãƒ»è¨­å‚™ãŒå¿…è¦ã€‚"},
    {"q": "å±é™ºç‰©ã®è²¯è”µæ‰€ã§å®¹å™¨ã«æ±‚ã‚ã‚‰ã‚Œã‚‹ã®ã¯ï¼Ÿ", "choices": ["å¼·åº¦ãƒ»æ°—å¯†ãƒ»è¡¨ç¤º", "é€æ˜ã§è»½ã„ã“ã¨", "é‡‘å±è£½ã®ã¿", "ç´™è£½ã®ã¿"], "ans": 1, "exp": "å†…å®¹ç‰©é©åˆã®æè³ªãƒ»å¼·åº¦ãƒ»è¡¨ç¤ºãŒå¿…è¦ã€‚"},
    {"q": "å±‹å†…è²¯è”µæ‰€ã§åŸå‰‡å¿…è¦ãªè¨­å‚™ã¯ï¼Ÿ", "choices": ["åŠ ç†±ç‚‰", "æ›æ°—è¨­å‚™ãƒ»æ¶ˆç«è¨­å‚™", "å†·è”µåº«ã®ã¿", "é£¾ã‚Šæ£š"], "ans": 2, "exp": "è‡ªç„¶æ›æ°—/æ©Ÿæ¢°æ›æ°—ã‚„æ¶ˆç«è¨­å‚™ãŒå¿…è¦ã€‚"},
    {"q": "å±é™ºç‰©ã®é‹æ¬ã§æ³¨æ„ã™ã¹ãã¯ï¼Ÿ", "choices": ["å®¹å™¨ã®è»¢å€’é˜²æ­¢", "å¯†æ “ã—ãªã„", "ãƒ©ãƒ™ãƒ«é™¤å»", "æ—¥å…‰ã«å½“ã¦ã‚‹"], "ans": 1, "exp": "å …å›ºã«å›ºå®šã—å¯†æ “ãƒ»è¡¨ç¤ºã‚’ä¿æŒã€‚"},
    {"q": "ä½œæ¥­å‰ã®é™é›»æ°—å¯¾ç­–ã§æœ‰åŠ¹ãªã®ã¯ï¼Ÿ", "choices": ["åˆæˆç¹Šç¶­ã®ç€ç”¨", "å°é›»é´ãƒ»æ¥åœ°", "ä¹¾ç‡¥ç’°å¢ƒ", "ãƒ“ãƒ‹ãƒ¼ãƒ«æ‰‹è¢‹"], "ans": 2, "exp": "å°é›»æ€§ã®å±¥ç‰©ãƒ»åºŠãƒ»æ¥åœ°ãŒåŸºæœ¬ã€‚"},
    {"q": "æ²¹å¸ç€æã®å‡¦ç†ã§æ­£ã—ã„ã®ã¯ï¼Ÿ", "choices": ["æ’æ°´ã¸æµã™", "å¯ç‡ƒã”ã¿", "å±é™ºç‰©ã¨ã—ã¦é©æ­£å‡¦ç†", "ä¹¾ç‡¥ã•ã›ã¦æ”¾ç½®"], "ans": 3, "exp": "æ±šæŸ“ç‰©ã‚‚å±é™ºç‰©ã«æº–ã˜ç®¡ç†ã€‚"},
    # 20
    {"q": "è’¸æ°—ã¯ã©ã“ã«æ»ç•™ã—ã‚„ã™ã„ï¼Ÿ", "choices": ["å¤©äº•ä»˜è¿‘", "åºŠä»˜è¿‘", "çª“ä»˜è¿‘", "å±‹å¤–ã®ã¿"], "ans": 2, "exp": "æ¯”é‡ãŒå¤§ãã„è’¸æ°—ã¯ä½æ‰€ã«æ»ç•™ã€‚"},
    {"q": "æ¼ãˆã„æ™‚ã®ç¬¬ä¸€è¡Œå‹•ã¯ï¼Ÿ", "choices": ["ã‚¹ãƒãƒ›æ’®å½±", "å–«ç…™", "ç€ç«æºæ’é™¤ã¨æ›æ°—ãƒ»é¿é›£", "åŠ ç†±"], "ans": 3, "exp": "ç€ç«æºé™¤å»ãƒ»æ’æ°—ãƒ»å®‰å…¨ç¢ºä¿ãŒæœ€å„ªå…ˆã€‚"},
    {"q": "é‡‘å±å®¹å™¨ã®æ¶²é¢è¨ˆæ¸¬ã§å®‰å…¨ãªã®ã¯ï¼Ÿ", "choices": ["è£¸é›»çƒã‚’å…¥ã‚Œã‚‹", "é‰„æ£’ã§æ’¹æ‹Œ", "å°é›»æ€§ã®ã‚ã‚‹ã‚¢ãƒ¼ã‚¹æ¸ˆã¿è¨ˆå™¨", "ç«ã‚’è¿‘ã¥ã‘ã‚‹"], "ans": 3, "exp": "é™é›»ç«èŠ±ã‚’é˜²ãã€‚"},
    {"q": "å¯ç‡ƒæ€§è’¸æ°—ã®çˆ†ç™ºä¸‹é™ç•Œã‚ˆã‚Šä¸‹ã®æ¿ƒåº¦ã§ã¯ï¼Ÿ", "choices": ["ç‡ƒç„¼ã—ãªã„", "å¸¸ã«çˆ†ç™ºã™ã‚‹", "å¿…ãšè‡ªç„¶ç™ºç«", "è‰²ãŒå¤‰ã‚ã‚‹"], "ans": 1, "exp": "ä¸‹é™ç•Œæœªæº€ã§ã¯å¯ç‡ƒç¯„å›²å¤–ã€‚"},
    {"q": "å®¹å™¨ãƒ©ãƒ™ãƒ«ã®åŸºæœ¬æƒ…å ±ã¯ï¼Ÿ", "choices": ["è£½é€ è€…ã®è¶£å‘³", "å†…å®¹ç‰©åãƒ»å±é™ºåŒºåˆ†ãƒ»æ³¨æ„", "ä¾¡æ ¼ã®ã¿", "QRã®ã¿"], "ans": 2, "exp": "å†…å®¹ç‰©/é¡é …/æ³¨æ„/é€£çµ¡å…ˆãªã©ã€‚"},
    {"q": "ç«ç½å››åˆ†é¡ã§æ²¹ç«ç½ã¯ï¼Ÿ", "choices": ["A(æ™®é€š)", "B(æ²¹)", "C(é›»æ°—)", "D(é‡‘å±)"], "ans": 2, "exp": "æ²¹ç«ç½ã¯Bç«ç½ã€‚"},
    {"q": "é›»æ°—ç«ç½ã¸ã®æ°´å™´éœ§ã¯ï¼Ÿ", "choices": ["æ„Ÿé›»ã®æã‚Œ", "å®‰å…¨", "æ¨å¥¨", "å¿…é ˆ"], "ans": 1, "exp": "æ„Ÿé›»ãƒ»çŸ­çµ¡ã®æã‚Œã€‚é›»æºé®æ–­ã‚’å„ªå…ˆã€‚"},
    {"q": "æ›æ°—æ‰‡ã®ã‚¹ã‚¤ãƒƒãƒæ“ä½œã¯æ¼ãˆã„æ™‚ã«ï¼Ÿ", "choices": ["ç«èŠ±ã®æã‚Œã«æ³¨æ„", "å¿…ãšå…¥ã‚Œã‚‹", "å¿…ãšåˆ‡ã‚‹", "é–¢ä¿‚ãªã„"], "ans": 1, "exp": "é˜²çˆ†ã§ãªã„ã‚¹ã‚¤ãƒƒãƒæ“ä½œã¯ç«èŠ±è¦æ³¨æ„ã€‚"},
    {"q": "é˜²çˆ†æ§‹é€ æ©Ÿå™¨ã®ç›®çš„ã¯ï¼Ÿ", "choices": ["è€éœ‡", "ç€ç«æºæŠ‘æ­¢", "é˜²æ°´", "é®éŸ³"], "ans": 2, "exp": "çˆ†ç™ºæ€§é›°å›²æ°—ã§ã®ç€ç«æºæŠ‘åˆ¶ã€‚"},
    {"q": "çš®è†šã«æº¶å‰¤ãŒä»˜ã„ãŸã‚‰ï¼Ÿ", "choices": ["ä¹¾ãã¾ã§æ”¾ç½®", "ç«ã§ã‚ã¶ã‚‹", "å¤§é‡ã®æ°´ã§æ´—ã†", "å¸ƒã§ã“ã™ã‚‹"], "ans": 3, "exp": "æµæ°´ã§é€Ÿã‚„ã‹ã«æ´—æµ„ã€‚"},
    # 30
    {"q": "å¯ç‡ƒæ¶²ä½“ã®ä¿ç®¡æ¸©åº¦ã§æœ›ã¾ã—ã„ã®ã¯ï¼Ÿ", "choices": ["é«˜æ¸©", "ç›´å°„æ—¥å…‰", "å¸¸æ¸©ãƒ»ä½æ¸©ã§å®‰å®š", "åŠ ç†±ä¿æŒ"], "ans": 3, "exp": "æ¸©åº¦ä¸Šæ˜‡ã¯è’¸æ°—å¢—åŠ ï¼å±é™ºã€‚"},
    {"q": "å®¹å™¨ã®ã‚¢ãƒ¼ã‚¹ç·šã¯ï¼Ÿ", "choices": ["é£¾ã‚Š", "ç­‰é›»ä½çµåˆã«å¿…è¦", "ä¸è¦", "çµ¶ç¸ã™ã¹ã"], "ans": 2, "exp": "å®¹å™¨ãƒ»é…ç®¡ãƒ»æ©Ÿå™¨ã‚’ç­‰é›»ä½åŒ–ã€‚"},
    {"q": "é–‹æ”¾ç³»ã§ã®æ¶²ç§»é€ä¸­ã«å±é™ºãªè¡Œç‚ºã¯ï¼Ÿ", "choices": ["æ¥åœ°", "é‡‘å±åŒå£«ã®æ¥è§¦ç¶­æŒ", "ãƒãƒªå®¹å™¨ã‚’ç©ºä¸­ã§æ³¨ã", "é™ã‹ã«æ³¨ã"], "ans": 3, "exp": "ç©ºä¸­æ³¨ãã¯å¸¯é›»ãƒ»é£›æ•£ã‚’æ‹›ãã€‚"},
    {"q": "æ²¹ã®è‡ªç„¶ç™ºç«ã‚’æ‹›ãã®ã¯ï¼Ÿ", "choices": ["é…¸ç´ ä¸è¶³", "å«æµ¸ã—ãŸã‚¦ã‚¨ã‚¹ã®æ”¾ç½®", "å†·å‡ä¿å­˜", "æ°´æ¿¡ã‚Œ"], "ans": 2, "exp": "ä¹¾æ€§æ²¹ã‚’å«ã‚“ã å¸ƒã®å±±ã¯å±é™ºã€‚"},
    {"q": "ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é¡ã®ç‰¹å¾´ã¯ï¼Ÿ", "choices": ["æ°´ã«æº¶ã‘ãªã„", "æ°´ã«æº¶ã‘ã‚„ã™ã„ã‚‚ã®ãŒå¤šã„", "å›ºä½“ãŒå¤šã„", "å¯ç‡ƒæ€§ãŒãªã„"], "ans": 2, "exp": "å¤šãã¯æ°´æ··å’Œæ€§ã§å¯ç‡ƒã€‚"},
    {"q": "æ¶ˆé˜²æ³•ã§ã€å±‹å¤–ã‚¿ãƒ³ã‚¯è²¯è”µæ‰€ã€ã®åˆ©ç‚¹ã¯ï¼Ÿ", "choices": ["è¿‘éš£å½±éŸ¿å¤§", "è‡ªç„¶æ›æ°—ã—ã‚„ã™ã„", "å±‹å†…ã‚ˆã‚Šè’¸æ°—ãŒã“ã‚‚ã‚‹", "é›¨æ°´ã§æº€ãŸã™"], "ans": 2, "exp": "é–‹æ”¾ç©ºé–“ã§è’¸æ°—æ»ç•™ã—ã«ãã„ã€‚"},
    {"q": "å°‘é‡å±é™ºç‰©ã®æ‰±ã„ã¯ï¼Ÿ", "choices": ["è¦åˆ¶ãŒå…¨ããªã„", "éƒ½é“åºœçœŒæ¡ä¾‹ã§åŸºæº–ã‚ã‚Š", "è‡ªç”±ã«é‡ç©ã¿", "åç§°è¡¨ç¤ºä¸è¦"], "ans": 2, "exp": "æ¡ä¾‹ã«åŸºã¥ãåŸºæº–ãŒå®šã‚ã‚‰ã‚Œã‚‹ã€‚"},
    {"q": "ç§»é€ãƒãƒ³ãƒ—åœæ­¢æ™‚ã®æ‰‹é †ã¯ï¼Ÿ", "choices": ["é›»æºOFFã®ã¿", "å¸è¾¼ç®¡é–‹æ”¾", "ãƒãƒ«ãƒ–é–‰ï¼†é›»æºOFF", "é–‹æ”¾ã—ã¦æ”¾ç½®"], "ans": 3, "exp": "ãƒãƒ«ãƒ–é–‰æ­¢ãƒ»é›»æºé®æ–­ãªã©å®‰å…¨æ“ä½œã€‚"},
    {"q": "æ²¹é¡ã®æ¯”é‡ã¯ä¸€èˆ¬ã«ï¼Ÿ", "choices": ["æ°´ã‚ˆã‚Šé‡ã„", "æ°´ã¨åŒã˜", "æ°´ã‚ˆã‚Šè»½ã„ã‚‚ã®ãŒå¤šã„", "å¿…ãšæ°—ä½“"], "ans": 3, "exp": "å¤šãã¯æ°´ã‚ˆã‚Šè»½ãæ°´é¢ã«æµ®ãã€‚"},
    {"q": "æ²¸ç‚¹ãŒä½ã„æ¶²ä½“ã¯ï¼Ÿ", "choices": ["è’¸æ°—ãŒå‡ºã«ãã„", "è’¸æ°—ãŒå‡ºã‚„ã™ã„", "å¯ç‡ƒæ€§ãŒãªã„", "å›ºä½“åŒ–ã™ã‚‹"], "ans": 2, "exp": "æ°—åŒ–ã—ã‚„ã™ãæ³¨æ„ã€‚"},
    # 40
    {"q": "çˆ†ç™ºä¸Šé™ç•Œã‚’è¶…ãˆã‚‹é«˜æ¿ƒåº¦ã§ã¯ï¼Ÿ", "choices": ["çˆ†ç™ºã—ãªã„å ´åˆãŒã‚ã‚‹", "å¿…ãšçˆ†ç™º", "ç‡ƒãˆãªã„", "é’è‰²ã«ãªã‚‹"], "ans": 1, "exp": "æ¿ƒã™ãã¦ã‚‚é…¸ç´ ä¸è¶³ã§ç‡ƒãˆã«ãã„ã€‚"},
    {"q": "å±€æ‰€æ’æ°—ãƒ•ãƒ¼ãƒ‰ã®ç›®çš„ã¯ï¼Ÿ", "choices": ["è’¸æ°—ã‚’æ•é›†ãƒ»æ’å‡º", "åŠ æ¹¿", "åŠ ç†±", "ç‚¹ç«"], "ans": 1, "exp": "ç™ºç”Ÿæºè¿‘å‚ã§æ•é›†ã—æ‹¡æ•£é˜²æ­¢ã€‚"},
    {"q": "å®¹å™¨æ´—æµ„ã§é¿ã‘ã‚‹ã®ã¯ï¼Ÿ", "choices": ["å¯†é–‰ç©ºé–“ã§ã®ä½œæ¥­", "æ›æ°—", "é˜²è­·å…·", "è¡¨ç¤ºæ®‹ã—"], "ans": 1, "exp": "é…¸æ¬ ãƒ»è’¸æ°—æš´éœ²ã®å±é™ºã€‚"},
    {"q": "å®‰å…¨ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆ(SDS)ã®ç›®çš„ã¯ï¼Ÿ", "choices": ["ä¾¡æ ¼äº¤æ¸‰", "ç‰©æ€§ãƒ»å±é™ºæ€§ãƒ»å¿œæ€¥æªç½®ç­‰ã®æƒ…å ±æä¾›", "åºƒå‘Š", "åœ¨åº«ç®¡ç†"], "ans": 2, "exp": "SDSã§å±é™ºæ€§ã‚„å¯¾ç­–ã‚’å…±æœ‰ã€‚"},
    {"q": "ä¿è­·å…·ã§æœ€å„ªå…ˆã¯ï¼Ÿ", "choices": ["ãŠã—ã‚ƒã‚Œ", "ç”¨é€”é©åˆã®é¸å®š", "ã‚µã‚¤ã‚ºè‡ªç”±", "ä½¿ã„æ¨ã¦å¿…é ˆ"], "ans": 2, "exp": "ç‰©è³ªãƒ»ä½œæ¥­ã«å¿œã˜ãŸé©åˆãŒé‡è¦ã€‚"},
    {"q": "é›·æ³¨æ„å ±æ™‚ã®å±‹å¤–ç§»é€ã¯ï¼Ÿ", "choices": ["ç©æ¥µçš„ã«è¡Œã†", "ç«èŠ±å¯¾ç­–ã‚’å¼·åŒ–ãƒ»å»¶æœŸæ¤œè¨", "å½±éŸ¿ãªã—", "å¿…ãšä¸­æ­¢"], "ans": 2, "exp": "èª˜å°é›·ãƒ»é™é›»æ°—ã«æ³¨æ„ã€‚"},
    {"q": "å®¹å™¨ã®ä¿ç®¡å§¿å‹¢ã§æœ›ã¾ã—ã„ã®ã¯ï¼Ÿ", "choices": ["ä¸å®‰å®šã§ã‚‚OK", "è»¢å€’é˜²æ­¢ãƒ»ç›´ç«‹", "å¸¸ã«æ¨ªå€’ã—", "è“‹ã‚’ç·©ã‚ã‚‹"], "ans": 2, "exp": "è»¢å€’é˜²æ­¢ãƒ»å¯†æ “ãƒ»è¡¨ç¤ºé¢å¤–å‘ãç­‰ã€‚"},
    {"q": "æ¼ã‚Œã®è¦‹ã¤ã‘æ–¹ã§å±é™ºãªã®ã¯ï¼Ÿ", "choices": ["æ³¡ç«‹ã¡è©¦é¨“", "è‡­æ°—ã®ç¢ºèª", "ç«ã‚’è¿‘ã¥ã‘ã‚‹", "æ¤œçŸ¥å™¨ä½¿ç”¨"], "ans": 3, "exp": "ç€ç«ã®æã‚Œã€‚"},
    {"q": "ã“ã¼ã‚ŒãŸæ²¹ã®åˆæœŸå¯¾å¿œã¯ï¼Ÿ", "choices": ["æ°´ã§æµã™", "å¸ç€æã§å›²ã„å›å", "æ‰‡é¢¨æ©Ÿã§é£›ã°ã™", "æ”¾ç½®"], "ans": 2, "exp": "å¸ç€ãƒ»å›²ã„è¾¼ã¿ãƒ»å›åãƒ»é©æ­£å‡¦ç†ã€‚"},
    {"q": "æ•™è‚²ãƒ»è¨“ç·´ã®ç›®çš„ã¯ï¼Ÿ", "choices": ["è¨˜å¿µå†™çœŸ", "å±é™ºã®ç†è§£ã¨æ‰‹é †éµå®ˆ", "æ‡‡è¦ª", "ä¼‘æš‡å–å¾—"], "ans": 2, "exp": "æ‰‹é †ç†è§£ã¨å®Ÿè¡ŒãŒäº‹æ•…é˜²æ­¢ã«ç›´çµã€‚"},
    # 50
]
TOTAL = len(questions)

# ---- Flex builders ----
def flex_mid_summary(score, answered, base_url):
    return {
        "type": "bubble",
        "size": "mega",
        "header": {"type": "box", "layout": "vertical", "contents": [
            {"type": "text", "text": "ğŸ‰ 25å•ã‚¯ãƒªã‚¢ï¼", "weight": "bold", "size": "lg"}
        ]},
        "body": {"type": "box", "layout": "vertical", "contents": [
            {"type": "text", "text": f"ã“ã“ã¾ã§ã®æ­£è§£æ•°ï¼š{score}/{answered}"},
            {"type": "text", "text": f"æ­£ç­”ç‡ï¼š{round(100*score/max(1,answered))}%"},
            {"type": "separator", "margin": "md"},
            {"type": "text", "text": "ç¶šãã¯ã€æ¬¡ã®å•é¡Œã€ã§ã©ã†ãã€‚", "wrap": True}
        ]},
        "footer": {"type": "box", "layout": "vertical", "spacing": "sm", "contents": [
            {"type": "button", "action": {"type": "uri", "label": "ãŠç¥ã„ã‚’è¦‹ã‚‹ ğŸŠ",
                                          "uri": f"{base_url}/celebrate?m=mid"}, "style": "primary"}
        ]}
    }

def flex_final_summary(score, total, base_url):
    return {
        "type": "bubble",
        "size": "mega",
        "header": {"type": "box", "layout": "vertical", "contents": [
            {"type": "text", "text": "ğŸŠ å…¨å•çµ‚äº†ï¼", "weight": "bold", "size": "lg"}
        ]},
        "body": {"type": "box", "layout": "vertical", "contents": [
            {"type": "text", "text": f"æœ€çµ‚æˆç¸¾ï¼š{score}/{total}"},
            {"type": "text", "text": f"æ­£ç­”ç‡ï¼š{round(100*score/max(1,total))}%"},
            {"type": "separator", "margin": "md"},
            {"type": "text", "text": "ã€ãƒªã‚»ãƒƒãƒˆã€ã§æœ€åˆã‹ã‚‰å†æŒ‘æˆ¦ã§ãã¾ã™ã€‚", "wrap": True}
        ]},
        "footer": {"type": "box", "layout": "vertical", "spacing": "sm", "contents": [
            {"type": "button", "action": {"type": "uri", "label": "ç´™å¹é›ªã§ãŠç¥ã„ ğŸ‰",
                                          "uri": f"{base_url}/celebrate?m=final"}, "style": "primary"}
        ]}
    }

def make_question(s):
    if s["index"] >= TOTAL:
        return None
    q = questions[s["index"]]
    text = f"Q{s['index']+1}/{TOTAL}: {q['q']}\n"
    for i, c in enumerate(q["choices"], start=1):
        text += f"{i}. {c}\n"
    text += "ï¼ˆ1ï½4ã§å›ç­”ï¼‰"
    return text

# ---- Healthcheck ----
@app.get("/health")
def health():
    return {"status": "ok"}

# ---- Celebrate page (ç´™å¹é›ª) ----
# LINEå†…ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦ç´™å¹é›ªã‚¢ãƒ‹ãƒ¡ã‚’è¡¨ç¤º
@app.get("/celebrate")
def celebrate():
    html = """<!doctype html>
<html lang="ja"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ãŠã‚ã§ã¨ã†ï¼</title>
<style>
body{margin:0;font-family:sans-serif;background:#111;color:#fff;display:flex;align-items:center;justify-content:center;height:100vh;overflow:hidden}
.box{text-align:center}
h1{font-size:28px;margin:10px 0}
p{opacity:.85}
.btn{display:inline-block;margin-top:16px;padding:10px 16px;background:#06c167;color:#fff;border-radius:8px;text-decoration:none}
small{display:block;margin-top:12px;opacity:.7}
canvas{position:fixed;inset:0;pointer-events:none}
</style>
</head>
<body>
<canvas id="cnf"></canvas>
<div class="box">
  <h1>ğŸ‰ ãŠã‚ã§ã¨ã†ï¼ ğŸ‰</h1>
  <p>ãŒã‚“ã°ã‚Šã‚’ç§°ãˆã¦ç´™å¹é›ªã‚’ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆï¼</p>
  <a class="btn" href="line://msg/text/æ¬¡ã®å•é¡Œ">LINEã«æˆ»ã‚‹</a>
  <small>ãƒœã‚¿ãƒ³ã§æˆ»ã‚Œãªã„æ™‚ã¯ç”»é¢ã‚’é–‰ã˜ã¦ãã ã•ã„ã€‚</small>
</div>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
<script>
const duration = 4000;
const end = Date.now() + duration;
(function frame(){
  confetti({particleCount: 3, angle: 60, spread: 55, origin: {x: 0}});
  confetti({particleCount: 3, angle: 120, spread: 55, origin: {x: 1}});
  if (Date.now() < end) requestAnimationFrame(frame);
})();
</script>
</body></html>"""
    return Response(html, mimetype="text/html; charset=utf-8")

# ---- LINE Webhook ----
@app.route("/callback", methods=["POST"])
def callback():
    sig = request.headers.get("X-Line-Signature", "")
    body = request.get_data(as_text=True)
    try:
        handler.handle(body, sig)
    except InvalidSignatureError:
        abort(400)
    return "OK"

@handler.add(MessageEvent, message=TextMessage)
def on_message(event: MessageEvent):
    user_id = event.source.user_id
    s = sess(user_id)
    text = event.message.text.strip()

    # ãƒ™ãƒ¼ã‚¹URLï¼ˆFlexãƒœã‚¿ãƒ³ã®é·ç§»å…ˆã«ä½¿ã†ï¼‰
    # Renderãªã©ã¯ç’°å¢ƒå¤‰æ•°ã«å…¥ã‚Œã¦ãŠãã¨ç¢ºå®Ÿã€‚æœªè¨­å®šæ™‚ã¯æ¨æ¸¬ä¸å¯ãªã®ã§ç›¸å¯¾ã§OKã€‚
    base_url = os.getenv("PUBLIC_BASE_URL", "").rstrip("/")
    if not base_url:
        # æ—¢çŸ¥URLãŒãªã„å ´åˆã¯ Render ç­‰ã®å…¬é–‹URLã‚’ç›´æ¥å…¥ã‚Œã¦ãã ã•ã„ã€‚
        # ä¾‹: os.environ["PUBLIC_BASE_URL"]="https://xxxxx.onrender.com"
        base_url = ""

    # ---- ã‚³ãƒãƒ³ãƒ‰ ----
    if text == "ãƒªã‚»ãƒƒãƒˆ":
        sessions[user_id] = {"index": 0, "score": 0, "answered": 0}
        line_bot_api.reply_message(event.reply_token, TextSendMessage("ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚ã€æ¬¡ã®å•é¡Œã€ã§å†é–‹ã§ãã¾ã™ã€‚"))
        return

    if text == "æˆç¸¾ç¢ºèª":
        pct = round(100 * s["score"] / max(1, s["answered"]))
        line_bot_api.reply_message(event.reply_token,
            TextSendMessage(f"ç´¯ç©æˆç¸¾ï¼š{s['answered']}å•ä¸­ {s['score']}å•æ­£è§£ï¼ˆ{pct}%ï¼‰"))
        return

    if text == "æ¬¡ã®å•é¡Œ":
        qtext = make_question(s)
        if qtext:
            line_bot_api.reply_message(event.reply_token, TextSendMessage(qtext))
        else:
            # ã™ã§ã«å…¨å•çµ‚äº†
            flex = flex_final_summary(s["score"], TOTAL, base_url)
            line_bot_api.reply_message(event.reply_token,
                FlexSendMessage(alt_text="å…¨å•çµ‚äº†ï¼", contents=flex))
        return

    if text == "ãƒ˜ãƒ«ãƒ—":
        help_msg = ("ä½¿ã„æ–¹ï¼š\n"
                    "ãƒ»ã€æ¬¡ã®å•é¡Œã€ã§å‡ºé¡Œ\n"
                    "ãƒ»1ï½4 ã§å›ç­”\n"
                    "ãƒ»ã€æˆç¸¾ç¢ºèªã€ã§é€”ä¸­çµæœ\n"
                    "ãƒ»ã€ãƒªã‚»ãƒƒãƒˆã€ã§æœ€åˆã‹ã‚‰\n"
                    "â€»æ­£è§£/ä¸æ­£è§£ã®å¾Œã¯ã€ãƒªã‚»ãƒƒãƒˆã€ã€ãƒ˜ãƒ«ãƒ—ã€ã®ã¿ãŒå‡ºã¾ã™ã€‚")
        line_bot_api.reply_message(event.reply_token, TextSendMessage(help_msg))
        return

    # ---- å›ç­”ï¼ˆæ•°å­—ï¼‰----
    if text.isdigit():
        if s["index"] < TOTAL:
            q = questions[s["index"]]
            ans = int(text)
            s["answered"] += 1
            if ans == q["ans"]:
                s["score"] += 1
                feedback = "â­• æ­£è§£ï¼"
            else:
                feedback = ("âŒ ä¸æ­£è§£â€¦\n"
                            f"æ­£è§£ã¯ {q['ans']} : {q['choices'][q['ans']-1]}\n"
                            f"(è£œè¶³) {q['exp']}")

            # æ­£è§£/ä¸æ­£è§£ç›´å¾Œã¯ ãƒªã‚»ãƒƒãƒˆ ã¨ ãƒ˜ãƒ«ãƒ—ã®ã¿
            qr = QuickReply(items=[
                QuickReplyButton(action=MessageAction(label="ãƒªã‚»ãƒƒãƒˆ", text="ãƒªã‚»ãƒƒãƒˆ")),
                QuickReplyButton(action=MessageAction(label="ãƒ˜ãƒ«ãƒ—", text="ãƒ˜ãƒ«ãƒ—")),
            ])
            line_bot_api.reply_message(event.reply_token, TextSendMessage(feedback, quick_reply=qr))

            s["index"] += 1

            # 25å•ç·æ‹¬ï¼ˆæŠ¼ã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
            if s["index"] == 25:
                flex = flex_mid_summary(s["score"], s["answered"], base_url)
                line_bot_api.push_message(user_id, FlexSendMessage(alt_text="25å•ã‚¯ãƒªã‚¢ï¼", contents=flex))

            # 50å•ï¼ˆæœ€çµ‚ï¼‰ç·æ‹¬
            if s["index"] == TOTAL:
                flex = flex_final_summary(s["score"], TOTAL, base_url)
                line_bot_api.push_message(user_id, FlexSendMessage(alt_text="å…¨å•çµ‚äº†ï¼", contents=flex))
        return

if __name__ == "__main__":
    # Renderç­‰ã§ PORT ãŒä¸ãˆã‚‰ã‚Œã‚‹æƒ³å®š
    port = int(os.environ.get("PORT", 5000))
    app.run(host="0.0.0.0", port=port)
